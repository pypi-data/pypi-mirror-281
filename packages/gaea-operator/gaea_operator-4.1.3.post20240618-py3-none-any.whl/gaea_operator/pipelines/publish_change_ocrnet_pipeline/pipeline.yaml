cache:
  enable: false
  max_expired_time: -1
entry_points:
  eval:
    artifacts:
      input:
        input_model_uri: '{{train.output_model_uri}}'
      output:
      - output_dataset_uri
      - output_uri
    command: cd /root && package_path=$(python3 -c "import site; print(site.getsitepackages()[0])")
      && python3 -m gaea_operator.components.eval.ocrnet --input-model-uri={{input_model_uri}}
      --output-uri={{output_uri}} --output-dataset-uri={{output_dataset_uri}} $package_path/paddleseg/tools/val.py
      --config {{input_model_uri}}/train_config.yaml --model_path={{input_model_uri}}/best_model.pdparams
      --save_dir={{output_uri}}
    deps: train
    docker_env: iregistry.baidu-int.com/windmill-public/train/paddlepaddle:v4.1.3-dev17
    env:
      DATASET_NAME: '{{dataset_name}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      TRACKING_URI: '{{tracking_uri}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    parameters:
      dataset_name: ''
      experiment_kind: ''
      experiment_name: ''
      flavour: c8m32gpu1
      model_store_name: ''
      project_name: ''
      queue: qtrain
      scene: ''
      tracking_uri: ''
      windmill_ak: ''
      windmill_endpoint: ''
      windmill_sk: ''
    type: step
  inference:
    artifacts:
      input:
        input_dataset_uri: '{{eval.output_dataset_uri}}'
        input_model_uri: '{{package.output_model_uri}}'
      output:
      - output_uri
    command: python3 -m gaea_operator.components.inference.inference --input-model-uri={{input_model_uri}}
      --input-dataset-uri={{input_dataset_uri}} --output-uri={{output_uri}}
    deps: eval,package
    docker_env: iregistry.baidu-int.com/windmill-public/inference/nvidia:v4.1.3-dev18
    env:
      ACCELERATOR: '{{accelerator}}'
      ADVANCED_PARAMETERS: '{{advanced_parameters}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      LD_LIBRARY_PATH: /usr/local/cuda/compat/lib:/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/opt/tritonserver/lib
      PATH: /opt/tritonserver/bin:/usr/local/mpi/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ucx/bin
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      TRACKING_URI: '{{tracking_uri}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    parameters:
      accelerator: T4
      advanced_parameters: '{"conf_threshold":"0.5"}'
      experiment_kind: ''
      experiment_name: ''
      flavour: c4m16gpu1
      model_store_name: ''
      project_name: ''
      queue: qtrain
      scene: ''
      tracking_uri: ''
      windmill_ak: ''
      windmill_endpoint: ''
      windmill_sk: ''
    type: step
  package:
    artifacts:
      input:
        input_model_uri: '{{transform.output_model_uri}}'
      output:
      - output_model_uri
      - output_uri
    command: sleep 100000 && python3 -m gaea_operator.components.package.package --algorithm=ChangeOCRNet/Model
      --input-model-uri={{input_model_uri}} --output-uri={{output_uri}} --output-model-uri={{output_model_uri}}
    deps: transform,transform-eval
    docker_env: iregistry.baidu-int.com/windmill-public/inference/nvidia:v4.1.3-dev18
    env:
      ACCELERATOR: '{{accelerator}}'
      ENSEMBLE_MODEL_DISPLAY_NAME: '{{ensemble_model_display_name}}'
      ENSEMBLE_MODEL_NAME: '{{ensemble_model_name}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      SUB_MODEL_NAMES: '{{sub_model_names}}'
      TRACKING_URI: '{{tracking_uri}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    parameters:
      accelerator: T4
      ensemble_model_display_name: ''
      ensemble_model_name: ''
      experiment_kind: ''
      experiment_name: ''
      flavour: c4m16
      model_store_name: ''
      project_name: ''
      queue: qtrain
      scene: ''
      sub_model_names: ''
      tracking_uri: ''
      windmill_ak: ''
      windmill_endpoint: ''
      windmill_sk: ''
    type: step
  train:
    artifacts:
      output:
      - output_model_uri
      - output_uri
    command: cd /root && package_path=$(python3 -c "import site; print(site.getsitepackages()[0])")
      && python3 -m gaea_operator.components.train.change_ocrnet --output-model-uri={{output_model_uri}}
      --output-uri={{output_uri}} $package_path/paddleseg/tools/train.py --config
      {{output_model_uri}}/train_config.yaml --do_eval --save_dir={{output_model_uri}}
    docker_env: iregistry.baidu-int.com/windmill-public/train/paddlepaddle:v4.1.3-dev17
    env:
      ADVANCED_PARAMETERS: '{{advanced_parameters}}'
      BASE_TRAIN_DATASET_NAME: '{{base_train_dataset_name}}'
      BASE_VAL_DATASET_NAME: '{{base_val_dataset_name}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      MODEL_DISPLAY_NAME: '{{model_display_name}}'
      MODEL_NAME: '{{model_name}}'
      PF_EXTRA_WORK_DIR: /home/paddleflow/storage/mnt/fs-root-vistudio
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      TRACKING_URI: '{{tracking_uri}}'
      TRAIN_DATASET_NAME: '{{train_dataset_name}}'
      VAL_DATASET_NAME: '{{val_dataset_name}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    extra_fs:
    - mount_path: /home/paddleflow/storage/mnt/fs-root-vistudio
      name: vistudio
      read_only: false
    parameters:
      advanced_parameters: '{"iters":"100","lr_scheduler.learning_rate":"0.001","eval_height":"512","eval_width":"512","batch_size":"6","model_type":"ocrnet"}'
      base_train_dataset_name: ''
      base_val_dataset_name: ''
      experiment_kind: ''
      experiment_name: ''
      flavour: c8m32gpu1
      model_display_name: ''
      model_name: ''
      model_store_name: ''
      project_name: ''
      queue: qtrain
      scene: ''
      tracking_uri: ''
      train_dataset_name: ''
      val_dataset_name: ''
      windmill_ak: ''
      windmill_endpoint: ''
      windmill_sk: ''
    type: step
  transform:
    artifacts:
      input:
        input_model_uri: '{{train.output_model_uri}}'
      output:
      - output_model_uri
      - output_uri
    command: export ACCELERATOR=R200 && python3 -m gaea_operator.components.transform.change_ocrnet
      --input-model-uri={{input_model_uri}} --output-uri={{output_uri}} --output-model-uri={{output_model_uri}}
    deps: eval,train
    docker_env: iregistry.baidu-int.com/windmill-public/transform:v1.3.3-hotfix-20240618
    env:
      ACCELERATOR: '{{accelerator}}'
      ADVANCED_PARAMETERS: '{{advanced_parameters}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      TRACKING_URI: '{{tracking_uri}}'
      TRANSFORM_MODEL_DISPLAY_NAME: '{{transform_model_display_name}}'
      TRANSFORM_MODEL_NAME: '{{transform_model_name}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    parameters:
      accelerator: T4
      advanced_parameters: '{"max_batch_size":"1","precision":"fp16","eval_height":"512","eval_width":"512","source_framework":"paddle","model_type":"ocrnet"}'
      experiment_kind: ''
      experiment_name: ''
      flavour: c8m32gpu1
      model_store_name: ''
      project_name: ''
      queue: qtrain
      scene: ''
      tracking_uri: ''
      transform_model_display_name: ''
      transform_model_name: ''
      windmill_ak: ''
      windmill_endpoint: ''
      windmill_sk: ''
    type: step
  transform-eval:
    artifacts:
      input:
        input_dataset_uri: '{{eval.output_dataset_uri}}'
        input_model_uri: '{{transform.output_model_uri}}'
      output:
      - output_uri
    command: echo hello
    deps: eval,transform
    docker_env: iregistry.baidu-int.com/windmill-public/inference/nvidia:v4.1.3-dev18
    env:
      ACCELERATOR: '{{accelerator}}'
      ADVANCED_PARAMETERS: '{{advanced_parameters}}'
      EXPERIMENT_KIND: '{{experiment_kind}}'
      EXPERIMENT_NAME: '{{experiment_name}}'
      LD_LIBRARY_PATH: /usr/local/cuda/compat/lib:/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/opt/tritonserver/lib
      PATH: /opt/tritonserver/bin:/usr/local/mpi/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ucx/bin
      PF_JOB_FLAVOUR: '{{flavour}}'
      PF_JOB_QUEUE_NAME: '{{queue}}'
      PIPELINE_ROLE: windmill
      PROJECT_NAME: '{{project_name}}'
      SCENE: '{{scene}}'
      TRACKING_URI: '{{tracking_uri}}'
      WINDMILL_AK: '{{windmill_ak}}'
      WINDMILL_ENDPOINT: '{{windmill_endpoint}}'
      WINDMILL_SK: '{{windmill_sk}}'
    parameters:
      accelerator: T4
      advanced_parameters: '{"conf_threshold":"0.5","iou_threshold":"0.5"}'
      experiment_kind: ''
      experiment_name: ''
      flavour: c4m16gpu1
      model_store_name: ''
      project_name: ''
      queue: qtrain
      scene: ''
      tracking_uri: ''
      windmill_ak: ''
      windmill_endpoint: ''
      windmill_sk: ''
    type: step
name: change_ocrnet
