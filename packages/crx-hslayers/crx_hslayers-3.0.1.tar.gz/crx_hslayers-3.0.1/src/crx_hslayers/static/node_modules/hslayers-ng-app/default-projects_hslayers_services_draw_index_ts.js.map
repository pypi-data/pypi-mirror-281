{"version":3,"file":"default-projects_hslayers_services_draw_index_ts.js","mappings":"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","sources":["webpack:///default-projects_hslayers_services_draw_index_ts.js"],"sourcesContent":["\"use strict\";(self.webpackChunkhslayers_app=self.webpackChunkhslayers_app||[]).push([[\"default-projects_hslayers_services_draw_index_ts\"],{69968:(xe,N,n)=>{n.d(N,{B:()=>De});var D=n(10467),Y=n(57786),$=n(93207),B=n(35901),J=n(85493),X=n(28929),K=n(86832),Z=n(78864),k=n(3382),q=n(90549),V=n(7345),O=n(6401),_=n(14888);class te extends _.Ay{constructor(r,e){super(r),this.vertex=e.vertex,this.vertexPixel=e.vertexPixel,this.feature=e.feature,this.segment=e.segment}}var x=n(14378),C=n(31504),U=n(98695),A=n(87549),b=n(38618),E=n(37443);function j(g){return g.feature?g.feature:g.element?g.element:null}const P=[],re=class se extends k.A{constructor(r){const e=r=r||{};e.handleDownEvent||(e.handleDownEvent=O.rT),e.stopDown||(e.stopDown=O.W8),super(e),this.source_=r.source?r.source:null,this.vertex_=void 0===r.vertex||r.vertex,this.edge_=void 0===r.edge||r.edge,this.features_=r.features?r.features:null,this.featuresListenerKeys_=[],this.featureChangeListenerKeys_={},this.indexedFeaturesExtents_={},this.pendingFeatures_={},this.pixelTolerance_=void 0!==r.pixelTolerance?r.pixelTolerance:10,this.rBush_=new q.A,this.GEOMETRY_SEGMENTERS_={Point:this.segmentPointGeometry_.bind(this),LineString:this.segmentLineStringGeometry_.bind(this),LinearRing:this.segmentLineStringGeometry_.bind(this),Polygon:this.segmentPolygonGeometry_.bind(this),MultiPoint:this.segmentMultiPointGeometry_.bind(this),MultiLineString:this.segmentMultiLineStringGeometry_.bind(this),MultiPolygon:this.segmentMultiPolygonGeometry_.bind(this),GeometryCollection:this.segmentGeometryCollectionGeometry_.bind(this),Circle:this.segmentCircleGeometry_.bind(this)}}addFeature(r,e){e=void 0===e||e;const t=(0,b.v6)(r),s=r.getGeometry();if(s){const a=this.GEOMETRY_SEGMENTERS_[s.getType()];if(a){this.indexedFeaturesExtents_[t]=s.getExtent((0,x.createEmpty)());const o=[];if(a(o,s),1===o.length)this.rBush_.insert((0,x.boundingExtent)(o[0]),{feature:r,segment:o[0]});else if(o.length>1){const i=o.map(u=>(0,x.boundingExtent)(u)),l=o.map(u=>({feature:r,segment:u}));this.rBush_.load(i,l)}}}e&&(this.featureChangeListenerKeys_[t]=(0,E.KT)(r,Z.A.CHANGE,this.handleFeatureChange_,this))}getFeatures_(){let r;return this.features_?r=this.features_:this.source_&&(r=this.source_.getFeatures()),r}handleEvent(r){const e=this.snapTo(r.pixel,r.coordinate,r.map);return e&&(r.coordinate=e.vertex.slice(0,2),r.pixel=e.vertexPixel,this.dispatchEvent(new te(\"snap\",{vertex:r.coordinate,vertexPixel:r.pixel,feature:e.feature,segment:e.segment}))),super.handleEvent(r)}handleFeatureAdd_(r){const e=j(r);e&&this.addFeature(e)}handleFeatureRemove_(r){const e=j(r);e&&this.removeFeature(e)}handleFeatureChange_(r){const e=r.target;if(this.handlingDownUpSequence){const t=(0,b.v6)(e);t in this.pendingFeatures_||(this.pendingFeatures_[t]=e)}else this.updateFeature_(e)}handleUpEvent(r){const e=Object.values(this.pendingFeatures_);return e.length&&(e.forEach(this.updateFeature_.bind(this)),this.pendingFeatures_={}),!1}removeFeature(r,e){const t=void 0===e||e,s=(0,b.v6)(r),a=this.indexedFeaturesExtents_[s];if(a){const o=this.rBush_,i=[];o.forEachInExtent(a,function(l){r===l.feature&&i.push(l)});for(let l=i.length-1;l>=0;--l)o.remove(i[l])}t&&((0,E.JH)(this.featureChangeListenerKeys_[s]),delete this.featureChangeListenerKeys_[s])}setMap(r){const e=this.getMap(),t=this.featuresListenerKeys_,s=this.getFeatures_();e&&(t.forEach(E.JH),t.length=0,this.rBush_.clear(),Object.values(this.featureChangeListenerKeys_).forEach(E.JH),this.featureChangeListenerKeys_={}),super.setMap(r),r&&(this.features_?t.push((0,E.KT)(this.features_,K.A.ADD,this.handleFeatureAdd_,this),(0,E.KT)(this.features_,K.A.REMOVE,this.handleFeatureRemove_,this)):this.source_&&t.push((0,E.KT)(this.source_,V.A.ADDFEATURE,this.handleFeatureAdd_,this),(0,E.KT)(this.source_,V.A.REMOVEFEATURE,this.handleFeatureRemove_,this)),s.forEach(a=>this.addFeature(a)))}snapTo(r,e,t){const s=t.getView().getProjection(),a=(0,A.fromUserCoordinate)(e,s),o=(0,A.toUserExtent)((0,x.buffer)((0,x.boundingExtent)([a]),t.getView().getResolution()*this.pixelTolerance_),s),i=this.rBush_.getInExtent(o),l=i.length;if(0===l)return null;let u,v,d=1/0,M=null;const R=this.pixelTolerance_*this.pixelTolerance_,T=()=>{if(u){const m=t.getPixelFromCoordinate(u);if((0,C.hG)(r,m)<=R)return{vertex:u,vertexPixel:[Math.round(m[0]),Math.round(m[1])],feature:v,segment:M}}return null};if(this.vertex_){for(let p=0;p<l;++p){const L=i[p];\"Circle\"!==L.feature.getGeometry().getType()&&L.segment.forEach(S=>{const f=(0,A.fromUserCoordinate)(S,s),w=(0,C.hG)(a,f);w<d&&(u=S,d=w,v=L.feature)})}const m=T();if(m)return m}if(this.edge_){for(let p=0;p<l;++p){let L=null;const S=i[p];if(\"Circle\"===S.feature.getGeometry().getType()){let f=S.feature.getGeometry();const w=(0,A.getUserProjection)();w&&(f=f.clone().transform(w,s)),L=(0,C.hw)(a,f)}else{const[f,w]=S.segment;w&&(P[0]=(0,A.fromUserCoordinate)(f,s),P[1]=(0,A.fromUserCoordinate)(w,s),L=(0,C.sG)(a,P))}if(L){const f=(0,C.hG)(a,L);f<d&&(u=(0,A.toUserCoordinate)(L,s),M=\"Circle\"===S.feature.getGeometry().getType()?null:S.segment,d=f,v=S.feature)}}const m=T();if(m)return m}return null}updateFeature_(r){this.removeFeature(r,!1),this.addFeature(r,!1)}segmentCircleGeometry_(r,e){const t=this.getMap().getView().getProjection();let s=e;const a=(0,A.getUserProjection)();a&&(s=s.clone().transform(a,t));const o=(0,U.fromCircle)(s);a&&o.transform(t,a);const i=o.getCoordinates()[0];for(let l=0,u=i.length-1;l<u;++l)r.push(i.slice(l,l+2))}segmentGeometryCollectionGeometry_(r,e){const t=e.getGeometriesArray();for(let s=0;s<t.length;++s){const a=this.GEOMETRY_SEGMENTERS_[t[s].getType()];a&&a(r,t[s])}}segmentLineStringGeometry_(r,e){const t=e.getCoordinates();for(let s=0,a=t.length-1;s<a;++s)r.push(t.slice(s,s+2))}segmentMultiLineStringGeometry_(r,e){const t=e.getCoordinates();for(let s=0,a=t.length;s<a;++s){const o=t[s];for(let i=0,l=o.length-1;i<l;++i)r.push(o.slice(i,i+2))}}segmentMultiPointGeometry_(r,e){e.getCoordinates().forEach(t=>{r.push([t])})}segmentMultiPolygonGeometry_(r,e){const t=e.getCoordinates();for(let s=0,a=t.length;s<a;++s){const o=t[s];for(let i=0,l=o.length;i<l;++i){const u=o[i];for(let d=0,v=u.length-1;d<v;++d)r.push(u.slice(d,d+2))}}}segmentPointGeometry_(r,e){r.push([e.getCoordinates()])}segmentPolygonGeometry_(r,e){const t=e.getCoordinates();for(let s=0,a=t.length;s<a;++s){const o=t[s];for(let i=0,l=o.length-1;i<l;++i)r.push(o.slice(i,i+2))}}};var ie=n(21411),Q=n(47616),ae=n(76523),ne=n(73301),oe=n(65935),le=n(40804),he=n(4786),H=n(21413);class ce{constructor(){this.drawableLayers=[],this.drawableLaymanLayers=[],this.drawableLayersAvailable=!1,this.hasSomeDrawables=!1,this.moreThanOneDrawable=!1,this.boxSelectionActive=!1,this.snapActive=!1,this.drawActive=!1,this.selectedFeatures=new he.A,this.toggleSelectionString=\"selectAllFeatures\",this.highlightDrawButton=!1,this.onlyMine=!0,this.addedLayersRemoved=!1,this.eventHandlers=[],this.drawingLayerChanges=new H.B,this.layerMetadataDialog=new H.B,this.pendingLayers=[],this.requiredSymbolizer={Point:[\"Point\"],Polygon:[\"Fill\",\"Line\",\"Polygon\"],LineString:[\"Line\"],Circle:[\"Fill\",\"Line\",\"Polygon\"]}}}var I=n(5991),h=n(88716),c=n(93953),de=n(14608),W=n(27426),ue=n(22187),ye=n(24025),ge=n(93108),fe=n(38243),ve=n(40736),z=n(76253),me=n(25550),Le=n(91459),G=n(94928),Se=n(23916),pe=n(78373),we=n(9601);const F=\"tmpDrawLayer\";let De=(()=>{class g extends ce{constructor(e,t,s,a,o,i,l,u,d,v,M,R,T,m,p,L,S,f,w){super(),this.hsMapService=e,this.hsLayerUtilsService=t,this.hsEventBusService=s,this.hsLayoutService=a,this.hsDialogContainerService=o,this.hsLogService=i,this.hsConfig=l,this.hsQueryBaseService=u,this.hsQueryVectorService=d,this.hsLaymanService=v,this.hsLanguageService=M,this.hsLaymanBrowserService=R,this.hsAddDataVectorService=T,this.hsUtilsService=m,this.hsCommonLaymanService=p,this.hsToastService=L,this.hsAddDataOwsService=S,this.hsRemoveLayerDialogService=f,this.zone=w,this.keyUp=this.keyUp.bind(this),this.hsMapService.loaded().then(Ae=>{this.fillDrawableLayers(),this.hsMapService.getLayersArray().forEach(y=>y.on(\"change:visible\",Ee=>{this.draw&&y==this.selectedLayer&&this.setType(this.type),this.fillDrawableLayers()})),this.modify=new J.A({features:this.selectedFeatures}),Ae.addInteraction(this.modify),this.selectedFeatures.on(\"add\",y=>{this.onSelected&&this.onSelected(y)}),this.selectedFeatures.on(\"remove\",y=>{0==this.selectedFeatures.getLength()&&this.modify.setActive(!1)}),this.hsEventBusService.vectorQueryFeatureSelection.subscribe(y=>{this.selectedFeatures.push(y.feature),(0,h.M8)(y.selector.getLayer(y.feature)).editable&&this.modify.setActive(!0)}),this.hsEventBusService.vectorQueryFeatureDeselection.subscribe(({feature:y})=>{this.selectedFeatures.remove(y)}),this.hsLaymanService.laymanLayerPending.subscribe(y=>{this.pendingLayers=y}),(0,Y.h)(this.hsEventBusService.addedLayersRemoved,this.hsEventBusService.mapResets).subscribe(()=>{this.addedLayersRemoved=!0,this.fillDrawableLayers()}),this.hsLayoutService.mainpanel$.subscribe(y=>{\"draw\"===y&&this.hsMapService.getMap()&&this.fillDrawableLayers()}),this.hsCommonLaymanService.authChange.subscribe(y=>{this.fillDrawableLayers(),this.isAuthenticated=y?.authenticated,this.selectedLayer&&this.tmpDrawLayer&&((0,h.o3)(this.selectedLayer,y?.user),(0,h.YK)(this.selectedLayer,{format:this.isAuthenticated?\"WFS\":null,url:this.isAuthenticated?this.hsCommonLaymanService.layman?.url+\"/wfs\":null}))})})}selectedLayerString(){if(this.selectedLayer){const e=(0,h.LK)(this.selectedLayer);return e==F?this.translate(\"DRAW.unsavedDrawing\"):this.hsLanguageService.getTranslationIgnoreNonExisting(\"LAYERS\",e,void 0)||(0,h.mG)(this.selectedLayer)}return this.translate(\"DRAW.Select layer\")}snapLayerString(){if(this.snapLayer){const e=(0,h.LK)(this.snapLayer);return this.hsLanguageService.getTranslationIgnoreNonExisting(\"LAYERS\",e,void 0)||(0,h.mG)(this.snapLayer)}}saveDrawingLayer(){this.selectedLayer&&(this.previouslySelected=this.selectedLayer);let e=this.translate(\"DRAW.drawLayer\");const t=this.hsMapService.findLayerByTitle(F),s=t?t.getSource():new B.A;let a=1;for(;this.hsMapService.findLayerByTitle(e);)e=`${this.translate(\"DRAW.drawLayer\")} ${a++}`;const o=this.hsCommonLaymanService.layman,i=new Q.A({source:s,visible:!0});(0,h.D6)(i,e),(0,h.t0)(i,!0),(0,h.Gu)(i,!0),(0,h.QH)(i,I.lv),(0,h.ad)(i,{editable:!0}),(0,h.SO)(i,this.hsConfig.defaultDrawLayerPath||\"User generated\"),(0,h.YK)(i,{format:this.isAuthenticated?\"WFS\":null,url:this.isAuthenticated?o.url+\"/wfs\":null}),(0,h.o3)(i,o?.user),this.tmpDrawLayer=!0,this.selectedLayer=i,this.layerMetadataDialog.next()}setType(e){if(this.type==e){this.type=null,this.deactivateDrawing();const t=this.hsMapService.findLayerByTitle(F)||null;return t&&(this.hsMapService.getMap().removeLayer(t),this.tmpDrawLayer=!1),this.hsQueryBaseService.activateQueries(),!1}if(0==this.drawableLayers.length&&!this.tmpDrawLayer){const t=new Q.A({source:new B.A,visible:!0});(0,h.QH)(t,I.lv),(0,h.D6)(t,F),(0,h.t0)(t,!1),(0,h.Gu)(t,!0),(0,h.ad)(t,{editable:!0}),(0,h.SO)(t,this.hsConfig.defaultDrawLayerPath||\"User generated\"),this.tmpDrawLayer=!0,this.selectedLayer=t,this.addDrawLayer(t)}return this.type=e,this.selectedLayer&&(this.source=this.hsLayerUtilsService.isLayerClustered(this.selectedLayer)?this.selectedLayer.getSource().getSource():this.selectedLayer.getSource()),!0}selectLayer(e){var t=this;return(0,D.A)(function*(){let s,a;if(e instanceof ae.A||(s=yield t.hsLaymanBrowserService.fillLayerMetadata(t.laymanEndpoint,e)),s){if(!s?.type?.includes(\"WFS\"))return void(\"yes\"==(yield t.hsDialogContainerService.create(le.d,{message:\"DRAW.thisLayerDoesNotSupportDrawing\",title:\"DRAW.notAVectorLayer\"}).waitResult())&&(yield t.hsAddDataOwsService.connectToOWS({type:\"wms\",uri:decodeURIComponent(s.wms.url),layer:e.name}),t.selectedLayer=null,t.fillDrawableLayers()));s.style?.url&&(a=yield t.hsCommonLaymanService.getStyleFromUrl(s.style?.url)),\"sld\"==s.style?.type&&(a?.includes(\"StyledLayerDescriptor\")||(a=void 0)),\"qml\"==s.style?.type&&(a?.includes(\"<qgis\")||(a=void 0))}let o=e;e.workspace&&(o=yield t.hsAddDataVectorService.addVectorLayer(\"wfs\",t.laymanEndpoint.url,e.name,e.title,void 0,\"EPSG:4326\",{workspace:e.workspace,saveToLayman:!0,style:a}),o=t.hsMapService.findLayerByTitle(e.title)),o!=t.selectedLayer&&(t.selectedLayer&&(0,h.LK)(t.selectedLayer)==F&&(t.tmpDrawLayer=!1,t.hsMapService.getMap().removeLayer(t.selectedLayer)),t.selectedLayer=o,t.changeDrawSource()),t.fillDrawableLayers()})()}addDrawLayer(e){this.hsMapService.getMap().addLayer(e),this.fillDrawableLayers()}updateStyle(e){this.draw&&(this.currentStyle=e(),this.draw.getOverlay().setStyle(this.currentStyle))}onDrawEnd(e){if(!(0,h.M8)(this.selectedLayer))return;const t=(0,h.M8)(this.selectedLayer);if(t.defaultAttributes)for(const s in t.defaultAttributes)e.feature.set(s,t.defaultAttributes[s]);\"draw\"!=this.hsLayoutService.mainpanel&&this.hsConfig.openQueryPanelOnDrawEnd&&this.hsLayoutService.setMainPanel(\"query\"),setTimeout(()=>{this.addFeatureToSelector(e.feature)})}addFeatureToSelector(e){this.zone.run(()=>{this.hsQueryBaseService.clear(\"features\"),this.hsQueryVectorService.selector.getFeatures().push(e),this.hsQueryVectorService.createFeatureAttributeList()})}afterDrawEnd(){this.draw&&this.draw.setActive(!1),this.drawActive=!1}removeLastPoint(){this.draw.removeLastPoint()}changeDrawSource(){void 0!==this.selectedLayer.getSource&&(this.source=this.hsLayerUtilsService.isLayerClustered(this.selectedLayer)?this.selectedLayer.getSource().getSource():this.selectedLayer.getSource(),this.drawingLayerChanges.next({layer:this.selectedLayer,source:this.source}),this.draw&&(this.activateDrawing({drawState:!0}),this.snapLayer=this.selectedLayer,this.toggleSnapping(this.source)))}deactivateDrawing(){var e=this;return(0,D.A)(function*(){const t=yield e.hsMapService.loaded();if(e.afterDrawEnd(),e.draw){for(const s of e.eventHandlers)(0,oe.e)(s);t.removeInteraction(e.draw),e.draw=null}})()}stopDrawing(){if(this.draw&&null!==this.draw){try{this.draw.getActive()&&this.draw.finishDrawing()}catch(e){this.hsLogService.warn(e)}this.draw.setActive(!1),this.modify.setActive(!1),this.hsQueryBaseService.activateQueries(),this.type=null,this.drawActive=!1}}startDrawing(){const e=this.draw;try{e.getActive()&&e.finishDrawing()}catch(t){this.hsLogService.warn(t)}e.setActive(!0)}fillDrawableLayers(){var e=this;return(0,D.A)(function*(){yield e.hsMapService.loaded();const t=e.hsMapService.getLayersArray().filter(s=>e.hsLayerUtilsService.isLayerDrawable(s));0!=t.length||e.tmpDrawLayer?t.length>0&&e.selectedLayerNotAvailable(t)&&(e.selectedLayer=t[0],e.changeDrawSource()):(e.type=null,e.deactivateDrawing(),e.selectedLayer=null,e.snapSource=null),e.addedLayersRemoved=!1,e.drawableLayers=t,e.laymanEndpoint=e.hsCommonLaymanService.layman,e.laymanEndpoint&&(yield(0,$.s)(e.hsLaymanBrowserService.queryCatalog(e.laymanEndpoint,{onlyMine:e.onlyMine,limit:\"\",query:{}})),e.laymanEndpoint.layers&&(e.drawableLaymanLayers=e.laymanEndpoint.layers.filter(s=>!e.hsMapService.findLayerByTitle(s.title)&&s.editable))),e.drawableLayersAvailable=e.drawableLayers.length>0||e.drawableLaymanLayers.length>0,e.hasSomeDrawables=e.drawableLayers.length>0,e.moreThanOneDrawable=e.drawableLayers?.length>1})()}selectedLayerNotAvailable(e){return!!this.addedLayersRemoved||!this.tmpDrawLayer&&!e.some(t=>this.selectedLayer&&(0,h.LK)(t)==(0,h.LK)(this.selectedLayer))||!this.selectedLayer}keyUp(e){\"Backspace\"==e.key&&this.removeLastPoint()}rightClickCondition(e,t){const s=this.hsConfig.preserveLastSketchPoint?1:0;return t>=e-s&&(setTimeout(()=>{0==s&&this.removeLastPoint(),this.draw.finishDrawing()},250),!0)}activateDrawing({onDrawStart:e,onDrawEnd:t=(i=>this.onDrawEnd(i)),onSelected:s,onDeselected:a,drawState:o=!0}){var i=this;return(0,D.A)(function*(){i.onDeselected=a,i.onSelected=s,yield i.deactivateDrawing(),i.hsQueryBaseService.deactivateQueries();const l=new X.Ay({source:i.source,type:i.type,condition:d=>{if(1===d.originalEvent.buttons)return!0;if(2===d.originalEvent.buttons){if(\"Polygon\"==i.type){const v=i.draw.sketchLineCoords_?.length;return i.rightClickCondition(4,v)}if(\"LineString\"==i.type){const v=i.draw.sketchCoords_?.length;return i.rightClickCondition(2,v-1)}}}});i.setInteraction(l),i.draw.setActive(o),i.addHandler(l.on(\"drawstart\",d=>{i.checkForMatchingSymbolizer(),e&&e(d)})),i.addHandler(l.on(\"drawend\",d=>{\"Circle\"==i.type&&d.feature.setGeometry((0,U.fromCircle)(d.feature.getGeometry())),t&&t(d)})),i.toggleSnapping(i.snapSource?i.snapSource:i.source)})()}addHandler(e){this.eventHandlers.push(e)}setInteraction(e){var t=this;return(0,D.A)(function*(){t.draw=e,(yield t.hsMapService.loaded()).addInteraction(e),t.addHandler(e.on(\"drawstart\",a=>{t.hsUtilsService.runningInBrowser()&&document.addEventListener(\"keyup\",t.keyUp.bind(t,a))})),t.addHandler(e.on(\"drawstart\",()=>{t.drawActive=!0,t.modify.setActive(!1)})),t.addHandler(e.on(\"drawend\",a=>{t.hsUtilsService.runningInBrowser()&&document.removeEventListener(\"keyup\",t.keyUp.bind(t,a))}))})()}translate(e,t){return this.hsLanguageService.getTranslation(e,t)}checkForMatchingSymbolizer(){if(!this.hasRequiredSymbolizer()){const e=this.translate(\"DRAW.stylingMissing\"),t=this.translate(\"PANEL_HEADER.LM\"),s=this.translate(\"DRAW.stylingMissingWarning\",{type:this.type,symbolizer:this.requiredSymbolizer[this.type].join(\" or \"),panel:t});this.hsToastService.createToastPopupMessage(e,`${s}`,{serviceCalledFrom:\"HsDrawService\"})}}hasRequiredSymbolizer(){const e=(0,h.WM)(this.selectedLayer);return this.requiredSymbolizer[this.type].some(t=>e.includes(`${t}Symbolizer`))}toggleSnapping(e){this.hsMapService.loaded().then(t=>{this.snapSource=e||this.snapSource,this.snap&&t.removeInteraction(this.snap),this.snapActive&&this.snapSource&&(this.snap=new re({source:this.snapSource}),t.addInteraction(this.snap))})}changeSnapSource(e){const t=this.hsLayerUtilsService.isLayerClustered(e)?e.getSource().getSource():e.getSource();this.snapLayer=e,this.toggleSnapping(t)}selectAllFeatures(){const e=this.selectedFeatures.getLength()!=this.selectedLayer.getSource().getFeatures().length;this.toggleSelectionString=e?\"deselectAllFeatures\":\"selectAllFeatures\",this.hsQueryBaseService.clear(\"features\"),this.hsQueryBaseService.selector.getFeatures().clear(),e&&this.hsQueryBaseService.selector.getFeatures().extend(this.selectedLayer.getSource().getFeatures()),this.hsQueryVectorService.createFeatureAttributeList()}toggleBoxSelection(){this.hsMapService.loaded().then(e=>{this.boxSelection&&e.removeInteraction(this.boxSelection),this.boxSelectionActive&&(this.boxSelection=new ie.A({condition:ne.k5}),e.addInteraction(this.boxSelection),this.boxSelection.on(\"boxend\",()=>{if(!this.selectedLayer)return;this.hsQueryBaseService.clear(\"features\");const t=this.boxSelection.getGeometry().getExtent();this.selectedLayer.getSource().forEachFeatureIntersectingExtent(t,s=>{this.hsQueryBaseService.selector.getFeatures().push(s)}),this.hsQueryVectorService.createFeatureAttributeList()}),this.boxSelection.on(\"boxstart\",()=>{this.hsQueryBaseService.selector.getFeatures().clear()}),this.hsToastService.createToastPopupMessage(this.translate(\"DRAW.boxSelectionActivated\"),`${this.translate(\"DRAW.useModifierToSelectWithBox\",{platformModifierKey:\"CTRL/META\"})}`,{toastStyleClasses:\"bg-info text-white\",serviceCalledFrom:\"HsDrawService\"}))})}removeLayer(){var e=this;return(0,D.A)(function*(){yield e.layerRemoval(!1)})()}removeMultipleLayers(){var e=this;return(0,D.A)(function*(){yield e.layerRemoval(!0)})()}layerRemoval(e=!1){var t=this;return(0,D.A)(function*(){let s;const a=t.hsCommonLaymanService.layman?.authenticated?[\"map\",\"mapcatalogue\"]:[\"map\"];s=e?yield t.hsRemoveLayerDialogService.removeMultipleLayers(t.drawableLayers,a):yield t.hsRemoveLayerDialogService.removeLayer(t.selectedLayer,a),s&&(t.selectedLayer=null,t.fillDrawableLayers())})()}static#e=this.\\u0275fac=function(t){return new(t||g)(c.KVO(de.F),c.KVO(W.Xp),c.KVO(ue.z),c.KVO(ye.F),c.KVO(ge.oE),c.KVO(fe.r),c.KVO(ve.Q),c.KVO(z.o),c.KVO(z.Y),c.KVO(me.fr),c.KVO(Le.LJ),c.KVO(G.xG),c.KVO(G.fm),c.KVO(W.MJ),c.KVO(Se.wC),c.KVO(pe.ST),c.KVO(G.Dn),c.KVO(we.Os),c.KVO(c.SKi))};static#t=this.\\u0275prov=c.jDH({token:g,factory:g.\\u0275fac,providedIn:\"root\"})}return g})()}}]);"],"names":[],"sourceRoot":""}