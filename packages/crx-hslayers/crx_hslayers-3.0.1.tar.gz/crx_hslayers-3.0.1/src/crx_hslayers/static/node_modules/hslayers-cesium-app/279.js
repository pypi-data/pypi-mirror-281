"use strict";(self.webpackChunkhslayers_cesium_app=self.webpackChunkhslayers_cesium_app||[]).push([[279],{48279:(Pe,I,s)=>{s.r(I),s.d(I,{HsTripPlannerComponent:()=>Se,HsTripPlannerLayerSelectorComponent:()=>G,HsTripPlannerModule:()=>Te,HsTripPlannerProfileSelectorComponent:()=>U,HsTripPlannerService:()=>T,getWaypoint:()=>b,profiles:()=>R,setWaypoint:()=>oe});var e=s(7404),m=s(89204),V=s(5342),O=s(72354),Y=s(61318),X=s(59452),k=s(16613),J=s(94691),B=s(77662),K=s(36758),Z=(s(29814),s(18194),s(1963),s(57690),s(2844),s(66586)),q=s(49964),E=s(53848),M=s(60411),N=s(45363);const R=["driving-car","driving-hgv","cycling-regular","cycling-road","cycling-mountain","cycling-electric","foot-walking","foot-hiking","wheelchair"];var y=s(88716),j=s(14608),g=s(27426),ee=s(46443),te=s(64801),ne=s(22187),re=s(78373),A=s(91459),ie=s(24025),$=s(40736);const W="wp";function oe(i,l){i.set(W,l)}function b(i){return i.get(W)}let T=(()=>{class i{constructor(t,n,r,o,a,c,D,u,f,v){this.HsMapService=t,this.HsUtilsService=n,this.$http=r,this.HsShareUrlService=o,this.HsEventBusService=a,this.HsToastService=c,this.HsLanguageService=D,this.HsLayerUtilsService=u,this.HsLayoutService=f,this.hsConfig=v,this.waypoints=[],this.trip={},this.orsProfiles=R,this.movable_features=new k.A,this.selectedLayerWrapper={},this.selectedProfile=R[0],this.modify=new B.A({features:this.movable_features}),this.HsEventBusService.mapClicked.subscribe(({coordinates:h})=>{"tripPlanner"==this.HsLayoutService.mainpanel&&(this.waypointLayer||this.createWaypointLayer(),this.routeLayer||this.createRouteLayer(),!this.HsMapService.getMap().getInteractions().getArray().find(S=>S.getActive()&&this.HsUtilsService.instOf(S,K.Ay))&&this.addWaypoint({x:h.mapProjCoordinate[0],y:h.mapProjCoordinate[1],lon:h.epsg4326Coordinate[0],lat:h.epsg4326Coordinate[1]}))}),this.HsMapService.loaded().then(h=>{h.addInteraction(this.modify),this.fillVectorLayers()})}fillVectorLayers(){var t=this;return(0,m.A)(function*(){t.HsMapService.loaded().then(n=>{t.vectorLayers=[{layer:null,title:"newLayer"},...t.HsMapService.getLayersArray().filter(r=>t.HsLayerUtilsService.isLayerDrawable(r)).map(r=>({layer:r,title:(0,y.LK)(r)}))],t.fillDefaultLayerWrapper("route"),t.fillDefaultLayerWrapper("waypoints")})})()}fillDefaultLayerWrapper(t){this.selectedLayerWrapper[t]=this.selectedLayerWrapper[t]?this.vectorLayers.find(n=>n.layer==this.selectedLayerWrapper[t].layer):this.vectorLayers[0]}createWaypointLayer(){this.waypointSource=new M.A,this.waypointLayer=new E.A({source:this.waypointSource,style:this.waypointRouteStyle}),(0,y.D6)(this.waypointLayer,this.HsLanguageService.getTranslation("TRIP_PLANNER.waypoints",void 0)),this.HsMapService.getMap().addLayer(this.waypointLayer)}createRouteLayer(){this.routeSource=new M.A,this.routeLayer=new E.A({source:this.routeSource,style:this.waypointRouteStyle}),(0,y.D6)(this.routeLayer,this.HsLanguageService.getTranslation("TRIP_PLANNER.travelRoute",void 0)),this.HsMapService.getMap().addLayer(this.routeLayer)}selectLayer(t,n){var r=this;return(0,m.A)(function*(){if("route"==n&&(r.routeLayer=t.layer,r.routeLayer&&(r.routeSource=r.routeLayer.getSource()),r.selectedLayerWrapper.route=t),"waypoints"==n){r.waypointLayer=t.layer,r.waypointLayer&&(r.waypointSource=r.waypointLayer.getSource()),r.routeSource.clear(),r.waypoints.length=0,r.selectedLayerWrapper.waypoints=t;for(const o of r.waypointSource.getFeatures()){const a=(0,N.transform)(o.getGeometry().getCoordinates(),r.HsMapService.getCurrentProj().getCode(),"EPSG:4326"),c={lon:a[0],lat:a[1],name:"Waypoint "+(r.waypoints.length+1),hash:r.HsUtilsService.hashCode(JSON.stringify("Waypoint "+r.waypoints.length+Math.random())),routes:{from:null,to:null},featureId:o.getId(),loading:!1};r.waypoints.push(c),void 0!==r.waypointAdded&&r.waypointAdded(c),yield r.calculateRoutes()}}})()}selectProfile(t){var n=this;return(0,m.A)(function*(){n.selectedProfile=t;for(const r of n.waypoints)n.removeRoutesForWaypoint(r);yield n.calculateRoutes()})()}getTextOnFeature(t){let n="";const r=b(t);return r&&(n=r.name,r?.routes?.to&&(n+=` (${this.formatDistance(r,"to")})`)),n}addWaypoint({x:t,y:n,lon:r,lat:o}){const a={lon:r,lat:o,name:"Waypoint "+(this.waypoints.length+1),hash:this.HsUtilsService.hashCode(JSON.stringify("Waypoint "+this.waypoints.length+Math.random())),routes:{from:null,to:null},featureId:null,loading:!1},c=new J.default({wp:a,geometry:new q.default([t,n]),id:this.HsUtilsService.generateUuid()});c.setId(c.get("id")),a.featureId=c.getId(),this.waypointSource.addFeature(c),this.waypoints.push(a),void 0!==this.waypointAdded&&this.waypointAdded(a),this.calculateRoutes()}waypointAdded(t){const n=this.waypointSource.getFeatureById(t.featureId);this.movable_features.push(n),n.getGeometry().on("change",r=>{this.removeRoutesForWaypoint(t);const o=(0,N.transform)(n.getGeometry().getCoordinates(),this.HsMapService.getCurrentProj().getCode(),"EPSG:4326");t.lon=o[0],t.lat=o[1];const a=this.waypoints.indexOf(t)-1;a>-1&&(this.waypoints[a].routes.from=null,this.routeRemoved(this.waypoints[a].routes.from)),null!==this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.calculateRoutes()},500)})}routeRemoved(t){try{t&&this.routeSource.removeFeature(t)}catch(n){throw n}}removeRoutesForWaypoint(t){this.routeRemoved(t.routes.from),this.routeRemoved(t.routes.to),t.routes={from:null,to:null}}waypointRemoved(t){try{this.waypointSource.removeFeature(this.waypointSource.getFeatureById(t.featureId))}catch(n){throw n}}removeWaypoint(t){const n=this.waypoints.indexOf(t),r=n-1;r>-1&&(this.waypoints[r].routes.from=null),this.routeRemoved(t.routes.from),this.routeRemoved(t.routes.to);const o=n+1;o<this.waypoints.length&&(this.waypoints[o].routes.to=null),this.waypointRemoved(t),this.waypoints.splice(this.waypoints.indexOf(t),1),this.calculateRoutes()}clearAll(){this.waypoints=[],this.waypointSource.clear(),this.routeSource.clear()}routeAdded(t){this.routeSource.addFeatures(t)}calculateRoutes(){var t=this;return(0,m.A)(function*(){for(let n=0;n<t.waypoints.length-1;n++){const r=t.waypoints[n];if(null===r.routes.from){const o=t.waypoints[n+1];o.loading=!0;const a=t.HsUtilsService.proxify(`https://api.openrouteservice.org/v2/directions/${t.selectedProfile}/geojson`),c=yield(0,V.s)(t.$http.post(a,{coordinates:[[r.lon,r.lat],[o.lon,o.lat]]}).pipe((0,O.w)(1e4),(0,Y.W)(f=>{let v=t.HsLanguageService.getTranslation("TRIP_PLANNER.serviceDown",void 0);return 404==f.status&&(v=t.HsLanguageService.getTranslation(2010==f.error?.error?.code?"TRIP_PLANNER.noRoutablePoint":"TRIP_PLANNER.missingAuth",void 0)),t.HsToastService.createToastPopupMessage(v,t.HsLanguageService.getTranslationIgnoreNonExisting("ERRORMESSAGES",f.error?.error?.message??f.message,{url:a}),{disableLocalization:!0,serviceCalledFrom:"HsTripPlannerService"}),(0,X.of)(null)})));if(!c)return;o.loading=!1;const u=(new Z.default).readFeatures(c);u[0].getGeometry().transform("EPSG:4326",t.HsMapService.getCurrentProj()),r.routes.from=u[0],o.routes.to=u[0],void 0!==t.routeAdded&&t.routeAdded(u)}}})()}formatDistance(t,n){if(t.routes[n=void 0!==n?n:"from"]){const o=t.routes[n]?.get("summary").distance/1e3;return null==o?"":o.toFixed(2)+"km"}}static#e=this.\u0275fac=function(n){return new(n||i)(e.KVO(j.F),e.KVO(g.MJ),e.KVO(ee.Qq),e.KVO(te.JX),e.KVO(ne.z),e.KVO(re.ST),e.KVO(A.LJ),e.KVO(g.Xp),e.KVO(ie.F),e.KVO($.Q))};static#t=this.\u0275prov=e.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var p=s(60316),d=s(56485),L=s(31968);const se=i=>({show:i}),w=()=>({module:"LAYERS"});function ae(i,l){if(1&i&&(e.j41(0,"div",8),e.EFF(1),e.nI1(2,"translateHs"),e.k0s()),2&i){const t=e.XpG();e.R7$(),e.SpI(" ",e.i5U(2,1,t.selectedWrapper.title,e.lJ4(4,w))," ")}}function le(i,l){if(1&i){const t=e.RV6();e.j41(0,"a",9),e.nI1(1,"translateHs"),e.bIt("click",function(){const r=e.eBV(t).$implicit,o=e.XpG();return o.HsTripPlannerService.selectLayer(r,o.usage),e.Njj(o.layersExpanded=!1)}),e.EFF(2),e.nI1(3,"translateHs"),e.k0s()}if(2&i){const t=l.$implicit;e.Y8G("title",e.i5U(1,2,t.title,e.lJ4(8,w))),e.R7$(2),e.JRh(e.i5U(3,5,t.title,e.lJ4(9,w)))}}let G=(()=>{class i{constructor(t,n){this.HsTripPlannerService=t,this.HsLayerUtilsService=n}static#e=this.\u0275fac=function(n){return new(n||i)(e.rXU(T),e.rXU(g.Xp))};static#t=this.\u0275cmp=e.VBU({type:i,selectors:[["hs-trip-planner-layer-selector"]],inputs:{label:"label",usage:"usage",selectedWrapper:"selectedWrapper"},decls:9,vars:7,consts:[[1,"flex-row","w-100","m-auto","justify-content-center","align-items-center",2,"display","flex"],[1,"m-0","p-0","flex-fill","text-primary"],["ngbDropdown","","placement","bottom",2,"max-width","50%"],["type","button","ngbDropdownToggle","","aria-haspopup","true",1,"btn","btn-sm","rounded-0","hs-toolbar-button","d-flex","align-items-center","mw-100",3,"click"],["class","text-truncate",4,"ngIf"],["ngbDropdownMenu","",2,"transform","translateX(25%)","width","15em",3,"ngClass"],[1,"d-flex","align-items-center","w-100","flex-column"],["class","dropdown-item text-truncate","data-toggle","tooltip",3,"title","click",4,"ngFor","ngForOf"],[1,"text-truncate"],["data-toggle","tooltip",1,"dropdown-item","text-truncate",3,"click","title"]],template:function(n,r){1&n&&(e.j41(0,"div",0)(1,"p",1),e.EFF(2),e.k0s(),e.j41(3,"div",2)(4,"button",3),e.bIt("click",function(){return r.layersExpanded=!r.layersExpanded,r.HsTripPlannerService.fillVectorLayers()}),e.DNE(5,ae,3,5,"div",4),e.k0s(),e.j41(6,"div",5)(7,"div",6),e.DNE(8,le,4,10,"a",7),e.k0s()()()()),2&n&&(e.R7$(2),e.SpI("",r.label,":"),e.R7$(2),e.BMQ("aria-expanded",r.layersExpanded),e.R7$(),e.Y8G("ngIf",void 0!==r.selectedWrapper),e.R7$(),e.Y8G("ngClass",e.eq3(5,se,r.layersExpanded)),e.R7$(2),e.Y8G("ngForOf",r.HsTripPlannerService.vectorLayers))},dependencies:[p.YU,p.Sq,p.bT,d.tg,d.do,d.U0,L.q],encapsulation:2})}return i})();const ce=i=>({show:i}),H=()=>({module:"TRIP_PLANNER.profiles"});function pe(i,l){if(1&i&&(e.j41(0,"div",8),e.EFF(1),e.nI1(2,"translateHs"),e.k0s()),2&i){const t=e.XpG();e.R7$(),e.SpI(" ",e.i5U(2,1,t.selectedProfile,e.lJ4(4,H))," ")}}function de(i,l){if(1&i){const t=e.RV6();e.j41(0,"a",9),e.nI1(1,"translateHs"),e.bIt("click",function(){const r=e.eBV(t).$implicit,o=e.XpG();return o.hsTripPlannerService.selectProfile(r),e.Njj(o.profilesExpanded=!1)}),e.EFF(2),e.nI1(3,"translateHs"),e.k0s()}if(2&i){const t=l.$implicit;e.Y8G("title",e.i5U(1,2,t,e.lJ4(8,H))),e.R7$(2),e.JRh(e.i5U(3,5,t,e.lJ4(9,H)))}}let U=(()=>{class i{constructor(t){this.hsTripPlannerService=t}static#e=this.\u0275fac=function(n){return new(n||i)(e.rXU(T))};static#t=this.\u0275cmp=e.VBU({type:i,selectors:[["hs-trip-planner-profile-selector"]],inputs:{selectedProfile:"selectedProfile"},decls:10,vars:9,consts:[[1,"flex-row","w-100","m-auto","justify-content-center","align-items-center",2,"display","flex"],[1,"m-0","p-0","flex-fill","text-primary"],["ngbDropdown","","placement","bottom",2,"max-width","50%"],["type","button","ngbDropdownToggle","","aria-haspopup","true",1,"btn","btn-sm","rounded-0","hs-toolbar-button","d-flex","align-items-center","mw-100",3,"click"],["class","text-truncate",4,"ngIf"],["ngbDropdownMenu","",2,"transform","translateX(25%)","width","15em",3,"ngClass"],[1,"d-flex","align-items-center","w-100","flex-column"],["class","dropdown-item text-truncate","data-toggle","tooltip",3,"title","click",4,"ngFor","ngForOf"],[1,"text-truncate"],["data-toggle","tooltip",1,"dropdown-item","text-truncate",3,"click","title"]],template:function(n,r){1&n&&(e.j41(0,"div",0)(1,"p",1),e.EFF(2),e.nI1(3,"translateHs"),e.k0s(),e.j41(4,"div",2)(5,"button",3),e.bIt("click",function(){return r.profilesExpanded=!r.profilesExpanded}),e.DNE(6,pe,3,5,"div",4),e.k0s(),e.j41(7,"div",5)(8,"div",6),e.DNE(9,de,4,10,"a",7),e.k0s()()()()),2&n&&(e.R7$(2),e.SpI("",e.bMT(3,5,"TRIP_PLANNER.selectProfile"),":"),e.R7$(3),e.BMQ("aria-expanded",r.profilesExpanded),e.R7$(),e.Y8G("ngIf",void 0!==r.selectedProfile),e.R7$(),e.Y8G("ngClass",e.eq3(7,ce,r.profilesExpanded)),e.R7$(2),e.Y8G("ngForOf",r.hsTripPlannerService.orsProfiles))},dependencies:[p.YU,p.Sq,p.bT,d.tg,d.do,d.U0,L.q],encapsulation:2})}return i})();var x=s(25849),P=s(34456),ue=s(70258);const fe=(i,l)=>l.hash,he=()=>({standalone:!0});function me(i,l){if(1&i){const t=e.RV6();e.j41(0,"div",7)(1,"div",11)(2,"a",13),e.bIt("click",function(){const r=e.eBV(t).$implicit,o=e.XpG(2);return e.Njj(o.toggleEdit(r))}),e.EFF(3),e.k0s(),e.j41(4,"input",14),e.mxI("ngModelChange",function(r){const o=e.eBV(t).$implicit;return e.DH7(o.name,r)||(o.name=r),e.Njj(r)}),e.bIt("blur",function(){const r=e.eBV(t).$implicit,o=e.XpG(2);return e.Njj(o.toggleEdit(r))}),e.k0s()(),e.j41(5,"div",12),e.nrm(6,"span",15),e.k0s(),e.j41(7,"div",16),e.EFF(8),e.k0s(),e.j41(9,"div",12)(10,"a",17),e.nI1(11,"translateHs"),e.bIt("click",function(){const r=e.eBV(t).$implicit,o=e.XpG(2);return e.Njj(o.hsTripPlannerService.removeWaypoint(r))}),e.nrm(12,"i",18),e.k0s()()()}if(2&i){const t=l.$implicit,n=e.XpG(2);e.R7$(2),e.Y8G("hidden",!!t.editMode),e.R7$(),e.JRh(t.name),e.R7$(),e.R50("ngModel",t.name),e.Y8G("ngModelOptions",e.lJ4(10,he))("hidden",!t.editMode),e.R7$(2),e.Y8G("hidden",!t.loading),e.R7$(2),e.SpI(" ",n.formatDistance(t)," "),e.R7$(2),e.Y8G("title",e.bMT(11,8,"TRIP_PLANNER.removeWaypoint"))}}function ye(i,l){1&i&&(e.j41(0,"div",8),e.EFF(1),e.nI1(2,"translateHs"),e.k0s()),2&i&&(e.R7$(),e.SpI(" ",e.bMT(2,1,"TRIP_PLANNER.waypointDrawingHint")," "))}function ge(i,l){if(1&i){const t=e.RV6();e.j41(0,"a",19),e.bIt("click",function(){e.eBV(t);const r=e.XpG(2);return e.Njj(r.hsTripPlannerService.clearAll())}),e.EFF(1),e.nI1(2,"translateHs"),e.k0s()}2&i&&(e.R7$(),e.JRh(e.bMT(2,1,"TRIP_PLANNER.clearWaypoints")))}function ve(i,l){if(1&i&&(e.j41(0,"div",1),e.nrm(1,"hs-panel-header",2),e.j41(2,"div",3),e.nrm(3,"hs-trip-planner-layer-selector",4),e.nI1(4,"translateHs"),e.nrm(5,"hs-trip-planner-layer-selector",5),e.nI1(6,"translateHs"),e.nrm(7,"hs-trip-planner-profile-selector",6),e.Z7z(8,me,13,11,"div",7,fe),e.DNE(10,ye,3,3,"div",8)(11,ge,3,3,"a",9),e.nrm(12,"br"),e.j41(13,"div",10)(14,"div",11)(15,"strong"),e.EFF(16),e.nI1(17,"translateHs"),e.k0s()(),e.j41(18,"div",12),e.EFF(19),e.k0s()()()()),2&i){const t=e.XpG();e.Y8G("ngClass",t.panelWidthClass),e.R7$(),e.Y8G("panelTabs","TRIP_PLANNER"),e.R7$(2),e.Y8G("label",e.bMT(4,10,"TRIP_PLANNER.routerLayer"))("selectedWrapper",t.hsTripPlannerService.selectedLayerWrapper.route),e.R7$(2),e.Y8G("label",e.bMT(6,12,"TRIP_PLANNER.waypointLayer"))("selectedWrapper",t.hsTripPlannerService.selectedLayerWrapper.waypoints),e.R7$(2),e.Y8G("selectedProfile",t.hsTripPlannerService.selectedProfile),e.R7$(),e.Dyx(t.hsTripPlannerService.waypoints),e.R7$(2),e.vxM(0===t.hsTripPlannerService.waypoints.length?10:11),e.R7$(6),e.SpI("",e.bMT(17,14,"TRIP_PLANNER.totalDistance"),":"),e.R7$(3),e.SpI(" ",t.totalDistance(),"")}}let Se=(()=>{class i extends x.aH{constructor(t,n,r,o,a,c){super(),this.hsConfig=t,this.hsLanguageService=n,this.hsLayerUtilsService=r,this.hsMapService=o,this.hsTripPlannerService=a,this.hsUtilsService=c,this.name="tripPlanner"}ngOnInit(){var t=()=>super.ngOnInit,n=this;return(0,m.A)(function*(){t().call(n),void 0===n.hsConfig.default_layers?n.hsConfig.default_layers=[]:n.hsConfig.default_layers.push(n.hsTripPlannerService.routeLayer)})()}formatDistance(t){return this.hsTripPlannerService.formatDistance(t)}totalDistance(){let t=0;return this.hsTripPlannerService.waypoints.forEach(n=>{n.routes.from&&(t+=n.routes.from.get("summary").distance/1e3)}),t.toFixed(2)+"km"}toggleEdit(t){t.editMode=!t.editMode;const n=this.hsTripPlannerService.waypointLayer.getSource();(0,y.YD)(n.getFeatureById(t.featureId),t.editMode)}static#e=this.\u0275fac=function(n){return new(n||i)(e.rXU($.Q),e.rXU(A.LJ),e.rXU(g.Xp),e.rXU(j.F),e.rXU(T),e.rXU(g.MJ))};static#t=this.\u0275cmp=e.VBU({type:i,selectors:[["hs-trip-planner"]],features:[e.Vt3],decls:2,vars:3,consts:[["class","card hs-main-panel",3,"ngClass",4,"ngIf"],[1,"card","hs-main-panel",3,"ngClass"],["name","tripPlanner",3,"panelTabs"],[1,"card-body","d-flex","flex-column","px-3"],["usage","route",3,"label","selectedWrapper"],["usage","waypoints",3,"label","selectedWrapper"],[3,"selectedProfile"],[1,"d-flex","flex-row","align-items-center","px-2"],["role","alert",1,"alert","alert-primary"],[1,"accordion","align-self-end","btn","btn-danger","btn-sm","m-2"],[1,"d-flex","flex-row"],[1,"p-1","flex-grow-1"],[1,"p-1"],[3,"click","hidden"],[1,"form-control","hs-waypoint-name",3,"ngModelChange","blur","ngModel","ngModelOptions","hidden"],[1,"hs-loader","hs-loader-dark",3,"hidden"],[1,"p-1",2,"margin-top","1em"],["data-toggle","tooltip",1,"p-1",3,"click","title"],[1,"icon-remove-circle",2,"color","rgb(228, 99, 99)"],[1,"accordion","align-self-end","btn","btn-danger","btn-sm","m-2",3,"click"]],template:function(n,r){1&n&&(e.DNE(0,ve,20,16,"div",0),e.nI1(1,"async")),2&n&&e.Y8G("ngIf",e.bMT(1,1,r.isVisible$))},dependencies:[P.me,P.BC,P.vS,p.YU,p.bT,ue.k,G,U,p.Jj,L.q],encapsulation:2})}return i})(),Te=(()=>{class i{static#e=this.\u0275fac=function(n){return new(n||i)};static#t=this.\u0275mod=e.$C({type:i});static#n=this.\u0275inj=e.G2t({imports:[P.YN,p.MD,x.Zz,x.k4,d.zH]})}return i})()}}]);
//# sourceMappingURL=279.js.map