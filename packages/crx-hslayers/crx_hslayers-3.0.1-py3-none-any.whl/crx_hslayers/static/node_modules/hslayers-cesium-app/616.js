"use strict";(self.webpackChunkhslayers_cesium_app=self.webpackChunkhslayers_cesium_app||[]).push([[616],{6616:(pt,P,r)=>{r.d(P,{r:()=>nt});var p=r(89204),b=r(62602),V=r(36647),D=r(61318),j=r(59452),W=r(86301),v=r(5342),B=r(45363),O=r(60316),N=r(78702),h=r(56485),f=r(91459),u=r(88716),o=r(7404),I=r(93108),S=r(94928),C=r(27426),L=r(14608);function G(l,y){if(1&l){const t=o.RV6();o.j41(0,"button",21),o.EFF(1),o.j41(2,"span",22)(3,"i",23),o.nI1(4,"translateHs"),o.bIt("click",function(a){o.eBV(t);const s=o.XpG().$implicit,i=o.XpG();return a.stopPropagation(),o.Njj(i.removeService(s))}),o.k0s()()()}if(2&l){const t=o.XpG().$implicit;o.R7$(),o.SpI("",t.title," "),o.R7$(2),o.Y8G("title",o.bMT(4,2,"COMMON.delete"))}}function U(l,y){1&l&&(o.j41(0,"button",24),o.EFF(1),o.nI1(2,"translateHs"),o.nrm(3,"span",25),o.k0s()),2&l&&(o.R7$(),o.SpI("",o.bMT(2,1,"COMPOSITIONS.cswDialog.servicesLoading"),"\u2003"))}function K(l,y){if(1&l&&o.nrm(0,"hs-layer-table",27),2&l){const t=o.XpG(2).$implicit;o.Y8G("type",t.type)("injectedService",t.typeService)}}function $(l,y){if(1&l&&o.DNE(0,K,1,2,"hs-layer-table",26),2&l){const t=o.XpG().$implicit;o.Y8G("ngIf",t.loaded&&t.selected)}}function H(l,y){if(1&l){const t=o.RV6();o.j41(0,"div",16),o.bIt("hide",function(){const a=o.eBV(t).$implicit;return o.Njj(a.selected=!1)}),o.j41(1,"div",17),o.DNE(2,G,5,4,"button",18)(3,U,4,3,"ng-template",null,1,o.C5r),o.k0s(),o.j41(5,"div",19)(6,"div",20),o.DNE(7,$,1,1,"ng-template"),o.k0s()()()}if(2&l){const t=y.$implicit,e=o.sdS(4),a=o.XpG();o.Y8G("ngbAccordionItem",t.id)("collapsed",!0)("disabled",!a.servicesLoaded)("id",t.id),o.R7$(2),o.Y8G("ngIf",t.loaded)("ngIfElse",e)}}let k=(()=>{class l{constructor(t,e,a,s,i,n){this.HsDialogContainerService=t,this.hsAddDataUrlService=e,this.hsAddDataOwsService=a,this.hsUtilsService=s,this.hsLayerUtilsService=i,this.hsMapService=n,this.servicesLoaded=!1}close(){this.HsDialogContainerService.destroy(this),this.dialogItem.resolve(!1)}ngOnInit(){var t=this;return(0,p.A)(function*(){t.data.layers&&(t.layersString=t.data.layers.map(e=>e.title).join(", "));for(const e of t.data.services)t.hsAddDataUrlService.typeSelected=e.type,yield t.hsAddDataOwsService.setUrlAndConnect({type:e.type,uri:e.url,getOnly:!0}),e.typeService=t.hsAddDataOwsService.typeService,e.typeService?.data?.layers?.length>0?(e.data=Object.assign({},e.typeService.data),e.loaded=!0):t.removeService(e);t.servicesLoaded=t.data.services.every(e=>e.loaded)})()}lookForChecked(t){for(const e of t)if(e.checked||e.Layer&&this.lookForChecked(e.Layer))return!0;return!1}setLayerParams(t,e,a){for(const s of t)if((0,u.r_)(s,!0),(0,u.SO)(s,e.title),this.hsLayerUtilsService.isLayerWMS(s)&&!a)return(0,u.P3)(s,t.map(i=>i.getSource().getParams().LAYERS).join(",")),(0,u.D6)(s,e.title),s.set("serviceLayer",!0),[s];return t}addLayers(){this.hsMapService.removeCompositionLayers(!0);for(const t of this.data.services){const e=this.lookForChecked(t.data.layers);t.typeService.data=t.data;let a=t.typeService.getLayers(e,!e);a=this.setLayerParams(a,t,e),t.typeService.addLayers(a)}this.HsDialogContainerService.destroy(this),this.dialogItem.resolve(!0)}removeService(t){this.data.services=this.data.services.filter(e=>e!=t)}beforeChange(t){const e=this.data.services.find(a=>a.id==t);e.typeService.data=e.data,e.selected=!0}static#t=this.\u0275fac=function(e){return new(e||l)(o.rXU(I.oE),o.rXU(S.Zf),o.rXU(S.Dn),o.rXU(C.MJ),o.rXU(C.Xp),o.rXU(L.F))};static#e=this.\u0275cmp=o.VBU({type:l,selectors:[["hs-csw-layers-dialog"]],inputs:{data:"data"},standalone:!0,features:[o.aNF],decls:26,vars:23,consts:[["acc","ngbAccordion"],["loadingLayers",""],["tabindex","-1","role","dialog","aria-hidden","true",1,"modal","in","hs-composition-overwrite-dialog"],[1,"modal-dialog",2,"max-width","65em"],[1,"modal-content"],[1,"modal-header"],[1,"modal-title"],["type","button","data-dismiss","modal",1,"btn-close",3,"click"],[1,"py-3","text-danger","m-auto","w-75","ps-3"],[1,"modal-body","w-75","mh-75",2,"max-height","75vh","overflow-y","auto","margin","auto"],["ngbAccordion","",3,"show","closeOthers"],[3,"ngbAccordionItem","collapsed","disabled","id","hide",4,"ngFor","ngForOf"],[1,"w-75","mh-75","m-auto","p-3",3,"hidden"],[1,"modal-footer"],["type","button","data-dismiss","modal",1,"btn","btn-primary",3,"click","disabled"],["type","button","data-dismiss","modal",1,"btn","btn-primary",3,"click"],[3,"hide","ngbAccordionItem","collapsed","disabled","id"],["ngbAccordionHeader",""],["ngbAccordionButton","","class","accordion-button justify-content-between",4,"ngIf","ngIfElse"],["ngbAccordionCollapse",""],["ngbAccordionBody",""],["ngbAccordionButton","",1,"accordion-button","justify-content-between"],[1,"ml-auto","pe-3"],["role","button",1,"icon-trash","text-secondary",3,"click","title"],[1,"accordion-button","justify-content-between"],[1,"hs-loader","ml-auto"],[3,"type","injectedService",4,"ngIf"],[3,"type","injectedService"]],template:function(e,a){if(1&e){const s=o.RV6();o.j41(0,"div",2)(1,"div",3)(2,"div",4)(3,"div",5)(4,"h4",6),o.EFF(5),o.nI1(6,"translateHs"),o.k0s(),o.j41(7,"button",7),o.nI1(8,"translateHs"),o.bIt("click",function(){return o.eBV(s),o.Njj(a.close())}),o.k0s()(),o.j41(9,"p",8),o.EFF(10),o.nI1(11,"translateHs"),o.k0s(),o.j41(12,"div",9)(13,"div",10,0),o.bIt("show",function(n){return o.eBV(s),o.Njj(a.beforeChange(n))}),o.DNE(15,H,8,6,"div",11),o.k0s()(),o.j41(16,"div",12),o.EFF(17),o.nI1(18,"translateHs"),o.k0s(),o.j41(19,"div",13)(20,"button",14),o.bIt("click",function(){return o.eBV(s),o.Njj(a.addLayers())}),o.EFF(21),o.nI1(22,"translateHs"),o.k0s(),o.j41(23,"button",15),o.bIt("click",function(){return o.eBV(s),o.Njj(a.close())}),o.EFF(24),o.nI1(25,"translateHs"),o.k0s()()()()()}2&e&&(o.R7$(5),o.SpI("",o.bMT(6,11,"COMPOSITIONS.cswDialog.loadComposition")," "),o.R7$(2),o.BMQ("aria-label",o.bMT(8,13,"COMMON.close")),o.R7$(3),o.SpI(" ",o.bMT(11,15,"COMPOSITIONS.cswDialog.infoText")," "),o.R7$(3),o.Y8G("closeOthers",!0),o.R7$(2),o.Y8G("ngForOf",a.data.services),o.R7$(),o.Y8G("hidden",0===a.layersString.length),o.R7$(),o.Lme(" ",o.bMT(18,17,"COMPOSITIONS.cswDialog.otherLayers"),": ",a.layersString," "),o.R7$(3),o.Y8G("disabled",!a.servicesLoaded),o.R7$(),o.JRh(o.bMT(22,19,"COMMON.addLayers")),o.R7$(3),o.JRh(o.bMT(25,21,"COMMON.cancel")))},dependencies:[f.q9,O.MD,O.Sq,O.bT,h._f,h.WP,h.r6,h.tW,h.x7,h.UA,h.$R,N.gw],styles:[".accordion-button[_ngcontent-%COMP%]:after{margin-left:0!important}.accordion-button[_ngcontent-%COMP%]:hover{background-color:#efefef}.accordion-button[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]:hover{color:#dc3545!important}.ml-auto[_ngcontent-%COMP%]{margin-left:auto}"]})}return l})();var X=r(99161),g=r(23916),M=r(4621),Y=r(40736),J=r(46443),z=r(66586),T=r(84243),A=r(46059),Z=r(53848),Q=r(47601),q=r(94177),_=r(23448),tt=r(55968),et=r(83211),ot=r(5991),w=r(38243),R=r(78373);let at=(()=>{class l{constructor(t,e,a,s,i,n,c,m){this.hsMapService=t,this.HsAddDataVectorService=e,this.HsStylerService=a,this.HsLanguageService=s,this.hsLog=i,this.HsToastService=n,this.hsCommonLaymanService=c,this.hsAddDataOwsService=m}createWFSLayer(t){var e=this;return(0,p.A)(function*(){const a=(t.sld||t.qml)??t.style;return(yield e.hsAddDataOwsService.connectToOWS({type:"wfs",uri:t.protocol.url.split("?")[0],layer:t.name,owrCache:!1,getOnly:!0,layerOptions:{style:a,path:t.path,fromComposition:!0}}))[0]})()}createWMTSLayer(t){var e=this;return(0,p.A)(function*(){try{return(yield e.hsAddDataOwsService.connectToOWS({type:"wmts",uri:t.protocol.url.split("?")[0],layer:t.name,owrCache:!1,getOnly:!0,layerOptions:{title:t.title,info_format:t.info_format,base:t.base,greyscale:t.greyscale,fromComposition:!0}}))[0]}catch(a){e.HsToastService.createToastPopupMessage(e.HsLanguageService.getTranslation("ADDLAYERS.capabilitiesParsingProblem",void 0),e.HsLanguageService.getTranslationIgnoreNonExisting("ERRORMESSAGES",a),{disableLocalization:!0,serviceCalledFrom:"HsCompositionsLayerParserService"})}})()}createWmsLayer(t){const e=t.params,a=this.getLegends(t);delete e.REQUEST;const i={url:decodeURIComponent(t.url),attributions:t.attribution?`<a href="${t.attribution.OnlineResource}">${t.attribution.Title}</a>`:void 0,params:e,crossOrigin:"anonymous",projection:t.projection?.toUpperCase(),ratio:t.ratio},n=t.singleTile?new Q.A(i):new q.A(i),c={title:t.title,fromComposition:t.fromComposition??!0,maxResolution:t.maxResolution||1/0,minResolution:t.minResolution||0,showInLayerManager:t.displayInLayerSwitcher,abstract:t.name||t.abstract,base:t.base,greyscale:t.greyscale,metadata:t.metadata,dimensions:t.dimensions,legends:a,path:t.path,opacity:parseInt(t.opacity)||1,source:n,subLayers:t.subLayers,className:t.greyscale?"ol-layer hs-greyscale":"ol-layer"},m=t.singleTile?new T.A(c):new A.A(c);return m.setVisible(t.visibility),this.hsMapService.proxifyLayerLoader(m,!t.singleTile),m}createArcGISLayer(t){var e=this;return(0,p.A)(function*(){return(yield e.hsAddDataOwsService.connectToOWS({type:"arcgis",uri:t.url.split("tile/{z}/{y}/{x}")[0],layer:t.title,owrCache:!1,getOnly:!0,layerOptions:{title:t.title,base:t.base,greyscale:t.greyscale,fromComposition:!0}}))[0]})()}createXYZLayer(t){var e=this;return(0,p.A)(function*(){if(t.url=decodeURIComponent(t.url),t.url.includes("/rest/services/"))return yield e.createArcGISLayer(t);const a=e.getLegends(t),s=new _.A({url:decodeURIComponent(t.url),attributions:t.attribution?`<a href="${t.attribution.OnlineResource}">${t.attribution.Title}</a>`:void 0,crossOrigin:"anonymous",projection:t.projection?.toUpperCase(),wrapX:t.wrapX}),i=new A.A({maxResolution:t.maxResolution||1/0,minResolution:t.minResolution||0,opacity:parseInt(t.opacity)||1,source:s,className:t.greyscale?"ol-layer hs-greyscale":"ol-layer",properties:{title:t.title,fromComposition:t.fromComposition??!0,showInLayerManager:t.displayInLayerSwitcher,abstract:t.name||t.abstract,base:t.base||t.url.indexOf("openstreetmap")>-1,greyscale:t.greyscale,metadata:t.metadata,dimensions:t.dimensions,legends:a,path:t.path}});return i.setVisible(t.visibility),i})()}createStaticImageLayer(t){const e=this.getLegends(t),a=new tt.A({url:decodeURIComponent(t.url),attributions:t.attribution?`<a href="${t.attribution.OnlineResource}">${t.attribution.Title}</a>`:void 0,imageExtent:t.extent,crossOrigin:"anonymous",projection:t.projection?.toUpperCase()}),s=new T.A({maxResolution:t.maxResolution||1/0,minResolution:t.minResolution||0,className:t.greyscale?"ol-layer hs-greyscale":"ol-layer",opacity:parseInt(t.opacity)||1,source:a,properties:{title:t.title,fromComposition:t.fromComposition??!0,showInLayerManager:t.displayInLayerSwitcher,abstract:t.name||t.abstract,base:t.base,greyscale:t.greyscale,metadata:t.metadata,dimensions:t.dimensions,legends:e,path:t.path}});return s.setVisible(t.visibility),s}createSparqlLayer(t){var e=this;return(0,p.A)(function*(){const a=decodeURIComponent(t.protocol.url),s={};s.url=a,s.format="Sparql";let i=null;t.style&&(i=(yield e.HsStylerService.parseStyle(t.style)).style);const n=new et.Gb({geomAttribute:"?geom",url:a,category:"http://www.openvoc.eu/poi#categoryWaze",projection:"EPSG:3857"}),c=new Z.A({properties:{title:t.title,fromComposition:t.fromComposition??!0,definition:s},source:n,opacity:parseInt(t.opacity)||1,style:i});return c.setVisible(t.visibility),c})()}getLegends(t){return t.legends?t.legends.map(e=>decodeURIComponent(e)):[]}createVectorLayer(t){var e=this;return(0,p.A)(function*(){try{let a="";t.protocol&&(a=t.protocol.format,void 0!==t.protocol.url&&(t.protocol.url=decodeURIComponent(t.protocol.url)));const s={opacity:parseInt(t.opacity)||1,fromComposition:t.fromComposition??!0,path:t.path,visible:t.visibility,workspace:t.workspace||t.protocol?.url.split("geoserver/")[1].split("/")[0]};let i=!0;if(t.style){if("string"==typeof t.style&&t.style.startsWith("http"))try{t.style=yield e.hsCommonLaymanService.getStyleFromUrl(t.style)}catch{e.hsLog.warn("Could not get style from "+t.style)}Object.assign(s,yield e.HsStylerService.parseStyle(t.style)),i=!1}const n=t.title||"Layer";let c;switch(a){case"ol.format.KML":case"KML":c=yield e.HsAddDataVectorService.createVectorLayer("kml",t.protocol.url,t.name||n,n,t.abstract,t.projection?.toUpperCase(),Object.assign(s,{extractStyles:i}));break;case"ol.format.GeoJSON":case"GeoJSON":c=yield e.HsAddDataVectorService.createVectorLayer("geojson",t.protocol.url,t.name||n,n,t.abstract,t.projection?.toUpperCase(),s);break;case"hs.format.WFS":case"WFS":c=yield e.HsAddDataVectorService.createVectorLayer("wfs",t.protocol.url,t.name||n,n,t.abstract,t.projection?.toUpperCase(),s);break;case"hs.format.Sparql":case"Sparql":c=yield e.createSparqlLayer(t);break;default:const m=t.features?(new z.default).readFeatures(t.features,{dataProjection:"EPSG:4326",featureProjection:e.hsMapService.getCurrentProj()}):void 0;c=yield e.HsAddDataVectorService.createVectorLayer("",void 0,t.name||n,n,t.abstract,t.projection?.toUpperCase(),{opacity:parseInt(t.opacity),visible:t.visibility,path:t.path,fromComposition:t.fromComposition,style:s.style??t.style,sld:s.sld,qml:s.qml,features:m})}return(0,u.YK)(c,t.protocol),c}catch{return null}})()}static#t=this.\u0275fac=function(e){return new(e||l)(o.KVO(L.F),o.KVO(S.fm),o.KVO(ot.qm),o.KVO(f.LJ),o.KVO(w.r),o.KVO(R.ST),o.KVO(g.wC),o.KVO(S.Dn))};static#e=this.\u0275prov=o.jDH({token:l,factory:l.\u0275fac,providedIn:"root"})}return l})();var it=r(24025),st=r(22187),F=r(60014);let nt=(()=>{class l{constructor(t,e,a,s,i,n,c,m,d,x,rt,ct,lt,mt){this.hsMapService=t,this.hsConfig=e,this.$http=a,this.hsUtilsService=s,this.hsCompositionsLayerParserService=i,this.hsDialogContainerService=n,this.hsLayoutService=c,this.$log=m,this.hsEventBusService=d,this.hsLanguageService=x,this.hsCommonLaymanService=rt,this.hsLayerManagerService=ct,this.hsToastService=lt,this.HsLayerManagerVisibilityService=mt,this.composition_loaded=null,this.composition_edited=!1,this.current_composition_title="",this.loadingOptions={suspendZoomingToExtent:!1,suspendPanelChange:!1},this.currentCompositionRecord=this.hsEventBusService.compositionLoads.pipe((0,V.n)(ut=>{const E=(0,g.cb)(this.current_composition_url,this.hsCommonLaymanService.layman);return this.$http.get(this.current_composition_url.replace("/file",""),{withCredentials:this.hsCommonLaymanService.layman.user&&E}).pipe((0,D.W)(dt=>(E&&m.error("Could not get composition metadata"),(0,j.of)(dt))))}),(0,W.t)(1))}loadUrl(t,e,a,s){var i=this;return(0,p.A)(function*(){if("string"!=typeof t)return s=m=>i.parseCSW(m),t.success=!0,void i.loaded(t,s,t,e,a);i.current_composition_url=t,t=t.replace(/&amp;/g,"&");const n={};(t=i.hsUtilsService.proxify(t)).includes(".wmc")&&(s=m=>i.parseWMC(m),n.responseType="text"),n.withCredentials=(0,g.cb)(t,i.hsCommonLaymanService.layman)&&i.hsCommonLaymanService.layman.user;const c=yield(0,v.s)(i.$http.get(t,n)).catch(m=>{i.raiseCompositionLoadError(m)});if(c){if(c.file)return i.loadUrl(c.file.url,e,a,s);i.loaded(c,s,t,e,a)}})()}loaded(t,e,a,s,i){var n=this;return(0,p.A)(function*(){n.checkLoadSuccess(t)?(n.hsUtilsService.isFunction(e)&&(t=yield e(t)),t.basemapComposition||(n.composition_loaded=a),(yield n.loadCompositionObject(t.data||t,s&&!e,t.title,t.extent))&&!t.basemapComposition&&n.finalizeCompositionLoading(t),n.hsUtilsService.isFunction(i)&&i()):n.raiseCompositionLoadError(t)})()}parseCSWLayer(t){if(t.online)for(const e of t.online){const a=X.qd.find(s=>e.protocolUri.toLowerCase().includes(s));if(a)return{type:a,title:t.title,url:e.url,id:(0,C.bz)()}}}getCSWLayers(t){const e=[],a=[];for(const s of t.operatesOn){const i=this.parseCSWLayer(s);i&&(i.url.includes("LAYERS=")?e:a).push(i)}return{layers:e,services:a}}parseCSW(t){var e=this;return(0,p.A)(function*(){const a={};a.name=(0,g.aS)(t.title),a.title=t.title,a.scale=1,a.schema_version="2.0.0",a.title=t.title,a.abstract=t.abstract;const s=e.getCSWLayers(t);return a.layers=s.layers,a.services=s.services,a.layers?.length>0&&a.layers.filter(i=>(i.className="wms"==i.type?"WMS":null,i.params={FORMAT:"image/png",INFO_FORMAT:"text/html",LAYERS:i.url.split("&").find(n=>n.includes("LAYERS")).split("=")[1],VERSION:i.url.split("&").find(n=>n.includes("VERSION")).split("=")[1]},i.url=i.url.split("?")[0],i.className)),a})()}parseWMC(t){let e=b.xml2js(t,{compact:!0});e=e.ViewContext;const a={current_base_layer:{title:"Composite_base_layer"},extent:[parseFloat(e.General.BoundingBox._attributes.maxx),parseFloat(e.General.BoundingBox._attributes.maxy),parseFloat(e.General.BoundingBox._attributes.minx),parseFloat(e.General.BoundingBox._attributes.miny)],layers:[],units:e.LayerList.Layer[0].Extension["ol:units"]._text,scale:1,id:e._attributes.id};a.name=e.General.Title._text,a.projection=e.General.BoundingBox._attributes.SRS,a.projection="EPSG:102067"==a.projection?"EPSG:5514":a.projection,a.extent=(0,B.transformExtent)(a.extent,a.projection,"EPSG:4326");for(const i of e.LayerList.Layer){const n={className:"WMS",dimensions:void 0,legends:[""],maxResolution:null,metadata:{},minResolution:0,opacity:i.Extension["ol:opacity"]?parseFloat(i.Extension["ol:opacity"]._text):1,showInLayerManager:i.Extension["ol:displayInLayerSwitcher"]._text,params:{FORMAT:"image/png",INFO_FORMAT:"text/html",LAYERS:i.Name._text,VERSION:i.Server._attributes.version},ratio:1.5,singleTile:!0,title:i.Extension["hsl:layer_title"]._text,url:i.Server.OnlineResource._attributes["xlink:href"],visibility:!0};a.layers.push(n)}const s={data:{}};return s.data=a,s}checkLoadSuccess(t){return 1==t.success||null==t.success&&void 0!==t.name||t.includes&&t.includes("LayerList")}loadCompositionObject(t,e,a,s){var i=this;return(0,p.A)(function*(){(null==e||1==e)&&i.hsMapService.removeCompositionLayers(1==e),i.current_composition_title=a||t.title;const n=s||t.extent;if(void 0!==n&&!i.loadingOptions.suspendZoomingToExtent){const d=(0,M.ov)(n);d[0][0]<-90&&d[0][1]<-180||d[1][0]>90&&d[1][1]>180?i.loadWarningBootstrap(d):i.hsMapService.fitExtent((0,M.MF)(d,i.hsMapService.getCurrentProj()))}const c=yield i.jsonToLayers(t);return!(t.services&&!(yield i.hsDialogContainerService.create(k,{services:t.services,layers:t.layers}).waitResult())||(c?.length>0&&(c.forEach(d=>{t.basemapComposition&&(0,u.CQ)(d,!0),i.hsMapService.addLayer(d,L.J.RemoveOriginal)}),i.hsLayerManagerService.updateLayerListPositions()),t.current_base_layer&&i.hsMapService.getMap().getLayers().forEach(d=>{if((0,u.LK)(d)==t.current_base_layer.title||(0,u.LK)(d)==t.current_base_layer){const x=i.hsLayerManagerService.getLayerDescriptorForOlLayer(d,!0);i.HsLayerManagerVisibilityService.changeBaseLayerVisibility(!0,x)}}),0))})()}finalizeCompositionLoading(t){const e=this.hsConfig.open_lm_after_comp_loaded;(!0===e||void 0===e)&&!this.loadingOptions.suspendPanelChange&&(this.loadingOptions.suspendPanelChange=!1,this.hsLayoutService.setMainPanel("layerManager")),this.composition_edited=!1,this.hsLayerManagerService.updateLayerListPositions(),this.hsEventBusService.compositionLoads.next(t)}raiseCompositionLoadError(t){const e={};"no data"===(e.error=t.error??"Composition file corrupted",t.error)?(e.title=this.hsLanguageService.getTranslation("COMPOSITIONS.compositionNotFound",void 0),e.abstract=this.hsLanguageService.getTranslation("COMPOSITIONS.sorryButComposition",void 0)):(e.title=this.hsLanguageService.getTranslation("COMPOSITIONS.compositionNotLoaded",void 0),e.abstract=this.hsLanguageService.getTranslation("COMPOSITIONS.weAreSorryBut",void 0)),this.hsEventBusService.compositionLoads.next(e)}loadInfo(t){var e=this;return(0,p.A)(function*(){let a;return t=t.replace(/&amp;/g,"&"),(t=e.hsUtilsService.proxify(t)).endsWith(".wmc")?(a=yield(0,v.s)(e.$http.get(t,{responseType:"text"})),a=e.parseMickaWmcInfo(a)):t.includes("GetRecordById")?(a=yield(0,v.s)(e.$http.get(t,{responseType:"text"})),a=e.parseMickaCSWInfo(a)):a=yield(0,v.s)(e.$http.get(t,{responseType:"json",withCredentials:!!e.hsCommonLaymanService.layman.user})),a.data||a})()}parseMickaWmcInfo(t){let e=b.xml2js(t,{compact:!0});const a=e.ViewContext.LayerList?.Layer,s=e.ViewContext.General.KeywordList?.Keyword;e=e.ViewContext.General;const i={title:e.Title?._text,abstract:e.Abstract?._text,srs:e.BoundingBox?._attributes?.SRS,extent:[parseFloat(e.BoundingBox?._attributes.maxx),parseFloat(e.BoundingBox?._attributes.maxy),parseFloat(e.BoundingBox?._attributes.minx),parseFloat(e.BoundingBox?._attributes.miny)],contactAddress:{address:e.ContactInformation?.ContactAddress?.Address?._text,city:e.ContactInformation?.ContactAddress?.City?._text,country:e.ContactInformation?.ContactAddress?.Country?._text,postalCode:e.ContactInformation?.ContactAddress?.PostCode?._text,stateOrProvince:e.ContactInformation?.ContactAddress?.StateOrProvince?._text},contactPersonPrimary:{organization:e.ContactInformation?.ContactPersonPrimary?.ContactOrganization?._text,person:e.ContactInformation?.ContactPersonPrimary?.ContactPerson?._text,phone:e.ContactInformation?.ContactVoiceTelephone?._text,email:e.ContactInformation?.ContactElectronicMailAddress?._text}};return void 0!==a&&(i.layers=a.map(n=>({title:n.Title?._text}))),void 0!==s&&(i.keywords=Array.isArray(s)?s.map(n=>n._text):s._text),i}parseMickaCSWInfo(t){const a=b.xml2js(t,{compact:!0})["csw:GetRecordByIdResponse"]["gmd:MD_Metadata"]["gmd:identificationInfo"]["srv:SV_ServiceIdentification"],s=a["srv:operatesOn"],i=a["srv:extent"]["gmd:EX_Extent"]["gmd:geographicElement"]["gmd:EX_GeographicBoundingBox"],n={title:a["gmd:citation"]["gmd:CI_Citation"]["gmd:title"]["gco:CharacterString"]._text,abstract:a["gmd:abstract"]["gco:CharacterString"]._text,extent:[parseFloat(i["gmd:eastBoundLongitude"]["gco:Decimal"]._text),parseFloat(i["gmd:southBoundLatitude"]["gco:Decimal"]._text),parseFloat(i["gmd:northBoundLatitude"]["gco:Decimal"]._text),parseFloat(i["gmd:westBoundLongitude"]["gco:Decimal"]._text)]};void 0!==s&&(n.layers=s.map(m=>({title:m._attributes["xlink:title"]})));let c=a["gmd:descriptiveKeywords"];return c=Array.isArray(c)?this.getCSWKeyWords(c):c["gmd:MD_Keywords"]["gmd:keyword"],c&&(Array.isArray(c),n.keywords=c.map(m=>m["gco:CharacterString"]._text)),n}getCSWKeyWords(t){let e;for(const a of t)e=a["gmd:MD_Keywords"]["gmd:keyword"]??e;return[e]}loadWarningBootstrap(t){this.hsDialogContainerService.create(I.yW,{extent:t,composition_title:this.current_composition_title,message:"COMPOSITIONS.dialogWarning.outOfBounds"})}jsonToLayers(t){var e=this;return(0,p.A)(function*(){const a=[];t.data&&(t=t.data);const s=t.layers[0]?.base;for(const i of t.layers){const n=yield e.jsonToLayer(i);null==n?(!i.protocol||"hs.format.externalWFS"!=i.protocol.format||"externalWFS"!=i.protocol.format)&&(e.$log.warn("Was not able to parse layer from composition",i),e.hsToastService.createToastPopupMessage(e.hsLanguageService.getTranslation("COMPOSITIONS.errorWhileCreatingLayerFromComposition"),e.hsLanguageService.getTranslation("COMPOSITIONS.notAbleToParseLayerFromComposition")+" "+i.title,{disableLocalization:!0,serviceCalledFrom:"HsCompositionsParserService"})):a[s?"push":"unshift"](n)}return a})()}jsonToLayer(t){var e=this;return(0,p.A)(function*(){let a;switch(t.className){case"HSLayers.Layer.WMS":case"WMS":a=e.hsCompositionsLayerParserService.createWmsLayer(t);break;case"HSLayers.Layer.WMTS":case"WMTS":a=e.hsCompositionsLayerParserService.createWMTSLayer(t);break;case"ArcGISRest":a=e.hsCompositionsLayerParserService.createArcGISLayer(t);break;case"XYZ":a=e.hsCompositionsLayerParserService.createXYZLayer(t);break;case"StaticImage":a=e.hsCompositionsLayerParserService.createStaticImageLayer(t);break;case"Vector":a=t.protocol?.format.includes("externalWFS")?e.hsCompositionsLayerParserService.createWFSLayer(t):yield e.hsCompositionsLayerParserService.createVectorLayer(t);break;default:const s=e.hsMapService.getLayersArray().find(i=>(0,u.LK)(i)==t.title);return null!=s?(s.setZIndex(void 0),s):void 0}return a&&(a=yield a,(0,u.kq)(a,t.metadata),(0,u.Kc)(a,t.swipeSide),(0,u.s3)(a,!0)),a})()}static#t=this.\u0275fac=function(e){return new(e||l)(o.KVO(L.F),o.KVO(Y.Q),o.KVO(J.Qq),o.KVO(C.MJ),o.KVO(at),o.KVO(I.oE),o.KVO(it.F),o.KVO(w.r),o.KVO(st.z),o.KVO(f.LJ),o.KVO(g.wC),o.KVO(F.ng),o.KVO(R.ST),o.KVO(F.Te))};static#e=this.\u0275prov=o.jDH({token:l,factory:l.\u0275fac,providedIn:"root"})}return l})()}}]);
//# sourceMappingURL=616.js.map