"use strict";(self.webpackChunkhslayers_app=self.webpackChunkhslayers_app||[]).push([["default-projects_hslayers_services_layer-manager_index_ts"],{42245:(q,B,h)=>{h.d(B,{tl:()=>Y,$B:()=>fe,hr:()=>Q,u4:()=>$,ng:()=>ye,qA:()=>w,Te:()=>X,lX:()=>K});var f=h(10467),C=h(39974),A=h(54360);var P=h(97647),j=h(89079),m=h(65935),g=h(64801),a=h(88716),o=h(93953),O=h(40736),V=h(47317),H=h(22187),G=h(91459),Z=h(48791),W=h(46526),E=h(14608),_=h(5991),S=h(27426);let Y=(()=>{class c{constructor(t,e,r,s){this.hsConfig=t,this.hsMapService=e,this.hsStylerService=r,this.hsUtilsService=s,this.layersClusteredFromStart=[]}cluster(t,e,r,s){var i=this;return(0,f.A)(function*(){1==t?i.hsUtilsService.instOf(e.getSource(),W.A)||(e.setSource(i.createClusteredSource(e,r)),s&&(yield i.hsStylerService.styleClusteredLayer(e)),i.updateFeatureTableLayers(e)):i.hsUtilsService.instOf(e.getSource(),W.A)&&e.setSource(e.getSource().getSource())})()}createClusteredSource(t,e){return new W.A({distance:e,source:t.getSource(),geometryFunction:function(r){if(!r)return null;switch(r.getGeometry().getType()){case"Point":return r.getGeometry();case"Circle":return new Z.default(r.getGeometry().getCenter());case"Polygon":return r.getGeometry().getInteriorPoint();case"LineString":return new Z.default(r.getGeometry().getFirstCoordinate());default:return null}}})}updateFeatureTableLayers(t){const e=this.hsConfig.layersInFeatureTable?.findIndex(r=>r==t);t&&e>-1&&(this.hsConfig.layersInFeatureTable[e]=t)}static#e=this.\u0275fac=function(e){return new(e||c)(o.KVO(O.Q),o.KVO(E.F),o.KVO(_.qm),o.KVO(S.MJ))};static#t=this.\u0275prov=o.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})();var ee=h(11229),te=h(35222),z=h(87549),R=h(38243),I=h(94928);let $=(()=>{class c{constructor(t,e,r,s,i,n,l,u,y,d){this.HsWmtsGetCapabilitiesService=t,this.HsWfsGetCapabilitiesService=e,this.HsWmsGetCapabilitiesService=r,this.HsArcgisGetCapabilitiesService=s,this.HsDimensionTimeService=i,this.HsLayerUtilsService=n,this.hsLog=l,this.hsUrlWmsService=u,this.hsMapService=y,this.hsAddDataUrlService=d}identifyLayerObject(t,e,r=!1){if(t==e.Name||r)return r?this.getParsedLayers(e):e;if(Array.isArray(e.Layer))for(const s of e.Layer){const i=this.identifyLayerObject(t,s);if(i)return i}else if(e.Layer)return this.identifyLayerObject(t,e.Layer);return null}getParsedLayers(t){return t.Layer.every(r=>r.Name)||(t.Layer=this.hsUrlWmsService.filterCapabilitiesLayers(t)),t}fillMetadata(t){var e=this;return(0,f.A)(function*(){const r=t.layer;try{yield e.queryMetadata(t)}catch(i){e.hsLog.warn(`Error while querying metadata ${i}`)}const s=(0,a.jA)(r)?.Layer;null!=s&&s.length>0&&(t.hasSublayers||(t.hasSublayers=!0))})()}metadataArray(t){return(0,a.yb)(t.layer)?.urls}hasMetadata(t){return!!t&&!(!t||!(0,a.yb)(t.layer)?.urls)}searchForScaleDenominator(t){const e=this.hsMapService.getMap().getView();let r=t.MaxScaleDenominator?this.HsLayerUtilsService.calculateResolutionFromScale(t.MaxScaleDenominator,e):null;const s=t.MinScaleDenominator?this.HsLayerUtilsService.calculateResolutionFromScale(t.MinScaleDenominator,e):0,i=t.Layer;if(i)for(const n of i)if(n.Layer){const l=this.searchForScaleDenominator(n);r=l>r?l:r}else n.MaxScaleDenominator?(n.maxResolution=this.HsLayerUtilsService.calculateResolutionFromScale(n.MaxScaleDenominator,e),r<n.maxResolution&&null!==r&&(r=this.HsLayerUtilsService.calculateResolutionFromScale(n.MaxScaleDenominator,e))):n.maxResolution||(n.maxResolution=r??Number.MAX_VALUE);return r&&(t.maxResolution=r),s&&(t.minResolution=s),r}setOrUpdate(t,e,r){const s=t.get(e);if(s)for(const i of r)t.set(e,s.push(i));else t.set(e,r)}parseWmsCapsMultipleLayers(t,e,r,s){let i;const n=r.Capability.Layer,l=[];for(const u of t.split(",")){const y=this.identifyLayerObject(u,n);l.push(y),this.collectLegend(y,s),y&&void 0!==y.Layer&&(0,a.vx)(e)&&delete y.Layer}return this.setCapsExtent(this.hsAddDataUrlService.calcCombinedExtent(l.map(u=>this.getCapsExtent(u,n))),e),void 0===(0,a.jA)(e)&&(i=Object.assign(JSON.parse(JSON.stringify(l[0])),{maxResolution:Math.max(...l.map(u=>this.searchForScaleDenominator(u))),Layer:l})),this.fillMetadataUrlsIfNotExist(e,r),i}parseWmsCapsSingleLayer(t,e,r,s){const i=e.layer,n=r.Capability.Layer,l=this.identifyLayerObject(t,n,i.get("serviceLayer"));if(null!=l){if(i.setProperties(l),("time"===l.Dimension?.name||l.Dimension?.find(u=>"time"===u.name))&&this.HsDimensionTimeService.setupTimeLayer(e,l),l.Layer&&(0,a.vx)(i)){l.maxResolution=this.searchForScaleDenominator(l);const u=(0,a.vx)(i).split(",");l.Layer=l.Layer.filter(y=>u.includes(y.Name))}return l.queryable&&null==this.HsLayerUtilsService.getLayerParams(i)?.INFO_FORMAT&&this.HsLayerUtilsService.updateLayerParams(i,{INFO_FORMAT:"application/vnd.ogc.gml"}),this.collectLegend(l,s),this.setCapsExtent(this.getCapsExtent(l,n),i),l}}parseWmsCaps(t,e,r){const s=t.layer,i=[];let n;n=e.includes(",")?this.parseWmsCapsMultipleLayers(e,s,r,i):this.parseWmsCapsSingleLayer(e,t,r,i),void 0===(0,a.jA)(s)&&(0,a.BA)(s,n),this.parseAttribution(s,(0,a.jA)(s));const l=(0,a.pL)(s);i.length>0&&null==l&&(0,a.ZX)(s,i)}setCapsExtent(t,e){null!==t&&e.setExtent(t)}getCapsExtent(t,e){let r=(t.EX_GeographicBoundingBox||t.BoundingBox)??(e.EX_GeographicBoundingBox||e.BoundingBox);return r=r?r[0].crs?r.find(s=>"CRS:84"!=s.crs&&(0,z.get)(t.BoundingBox[0])):r:[-180,-90,180,90],(0,z.transformExtent)(r.extent??r,r.crs??"EPSG:4326",this.hsMapService.getCurrentProj())}collectLegend(t,e){const r=t?.Style?.find(s=>void 0!==s.LegendURL);r&&e.push(r.LegendURL[0].OnlineResource)}parseAttribution(t,e){const r=e.Attribution;(0,a.gz)(t)?.locked||null==r||(0,a.eo)(t,{title:r.Title,onlineResource:r.OnlineResource,logoUrl:r.LogoURL?{format:r.LogoURL.Format,onlineResource:r.LogoURL.OnlineResource}:void 0})}queryMetadata(t){var e=this;return(0,f.A)(function*(){const r=t.layer,s=e.HsLayerUtilsService.getURL(r);if(s&&0!==s.length)if(e.HsLayerUtilsService.isLayerArcgis(r)){const i=yield e.HsArcgisGetCapabilitiesService.request(s);if(i.error)return i.response;e.parseArcGisCaps(t,i.response)}else{if(e.HsLayerUtilsService.isLayerWMS(r)){const i=yield e.HsWmsGetCapabilitiesService.request(s);if(i.error)return e.hsLog.warn("GetCapabilities call invalid",i.response),i.response;const l=(new ee.A).read(i.response),y=e.HsLayerUtilsService.getLayerParams(r).LAYERS;e.parseWmsCaps(t,y,l);const d=(0,a.vx)(r);return d&&(Array.isArray(d)&&0==d.length||e.HsLayerUtilsService.updateLayerParams(r,{LAYERS:(0,a.vx)(r)})),e.fillMetadataUrlsIfNotExist(r,l),setTimeout(()=>{if((0,a.xx)(r))return void r.setMaxResolution((0,a.xx)(r));const L=e.searchForScaleDenominator(r.getProperties());L&&r.setMaxResolution(L)}),!0}if(e.HsLayerUtilsService.isLayerWMTS(r)){const i=yield e.HsWmtsGetCapabilitiesService.request(s);if(i.error)return i.response;{const l=(new te.A).read(i.response);return r.setProperties(l),(0,a.gz)(r)?.locked||(0,a.eo)(r,{onlineResource:l.ServiceProvider.ProviderSite}),!0}}if(e.HsLayerUtilsService.isLayerVectorLayer(r)&&s){const i=yield e.HsWfsGetCapabilitiesService.request(s);if(i.error)return i.response;{const u=(new DOMParser).parseFromString(i.response.data,"application/xml").getElementsByTagNameNS("*","ProviderSite");return(0,a.gz)(r)?.locked||(0,a.eo)(r,{onlineResource:u[0].getAttribute("xlink:href")}),!0}}}})()}parseArcGisCaps(t,e){const r=t.layer,i=this.HsLayerUtilsService.getLayerParams(r).LAYERS,n=[];let l;if(void 0!==i&&(i.includes(",")||i.includes("show"))){const y=[];for(const d of i.replace("show:","").split(",")){const L=this.identifyArcgisLayerObj(parseInt(d),e);y.push(L),this.collectLegend(L,n),L&&void 0!==L.Layer&&(0,a.vx)(r)&&delete L.Layer}void 0===(0,a.jA)(r)&&(l=Object.assign(JSON.parse(JSON.stringify(y[0])),{Layer:y}))}else{if(l=this.identifyArcgisLayerObj(parseInt(i),e),null==l)return;l.Layer&&(0,a.vx)(r)&&delete l.Layer,this.collectLegend(l,n)}null==(0,a.jA)(r)&&(0,a.BA)(r,l),this.parseAttribution(r,(0,a.jA)(r));const u=(0,a.pL)(r);n.length>0&&null==u&&(0,a.ZX)(r,n)}identifyArcgisLayerObj(t,e){if(null==t||isNaN(t))return{Title:e.mapName,Name:0,Layer:e?.layers?.map(r=>({Title:r.name,Name:r.id}))};{const r=e.layers.find(s=>s.id==t);if(r){const s={Title:r.name,Name:r.id,Layer:e.layers.filter(i=>i.parentLayerId==t).map(i=>({Title:i.name,Name:i.id}))};return 0==s.Layer.length&&delete s.Layer,s}}return null}fillMetadataUrlsIfNotExist(t,e){null==(0,a.yb)(t)&&(0,a.kq)(t,{urls:[{onlineResource:e.Service.OnlineResource}]})}static#e=this.\u0275fac=function(e){return new(e||c)(o.KVO(V.oh),o.KVO(V.BT),o.KVO(V.Uz),o.KVO(V.OO),o.KVO(V.C6),o.KVO(S.Xp),o.KVO(R.r),o.KVO(I.l6),o.KVO(E.F),o.KVO(I.Zf))};static#t=this.\u0275prov=o.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})();var U=h(21413);let K=(()=>{class c{constructor(){this.layerSelected=new U.B}select(t){this.currentLayer=t,this.layerSelected.next(t)}static#e=this.\u0275fac=function(e){return new(e||c)};static#t=this.\u0275prov=o.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})();var re=h(24025),se=h(11194),J=h(78373),ie=h(345),ae=h(83093);let w=(()=>{class c{constructor(t,e,r,s,i){this.hsConfig=t,this.hsLayerUtilsService=e,this.hsLayerSelectorService=r,this.hsMapService=s,this.hsLog=i,this.layerSelected=new U.B}expandFilter(t,e){t.expandFilter=e,this.hsLayerSelectorService.currentLayer=t,this.hsLayerSelectorService.select(t)}expandInfo(t,e){t.expandInfo=e}saveGeoJson(){const t=new ae.default,e=this.hsLayerSelectorService.currentLayer.layer,r=t.writeFeatures((this.hsLayerUtilsService.isLayerClustered(e)?e.getSource().getSource():e.getSource()).getFeatures(),{dataProjection:"EPSG:4326",featureProjection:this.hsMapService.getCurrentProj()}),s=new Blob([r],{type:"application/json"}),i=document.createElement("a"),n=URL.createObjectURL(s);i.href=n,i.download=(0,a.LK)(this.hsLayerSelectorService.currentLayer.layer).replace(/\s/g,""),document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),window.URL.revokeObjectURL(n)},0)}getLayerSourceType(t){var e=this;return(0,f.A)(function*(){return(yield e.hsLayerUtilsService.isLayerKMLSource(t))?"vector (KML)":(yield e.hsLayerUtilsService.isLayerGPXSource(t))?"vector (GPX)":(yield e.hsLayerUtilsService.isLayerGeoJSONSource(t))?"vector (GeoJSON)":(yield e.hsLayerUtilsService.isLayerTopoJSONSource(t))?"vector (TopoJSON)":e.hsLayerUtilsService.isLayerVectorLayer(t)?"vector":e.hsLayerUtilsService.isLayerWMTS(t)?"WMTS":e.hsLayerUtilsService.isLayerWMS(t)?"WMS":e.hsLayerUtilsService.isLayerXYZ(t)?"XYZ":e.hsLayerUtilsService.isLayerArcgis(t)?"ArcGIS":e.hsLayerUtilsService.isLayerIDW(t)?"IDW":(e.hsLog.warn(`Cannot decide a type of source of layer ${(0,a.LK)(t)}`),"unknown type")})()}getLayerSourceUrl(t){const e=this.hsLayerUtilsService.getURL(t)?.split("?")[0];return!e||e.startsWith("data:")?"memory":e}checkLayerHealth(t){this.hsLayerUtilsService.isLayerWMS(t)&&null==this.hsLayerUtilsService.getLayerParams(t).LAYERS&&this.hsLog.warn("Layer",t,"is missing LAYERS parameter")}getImage(t){const e=(0,a.Eb)(t);return e?e.length>10?e:this.hsConfig.assetsPath+"img/"+e:this.hsConfig.assetsPath+"img/default.png"}static#e=this.\u0275fac=function(e){return new(e||c)(o.KVO(O.Q),o.KVO(S.Xp),o.KVO(K),o.KVO(E.F),o.KVO(R.r))};static#t=this.\u0275prov=o.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})();var N=h(47616);let X=(()=>{class c{constructor(t,e,r,s){this.hsMapService=t,this.hsConfig=e,this.hsUtilsService=r,this.hsEventBusService=s,this.baselayersVisible=!0}layerVisibilityChanged(t){if(1!=(0,a.W1)(t.target)){for(const e of this.data.layers)if(e.layer==t.target){e.visible=t.target.getVisible();break}}else for(const e of this.data.baselayers)e.active=e.layer==t.target&&t.target.getVisible()}isLayerInResolutionInterval(t){const e=this.hsMapService.getMap().getView().getResolution();return this.currentResolution=e,t.getMinResolution()<=e&&e<=t.getMaxResolution()}changeLayerVisibility(t,e){if(e.layer.setVisible(t),e.visible=t,e.grayed=!this.isLayerInResolutionInterval(e.layer),t&&1==(0,a.lo)(e.layer))for(const r of this.data.layers){const s=!this.hsConfig.pathExclusivity||(0,a.Yn)(r.layer)==(0,a.Yn)(e.layer);1==(0,a.lo)(r.layer)&&r!=e&&s&&(r.layer.setVisible(!1),r.visible=!1)}!t&&this.hsUtilsService.instOf(e.layer,N.A)&&this.hsEventBusService.LayerManagerLayerVisibilityChanges.next(e)}activateTheme(t){const e=!(0,a.FQ)(t);(0,a.Fm)(t,e);let r=!1;t.setVisible(e);for(const s of t.get("layers"))if(1!=(0,a.W1)(s)||r){if(1==(0,a.W1)(s))return;s.setVisible(e)}else this.changeBaseLayerVisibility(null,null),r=!0}changeTerrainLayerVisibility(t,e){for(const r of this.data.terrainLayers)"terrain"==r.type&&(r.visible=r==e,r.active=r.visible);this.hsEventBusService.LayerManagerBaseLayerVisibilityChanges.next(e)}changeBaseLayerVisibility(t=null,e=null){if(null===e||void 0!==e.layer){for(const r of this.data.baselayers){if(!r.layer)continue;const s=r==e;this.baselayersVisible&&(r.galleryMiniMenu=s),t?(r.visible=s,r.active=s,r.layer.set("visible",s,!s)):this.baselayersVisible?r.layer.setVisible(!1):r.visible&&r.layer.setVisible(!0)}t?(this.baselayersVisible&&(e.active=!0),this.baselayersVisible=!0):this.baselayersVisible=!this.baselayersVisible,this.hsEventBusService.LayerManagerBaseLayerVisibilityChanges.next(e)}}static#e=this.\u0275fac=function(e){return new(e||c)(o.KVO(E.F),o.KVO(O.Q),o.KVO(S.MJ),o.KVO(H.z))};static#t=this.\u0275prov=o.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})();var b=function(c){return c.ADD_LAYER="ADD_LAYER",c.REMOVE_LAYER="REMOVE_LAYER",c.SORT_BY_Z="SORT_BY_Z",c}(b||{});let Q=(()=>{class c{constructor(t,e){this.hsLanguageService=t,this.hsConfig=e,this.folderAction$=new U.B}foldersReducer(t,e){switch(e.type){case b.ADD_LAYER:return this.populateFolders(t,e.lyr);case b.REMOVE_LAYER:return this.cleanFolders(t,e.lyr);case b.SORT_BY_Z:return this.sortFoldersByZ(t);default:return t}}addLayer(t){return{type:b.ADD_LAYER,lyr:t}}removeLayer(t){return{type:b.REMOVE_LAYER,lyr:t}}sortByZ(){return{type:b.SORT_BY_Z,lyr:void 0}}populateFolders(t,e){const r=new Map(t),s=e.layer;let i=(0,a.Yn)(s);(!i||"Other"==i||this.hsLanguageService.getTranslation("LAYERMANAGER").other?.toLowerCase()===i.toLowerCase())&&(i="other",(0,a.SO)(s,i));const n=s.getZIndex();if(!r.has(i))return r.set(i,{layers:[e],zIndex:n,visible:!0}),r;const l=r.get(i);return l.layers.push(e),l.zIndex=Math.max(l.zIndex,n),r}cleanFolders(t,e){const r=new Map(t),s=e.layer;if(0==(0,a.lg)(s))return r;const i=(0,a.Yn)(s);if(!i)return console.warn(`Unexpected. Layer $${(0,a.LK)(s)} has no path defined`),r;const n=r.get(i);return n?(n.layers.splice(n.layers.indexOf(e),1),0===n.layers.length&&r.delete(i),r):(console.warn(`Unexpected. Layer $${(0,a.LK)(s)} belongs to path ${i} but it could not be found`),r)}sortFoldersByZ(t){return new Map([...t.entries()].sort((e,r)=>(e[1].zIndex<r[1].zIndex?-1:e[1].zIndex>r[1].zIndex?1:0)*(this.hsConfig.reverseLayerList??1?-1:1)))}static#e=this.\u0275fac=function(e){return new(e||c)(o.KVO(G.LJ),o.KVO(O.Q))};static#t=this.\u0275prov=o.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})();var k=h(70152),oe=h(18968),le=h(65623),ce=h(54100);let he=(()=>{class c{constructor(t,e,r,s,i,n,l){this.hsConfig=t,this.hsLog=e,this.zone=r,this.hsUtilsService=s,this.hsToastService=i,this.hsLanguageService=n,this.hsEventBusService=l}loadingEvents(t){const e=t.layer,r=(0,a.lg)(e);if((0,a.W1)(e)&&this.hsConfig.componentsEnabled.basemapGallery||void 0!==r&&1!=r)return;const s=e.get("cluster")?e.getSource().getSource():e.getSource();if(!s)return void this.hsLog.error(`Layer ${(0,a.LK)(e)} has no source`);const i={pending:0,total:0,loadError:0,loaded:!0,error:void 0,percents:0};t.loadProgress=i;const n=this.determineLayerType(e);if(!n)return;this.createLoadingProgressTimer(i,e);const l=this.subscribeToEventSubject(1,i,e),u=this.subscribeToEventSubject(-1,i,e);s.on(`${n}loadstart`,y=>{l.next(!0)}),s.on(`${n}loadend`,y=>{u.next(!0),i.error=!1}),s.on(`${n}loaderror`,y=>{this.loadError(i,e,this[`${n}LoadFailed`])})}determineLayerType(t){return this.hsUtilsService.instOf(t,N.A)?"features":this.hsUtilsService.instOf(t,le.A)?"image":this.hsUtilsService.instOf(t,ce.A)?"tile":void 0}loadError(t,e,r){t.loadError+=1,this.changeLoadCounter(e,t,-1),r&&r.bind(this)(t,e)}featuresLoadFailed(t,e){t&&(t.error=!0),this.hsToastService.createToastPopupMessage("LAYERS.featuresLoadError",`${(0,a.LK)(e)}: ${this.hsLanguageService.getTranslationIgnoreNonExisting("ADDLAYERS.ERROR","someErrorHappened",null)}`,{})}imageLoadFailed(t,e){t.loaded=!0,t.error=!0}tileLoadFailed(t,e){t.loadError==t.total&&(t.error=!0)}createLoadingProgressTimer(t,e){t.timer=new U.B,t.timer.pipe((0,k.B)(2e3),function ne(){return(0,C.N)((c,M)=>{let t,e=!1;c.subscribe((0,A._)(M,r=>{const s=t;t=r,e&&M.next([s,r]),e=!0}))})}()).subscribe(([r,s])=>{(0==t.pending||r===s&&0!=s)&&this.zone.run(()=>{t.total=0,0!=s&&(t.pending=0),t.percents=0,this.hsEventBusService.layerLoaded.next(e)})})}subscribeToEventSubject(t,e,r){const s=new U.B;return s.pipe((0,oe.r)(s.pipe((0,k.B)(100)))).subscribe(i=>{e.total+=1==t?i.length:0,this.changeLoadCounter(r,e,i.length*t)}),s}changeLoadCounter(t,e,r){e.pending+=r,e.loaded=0===e.pending;let s=0;e.total>0&&(s=Math.round((e.total-e.pending)/e.total*100)),this.zone.run(()=>{e.percents=100===s?0:s}),e.timer.next(e.pending),r>0&&this.hsEventBusService.layerLoading.next({layer:t,progress:e})}static#e=this.\u0275fac=function(e){return new(e||c)(o.KVO(O.Q),o.KVO(R.r),o.KVO(o.SKi),o.KVO(S.MJ),o.KVO(J.ST),o.KVO(G.LJ),o.KVO(H.z))};static#t=this.\u0275prov=o.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})();class ue{constructor(){this.layers=[],this.baselayers=[],this.terrainLayers=[]}}let ye=(()=>{class c{constructor(t,e,r,s,i,n,l,u,y,d,L,Le,ve,ge,Se,pe,me,be,xe,Oe,Ve){var v=this;this.hsConfig=t,this.hsDimensionTimeService=e,this.hsEventBusService=r,this.hsLanguageService=s,this.hsLayerEditorVectorLayerService=i,this.hsLayerManagerMetadata=n,this.hsLayerSelectorService=l,this.hsLayerUtilsService=u,this.hsLayoutService=y,this.hsLog=d,this.hsMapService=L,this.hsQueuesService=Le,this.hsAddDataOwsService=ve,this.hsShareUrlService=ge,this.hsToastService=Se,this.hsUtilsService=pe,this.sanitizer=me,this.hsLayerManagerUtilsService=be,this.hsLayerManagerVisibilityService=xe,this.folderService=Oe,this.hsLoadingProgressService=Ve,this.data=new ue,this.menuExpanded=!1,this.zIndexValue=0,this.hsLayerManagerVisibilityService.data=this.data,this.folderService.data=this.data,this.data.folders=(0,j.ot)(this.folderService.folderAction$.pipe(function D(c,M){return(0,C.N)(function F(c,M,t,e,r){return(s,i)=>{let n=t,l=M,u=0;s.subscribe((0,A._)(i,y=>{const d=u++;l=n?c(l,y,d):(n=!0,y),e&&i.next(l)},r&&(()=>{n&&i.next(l),i.complete()})))}}(c,M,arguments.length>=2,!0))}((x,p)=>this.folderService.foldersReducer(x,p),new Map),(0,P.u)())),this.hsEventBusService.layerManagerUpdates.subscribe(x=>{this.refreshLists()}),this.hsEventBusService.layerDimensionDefinitionChanges.subscribe(x=>{if(this.hsDimensionTimeService.layerIsWmsT(x)){const p=this.data.layers.find(T=>T.layer==x);p&&this.hsDimensionTimeService.setupTimeLayer(p)}}),this.hsMapService.loaded().then(function(){var x=(0,f.A)(function*(p){for(const T of p.getLayers().getArray())v.applyZIndex(T),yield v.layerAdded({element:T},!0);v.folderService.folderAction$.next(v.folderService.sortByZ()),v.sortLayersByZ(v.data.layers),v.hsEventBusService.layerManagerUpdates.next(null),v.toggleEditLayerByUrlParam(),v.boxLayersInit(),v.setupMapEventHandlers(p)});return function(p){return x.apply(this,arguments)}}())}destroy(){for(const t of this.mapEventHandlers)(0,m.e)(t)}setupMapEventHandlers(t){const e=t.getLayers().on("add",i=>{this.applyZIndex(i.element,!(0,a.Ko)(i.element)),0!=(0,a.lg)(i.element)&&this.layerAdded(i,(0,a.IN)(i.element))}),r=t.getLayers().on("remove",i=>this.layerRemoved(i)),s=t.getView().on("change:resolution",this.hsUtilsService.debounce(i=>this.resolutionChangeDebounceCallback(),200,!1,this));this.mapEventHandlers=[e,r,s],this.hsEventBusService.mapEventHandlersSet.next()}layerAdded(t,e){var r=this;return(0,f.A)(function*(){const s=t.element;r.hsLayerManagerUtilsService.checkLayerHealth(s);const i=(0,a.lg)(s)??!0;s.on("change:visible",l=>r.hsLayerManagerVisibilityService.layerVisibilityChanged(l)),r.hsLayerUtilsService.isLayerVectorLayer(s)&&(0,a.dB)(s)&&(r.hsLayerEditorVectorLayerService.layersClusteredFromStart.push(s),yield r.hsLayerEditorVectorLayerService.cluster(!0,s,r.hsConfig.clusteringDistance||40,!1));const n={title:r.hsLayerUtilsService.getLayerTitle(s),abstract:(0,a.lQ)(s),layer:s,grayed:!r.hsLayerManagerVisibilityService.isLayerInResolutionInterval(s),visible:s.getVisible(),showInLayerManager:i,uid:r.hsUtilsService.generateUuid(),idString(){return"layer"+(this.coded_path||"")+(this.uid||"")},type:yield r.hsLayerManagerUtilsService.getLayerSourceType(s),source:r.hsLayerManagerUtilsService.getLayerSourceUrl(s)};if(r.hsLoadingProgressService.loadingEvents(n),n.trackBy=`${n.uid} ${n.position}`,s.on("propertychange",l=>{"title"==l.key&&(n.title=r.hsLayerUtilsService.getLayerTitle(s)),l.key==a.uu&&(n.showInLayerManager=(0,a.lg)(s)??!0,n.showInLayerManager&&r.folderService.folderAction$.next(r.folderService.addLayer(n)))}),!0!==(0,a.W1)(s)){if(i&&r.folderService.folderAction$.next(r.folderService.addLayer(n)),n.legends=(0,a.pL)(s),r.data.layers.push(n),(0,a.vx)(s)){const l=r.hsLayerUtilsService.getLayerParams(s);l?.LAYERS&&(0,a.SG)(s,l.LAYERS)}!1!==(0,a.Jt)(s)&&r.hsQueuesService.ensureQueue("wmsGetCapabilities",1,1e4).push(function(){var u=(0,f.A)(function*(y){try{yield r.hsLayerManagerMetadata.fillMetadata(n),n.grayed=!r.hsLayerManagerVisibilityService.isLayerInResolutionInterval(s),y()}catch(d){y(d)}});return function(y){return u.apply(this,arguments)}}())}else n.active=s.getVisible(),n.active&&r.hsLayerManagerVisibilityService.changeBaseLayerVisibility(!0,n),n.thumbnail=r.hsLayerManagerUtilsService.getImage(s),r.data.baselayers.push(n),(0,a.y9)(s)&&!(0,a.rG)(s)&&setTimeout(()=>{r.setGreyscale(n)},100);(0,a.mG)(s)||(0,a.RO)(s,(0,a.LK)(s)),r.folderService.folderAction$.next(r.folderService.sortByZ()),e||(r.hsEventBusService.layerAdditions.next(n),r.hsEventBusService.layerManagerUpdates.next(s),r.hsEventBusService.compositionEdits.next())})()}updateLayerListPositions(){this.data.layers=this.sortLayersByZ(this.data.layers)}sortLayersByZ(t){const e=this.hsConfig.reverseLayerList??!0;return t.sort((r,s)=>((r=r.layer.getZIndex())<(s=s.layer.getZIndex())?-1:r>s?1:0)*(e?-1:1))}refreshLists(){this.data.baselayers=Array.from(this.data.baselayers),this.data.terrainLayers=Array.from(this.data.terrainLayers)}getLayerByTitle(t){let e;for(const r of this.data.layers)r.title==t&&(e=r);return e}getLayerDescriptorForOlLayer(t,e=!1){const s=this.data[e?"baselayers":"layers"].filter(i=>i.layer==t);if(s.length>0)return s[0]}layerRemoved(t){this.folderService.folderAction$.next(this.folderService.removeLayer(this.getLayerDescriptorForOlLayer(t.element)));for(let r=0;r<this.data.layers.length;r++)this.data.layers[r].layer==t.element&&this.data.layers.splice(r,1);for(let r=0;r<this.data.baselayers.length;r++)this.data.baselayers[r].layer==t.element&&this.data.baselayers.splice(r,1);this.removeFromArray(this.hsLayerEditorVectorLayerService.layersClusteredFromStart,t.element),this.hsEventBusService.layerManagerUpdates.next(t.element),this.hsEventBusService.layerRemovals.next(t.element),!1!==(0,a.lg)(t.element)&&this.hsEventBusService.compositionEdits.next();const e=this.hsMapService.getMap().getLayers().getArray();this.zIndexValue>e.length&&this.zIndexValue--}removeFromArray(t,e){for(let r=0;r<t.length;r++)t[r]==e&&t.splice(r,1)}boxLayersInit(){if(null!=this.hsConfig.box_layers){this.data.box_layers=this.hsConfig.box_layers;for(const t of this.data.box_layers){let e=!1,r=!1;for(const s of t.get("layers").getArray())1==s.get("visible")&&1==(0,a.W1)(s)?r=!0:1==s.get("visible")&&(e=!0);t.thumbnail=(0,a.Eb)(t),(0,a.Fm)(t,r||e)}}}activateTheme(t){let e=!0;1==(0,a.FQ)(t)&&(e=!1),(0,a.Fm)(t,e);let r=!1;t.setVisible(e);for(const s of t.get("layers"))if(1!=(0,a.W1)(s)||r){if(1==(0,a.W1)(s))return;s.setVisible(e)}else this.hsLayerManagerVisibilityService.changeBaseLayerVisibility(null,null),r=!0}toggleLayerEditor(t,e,r){(0,a.jA)(t.layer)||this.hsLayerManagerMetadata.fillMetadata(t),("sublayers"!=e||1==t.hasSublayers)&&(this.hsLayerSelectorService.currentLayer!=t?(this.toggleCurrentLayer(t),this.menuExpanded&&(this.menuExpanded=!1),t[e]=!0):(t[e]=!t[e],t[r]||this.toggleCurrentLayer(t)))}toggleCurrentLayer(t){if(this.hsLayerSelectorService.currentLayer!==t)return this.setCurrentLayer(t),!1;t.sublayers=!1,t.settings=!1,this.hsLayerSelectorService.select(null),this.updateGetParam(void 0)}setCurrentLayer(t){try{return this.updateGetParam(t.title),t.checkedSubLayers||(t.checkedSubLayers={},t.withChildren={}),this.hsLayerSelectorService.select(t),!1}catch(e){this.hsLog.error(e)}}updateGetParam(t){const e={};e[g.Rv.layerSelected]=t,this.hsShareUrlService.updateCustomParams(e)}setGreyscale(t){const e=this.hsLayoutService.contentWrapper.querySelector(".ol-layers > div:first-child");e.classList.contains("hs-greyscale")?(e.classList.remove("hs-greyscale"),(0,a.K1)(t.layer,!1)):(e.classList.add("hs-greyscale"),(0,a.K1)(t.layer,!0)),setTimeout(()=>{t.layer.getSource().changed(),t.galleryMiniMenu=!1},0)}resolutionChangeDebounceCallback(){setTimeout(()=>{for(let t=0;t<this.data.layers.length;t++){const e=!this.hsLayerManagerVisibilityService.isLayerInResolutionInterval(this.data.layers[t].layer);this.data.layers[t].grayed!=e&&(this.data.layers[t].grayed=e)}this.timer=null},250)}toggleEditLayerByUrlParam(){const t=this.hsShareUrlService.getParamValue(g.Rv.layerSelected);null!=t&&setTimeout(()=>{const e=this.data.layers.find(r=>r.title==t);void 0!==e&&(this.toggleLayerEditor(e,"settings","sublayers"),this.hsEventBusService.layerSelectedFromUrl.next(e.layer))},500)}setPathMaxZIndex(t){let e;if((0,a.W1)(t))e=this.data.baselayers;else{let r=(0,a.Yn)(t);r=r??"other",e=this.data.layers.filter(s=>(0,a.Yn)(s.layer)==r)}if(e.length>0){const r=Math.max(...e.map(s=>s.layer.getZIndex()||0));t.setZIndex(r+1);for(const s of this.data.layers.filter(i=>i.layer.getZIndex()>=t.getZIndex()))s.layer.setZIndex(s.layer.getZIndex()+1)}}applyZIndex(t,e){e&&!1!==(0,a.lg)(t)&&this.setPathMaxZIndex(t),null==t.getZIndex()?t.setZIndex(this.zIndexValue++):this.zIndexValue++}makeSafeAndTranslate(t,e){const r=this.hsLanguageService.getTranslationIgnoreNonExisting(t,e,void 0);return r?this.sanitizer.bypassSecurityTrustHtml(r):""}static#e=this.\u0275fac=function(e){return new(e||c)(o.KVO(O.Q),o.KVO(V.C6),o.KVO(H.z),o.KVO(G.LJ),o.KVO(Y),o.KVO($),o.KVO(K),o.KVO(S.Xp),o.KVO(re.F),o.KVO(R.r),o.KVO(E.F),o.KVO(se.x),o.KVO(I.Dn),o.KVO(g.JX),o.KVO(J.ST),o.KVO(S.MJ),o.KVO(ie.up),o.KVO(w),o.KVO(X),o.KVO(Q),o.KVO(he))};static#t=this.\u0275prov=o.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})();var de=h(35901);let fe=(()=>{class c{constructor(t,e,r,s,i){this.hsLayerSelectorService=t,this.hsLayerUtilsService=e,this.hsMapService=r,this.hsAddDataOwsService=s,this.hsLayerManagerUtilsService=i}copyLayer(t){var e=this;return(0,f.A)(function*(){const r=e.createCopyTitle(t),s=e.hsLayerSelectorService.currentLayer.layer;if(e.hsLayerUtilsService.isLayerVectorLayer(s))e.copyVectorLayer(r);else{const i=e.hsLayerUtilsService.getURL(s);let n=(0,a.jA)(s)?.Name;(!n||"number"==typeof n)&&(n=(0,a.mG)(s));const l=yield e.hsLayerManagerUtilsService.getLayerSourceType(s),u=yield e.hsAddDataOwsService.connectToOWS({type:l.toLowerCase(),uri:i,layer:n,getOnly:!0});if(u[0]){u[0].setProperties(s.getProperties()),(0,a.D6)(u[0],r);const y=e.hsLayerUtilsService.getLayerParams(s)?.LAYERS;y&&(0,a.P3)(u[0],y),e.hsLayerUtilsService.updateLayerParams(u[0],e.hsLayerUtilsService.getLayerParams(s)),e.hsLayerUtilsService.updateLayerParams(u[0],{STYLES:null,LAYERS:(0,a.eg)(s)}),e.hsMapService.getMap().addLayer(u[0])}}})()}copyVectorLayer(t){let e;const r=this.hsLayerSelectorService.currentLayer.layer;e=this.hsLayerUtilsService.isLayerClustered(r)?r.getSource().getSource()?.getFeatures():r.getSource()?.getFeatures();const s=new N.A({properties:r.getProperties(),source:new de.A({features:e}),style:r.getStyle()});(0,a.D6)(s,t),(0,a.RO)(s,(0,a.mG)(r)),this.hsMapService.addLayer(s)}createCopyTitle(t){const e=(0,a.mG)(this.hsLayerSelectorService.currentLayer.layer);let r=(0,a.LK)(this.hsLayerSelectorService.currentLayer.layer),s=0;if(t&&t!==r)r=t;else{const i=this.hsMapService.getLayersArray().filter(n=>(0,a.mG)(n)==e);s=void 0!==i?i.length:0,r=r.replace(/\([0-9]\)/g,"").trimEnd(),r+=` (${s})`}return r}static#e=this.\u0275fac=function(e){return new(e||c)(o.KVO(K),o.KVO(S.Xp),o.KVO(E.F),o.KVO(I.Dn),o.KVO(w))};static#t=this.\u0275prov=o.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})()},18968:(q,B,h)=>{h.d(B,{r:()=>D});var f=h(39974),C=h(85343),A=h(54360),F=h(58750);function D(P){return(0,f.N)((j,m)=>{let g=[];return j.subscribe((0,A._)(m,a=>g.push(a),()=>{m.next(g),m.complete()})),(0,F.Tg)(P).subscribe((0,A._)(m,()=>{const a=g;g=[],m.next(a)},C.l)),()=>{g=null}})}}}]);
//# sourceMappingURL=default-projects_hslayers_services_layer-manager_index_ts.js.map