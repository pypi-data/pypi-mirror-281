"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[3717],{44494:(e,t,a)=>{var n=a(86326),i=a(94900),r=a(29079),l=a(97598),s=a.n(l),c=a(42430),m=a(87597),d=a(47279),o=a(52379),u=a(6423),g=a(49138),p=a(56237),y=a(57427),v=a(45423),f=a(89152),h=a(63173),E=a(59865),D=a(96478),b=a(49528);var A=a(24372),_=a(60638),w=a(43057),T=a(92117),C=a(6841),I=a(54219),S=a(25838);const k=["template"],P=r.Ay.bind(null,{endpoint:"receipts.generate_receipts",rules:[{args:["event_id","template_id"],converters:{event_id:"IntegerConverter",template_id:"IntegerConverter"},defaults:{},trace:[{data:"|",isDynamic:!1},{data:"/",isDynamic:!1},{data:"event",isDynamic:!1},{data:"/",isDynamic:!1},{data:"event_id",isDynamic:!0},{data:"/",isDynamic:!1},{data:"manage",isDynamic:!1},{data:"/",isDynamic:!1},{data:"receipts",isDynamic:!1},{data:"/",isDynamic:!1},{data:"template_id",isDynamic:!0},{data:"/",isDynamic:!1},{data:"generate",isDynamic:!1}]}]},"/");function F(e){let{onRetry:t,onClose:a,errors:i}=e;const[r,l]=(0,n.useState)(!0);return n.createElement(T.A,{open:r,onClose:a,closeIcon:!0},n.createElement(T.A.Header,null,n.createElement(D.Translate,null,"Templating Errors")),n.createElement(T.A.Content,null,n.createElement(m.A,{error:!0},n.createElement(D.Translate,null,"There were some errors while trying to generate your documents.")),n.createElement(C.A,{celled:!0,fixed:!0},n.createElement(C.A.Header,null,n.createElement(C.A.Row,null,n.createElement(C.A.HeaderCell,null,n.createElement(D.Translate,null,"Registrant's name")),n.createElement(C.A.HeaderCell,null,n.createElement(D.Translate,null,"Missing fields")))),n.createElement(C.A.Body,null,i.map((e=>{let{registration:t,undefineds:a}=e;return n.createElement(C.A.Row,{key:t.id},n.createElement(C.A.Cell,null,t.fullName),n.createElement(C.A.Cell,null,a.map((e=>n.createElement(I.A,{key:`${t.id}-${e}`,color:"red"},e)))))}))))),n.createElement(T.A.Actions,null,n.createElement(S.A,null,n.createElement(p.A,{onClick:async()=>{await t(),l(!1),a()},primary:!0},n.createElement(d.A,{name:"sync"}),n.createElement(D.Translate,null,"Generate anyway")),n.createElement(p.A,{onClick:()=>{l(!1),a()}},n.createElement(D.Translate,null,"Cancel")))))}F.propTypes={onRetry:s().func.isRequired,onClose:s().func.isRequired,errors:s().arrayOf(s().shape({registration:s().shape({firstName:s().string,lastName:s().string}),undefineds:s().arrayOf(s().string)})).isRequired};var R=a(62120);const O=r.Ay.bind(null,{endpoint:"receipts.all_templates",rules:[{args:["event_id"],converters:{event_id:"IntegerConverter"},defaults:{},trace:[{data:"|",isDynamic:!1},{data:"/",isDynamic:!1},{data:"event",isDynamic:!1},{data:"/",isDynamic:!1},{data:"event_id",isDynamic:!0},{data:"/",isDynamic:!1},{data:"manage",isDynamic:!1},{data:"/",isDynamic:!1},{data:"receipts",isDynamic:!1},{data:"/",isDynamic:!1},{data:"templates",isDynamic:!1}]}]},"/"),x=r.Ay.bind(null,{endpoint:"receipts.images",rules:[{args:["event_id"],converters:{event_id:"IntegerConverter"},defaults:{},trace:[{data:"|",isDynamic:!1},{data:"/",isDynamic:!1},{data:"event",isDynamic:!1},{data:"/",isDynamic:!1},{data:"event_id",isDynamic:!0},{data:"/",isDynamic:!1},{data:"manage",isDynamic:!1},{data:"/",isDynamic:!1},{data:"receipts",isDynamic:!1},{data:"/",isDynamic:!1},{data:"images",isDynamic:!1}]}]},"/"),z=r.Ay.bind(null,{endpoint:"receipts.receipts_export",rules:[{args:["event_id","format"],converters:{event_id:"IntegerConverter",format:"AnyConverter"},defaults:{},trace:[{data:"|",isDynamic:!1},{data:"/",isDynamic:!1},{data:"event",isDynamic:!1},{data:"/",isDynamic:!1},{data:"event_id",isDynamic:!0},{data:"/",isDynamic:!1},{data:"manage",isDynamic:!1},{data:"/",isDynamic:!1},{data:"receipts",isDynamic:!1},{data:"/",isDynamic:!1},{data:"export",isDynamic:!1},{data:"/",isDynamic:!1},{data:"receipts.",isDynamic:!1},{data:"format",isDynamic:!0}]}]},"/"),q=r.Ay.bind(null,{endpoint:"receipts.receipts_preview",rules:[{args:["event_id","template_id"],converters:{event_id:"IntegerConverter",template_id:"IntegerConverter"},defaults:{},trace:[{data:"|",isDynamic:!1},{data:"/",isDynamic:!1},{data:"event",isDynamic:!1},{data:"/",isDynamic:!1},{data:"event_id",isDynamic:!0},{data:"/",isDynamic:!1},{data:"manage",isDynamic:!1},{data:"/",isDynamic:!1},{data:"receipts",isDynamic:!1},{data:"/",isDynamic:!1},{data:"template_id",isDynamic:!0},{data:"/",isDynamic:!1},{data:"preview",isDynamic:!1}]}]},"/"),K=(e,t)=>{let{publish:a,notify_users:n}=e;return a?n?D.PluralTranslate.string("Publish and send to registrant","Publish and send to registrants",t):D.PluralTranslate.string("Save and publish to registration","Save and publish to registrations",t):n?D.PluralTranslate.string("Save and send to registrant","Save and send to registrants",t):D.PluralTranslate.string("Save to registration","Save to registrations",t)},L=[{key:"pdf",value:"pdf",text:D.Translate.string("as a single PDF document")},{key:"zip",value:"zip",text:D.Translate.string("as a ZIP archive")}],B={pdf:"documents.pdf",zip:"documents.zip"};function N(e){let{onClose:t,registrationIds:a,eventId:r}=e;const[l,s]=(0,n.useState)([]),[T,C]=(0,n.useState)(!1),{data:I,loading:S}=(0,E.Ku)(O({event_id:r}),{trigger:r,camelize:!0}),N=!S&&!!I,j=async e=>{C(!0);try{const{data:t}=await b.indicoAxios.post(z((0,A.snakifyKeys)({eventId:r,format:e})),(0,A.snakifyKeys)({receiptIds:l}),{responseType:"blob"});!function(e,t){const a=new Blob([t]),n=document.createElement("a"),i=URL.createObjectURL(a);n.href=i,n.download=e,document.body.append(n),n.click(),n.remove(),URL.revokeObjectURL(i)}(B[e],t)}catch(e){(0,b.handleAxiosError)(e)}C(!1)};return n.createElement(h.Sz,{id:"print-receipts",size:"large",onSubmit:async e=>{const{receiptIds:t,error:l}=await async function(e,t,a){const r=async(t,n)=>{const{template:i}=a,r=(0,w.A)(a,k);return r.registration_ids=t,r.force=n,(await b.indicoAxios.post(P((0,A.snakifyKeys)({eventId:e,templateId:i})),r)).data};try{const e=await r(t,!1);let a=e.receipt_ids;return e.errors.length&&await new Promise((t=>{(0,i.injectModal)((i=>n.createElement(F,{onRetry:async()=>{const t=await r([...new Set(e.errors.map((e=>e.registration.id)))],!0);a=[...a,...t.receipt_ids]},onClose:()=>{t(),i()},errors:(0,A.camelizeKeys)(e.errors)})))})),{receiptIds:a,error:null}}catch(e){return{receiptIds:null,error:(0,f.handleSubmitError)(e)}}}(r,a,e);if(l)return l;t.length>0&&s(t)},initialValues:{custom_fields:{},document_type:"none",filename:"document",save_config:!0},onClose:()=>t(l.length>0),header:D.Translate.string("Generate Documents"),keepDirtyOnReinitialize:!0,noSubmitButton:!0,disabledAfterSubmit:!0},(e=>{return n.createElement(n.Fragment,null,n.createElement(m.A,{color:0===l.length?"teal":"green"},n.createElement(d.A,{name:"print",size:"big"}),0===l.length?n.createElement(D.PluralTranslate,{count:a.length},n.createElement(D.Singular,null,"Generating document for a single registrant"),n.createElement(D.Plural,null,"Generating documents for"," ",n.createElement(D.Param,{name:"numberOfRegistrants",value:a.length,wrapper:n.createElement("strong",null)})," ","registrants")):n.createElement(D.PluralTranslate,{count:l.length},n.createElement(D.Singular,null,"Successfully generated document for a single registrant"),n.createElement(D.Plural,null,"Successfully generated"," ",n.createElement(D.Param,{name:"numberOfReceipts",value:l.length,wrapper:n.createElement("strong",null)})," ","documents"))),n.createElement(o.A,{columns:2,divided:!0},n.createElement(o.A.Column,null,n.createElement(f.FinalDropdown,{name:"template",loading:!N,label:D.Translate.string("Document Template"),placeholder:D.Translate.string("Select a document template"),options:N?I.map((e=>{let{id:t,title:a}=e;return{key:t,text:a,value:t}})):[],onChange:(t=e.form,e=>{const{customFields:a,defaultFilename:n,title:i}=I.find((t=>t.id===e));t.change("custom_fields",a?Object.assign({},...a.map((e=>({[e.name]:(0,R.D)(e)})))):{}),t.change("filename",n||f.formatters.slugify(i))}),disabled:l.length>0,required:!0,selection:!0}),n.createElement(c.Field,{name:"template",subscription:{value:!0}},(e=>{let{input:{value:t}}=e;return n.createElement(f.FinalField,{name:"custom_fields",component:R.A,customFields:t?(a=t,N&&(null===(i=I.find((e=>e.id===a)))||void 0===i?void 0:i.customFields)):[],title:D.Translate.string("Template Parameters"),disabled:l.length>0,fetchImagesURL:x({event_id:r}),defaultOpen:!0});var a,i})),n.createElement(c.Field,{name:"template",subscription:{value:!0}},(e=>{let{input:{value:t}}=e;return n.createElement(f.FinalInput,{name:"filename",label:D.Translate.string("Filename"),type:"text",componentLabel:"-{n}.pdf",labelPosition:"right",disabled:!t||l.length>0,format:e=>f.formatters.slugify(e).replace(/\.pdf$/,""),formatOnBlur:!0,required:!0,fluid:!0})})),n.createElement(f.FinalCheckbox,{name:"save_config",label:D.Translate.string("Remember settings"),description:D.Translate.string("Prefill template parameters (if present) and filename when generating more documents for the same template in this event."),disabled:l.length>0}),n.createElement(f.FinalCheckbox,{name:"publish",label:D.Translate.string("Publish document"),description:D.PluralTranslate.string("Make the resulting document available on the registration page.","Make the resulting documents available on the registration pages.",a.length),disabled:l.length>0}),n.createElement(c.Field,{name:"publish",subscription:{value:!0}},(e=>{let{input:{value:t}}=e;return n.createElement(f.FinalCheckbox,{name:"notify_users",label:D.PluralTranslate.string("Notify registrants via e-mail","Notify registrants via e-mail",a.length),description:t?D.PluralTranslate.string("Send an e-mail to the registrant informing them that the document is available.","Send an e-mail to the registrants informing them that the document is available.",a.length):D.PluralTranslate.string("Send an e-mail to the registrant with the document attached.","Send an e-mail to the registrants with the document attached.",a.length),disabled:l.length>0})})),n.createElement(u.A.Group,{style:{alignItems:"center"}},n.createElement(c.FormSpy,{subscription:{values:!0}},(e=>{let{values:t}=e;return n.createElement(f.FinalSubmitButton,{label:K(t,a.length),icon:t.notify_users?"send":"save",style:{width:"100%"},disabledAfterSubmit:!0,fluid:!0})})),l.length>0&&n.createElement(n.Fragment,null,n.createElement(d.A,{name:"check",color:"green",size:"large"}),n.createElement(g.A,{options:L,scrolling:!0,icon:null,value:null,selectOnBlur:!1,selectOnNavigation:!1,onChange:(e,t)=>{let{value:a}=t;return j(a)},trigger:n.createElement(p.A,{icon:!0,style:{whiteSpace:"nowrap",marginLeft:"1em"},type:"button",loading:T},n.createElement(d.A,{name:"download"})," ",n.createElement(D.Translate,null,"Download")," ",n.createElement(d.A,{name:"caret down"}))})))),n.createElement(o.A.Column,null,n.createElement(c.Field,{name:"template",subscription:{value:!0}},(e=>{let{input:{value:t}}=e;return n.createElement(c.Field,{name:"custom_fields",subscription:{value:!0}},(e=>{let{input:{value:i}}=e;return t?n.createElement(_.A,{url:q((0,A.snakifyKeys)({eventId:r,templateId:t})),data:(0,A.snakifyKeys)({customFields:i,registrationIds:a})}):n.createElement(y.A,{placeholder:!0},n.createElement(v.A,{icon:!0},n.createElement(d.A,{name:"eye"}),n.createElement(D.Translate,null,"Please select a template to preview it...")))}))})))));var t}))}N.propTypes={onClose:s().func.isRequired,registrationIds:s().arrayOf(s().string).isRequired,eventId:s().number.isRequired},window.printReceipts=function(e){let{registration_id:t,event_id:a,reload_after:r}=e;(0,i.injectModal)((e=>n.createElement(N,{onClose:t=>{t&&r?location.reload():e()},registrationIds:t,eventId:a})))}}},e=>{e.O(0,[4644,4394,2076],(()=>{return t=44494,e(e.s=t);var t}));e.O()}]);
//# sourceMappingURL=module_receipts.c0603833.bundle.js.map