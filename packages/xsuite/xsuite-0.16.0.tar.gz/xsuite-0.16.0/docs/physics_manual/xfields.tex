\chapter{Xfields}


\section{Fields generated by a bunch of particles}



We assume that the bunch travels rigidly along $s$ with velocity $\beta_0 c$:
\begin{align}
&\rho\left(x, y, s, t\right) = \rho_0\left(x, y, s - \beta_0 ct\right) \label{rhorho0}\\
&\textbf{J}\left(x, y, s, t\right) = \beta_0c\, \rho_0\left(x, y, s - \beta_0 ct\right)  \hat{\textbf{i}}_s \label{JJ0}
\end{align}

We define an auxiliary variable $\zeta$ as the position along the bunch:
\begin{equation}
\zeta = s -\beta_0 c t \, .\label{zetadef}
\end{equation}
We call $K$ the lab reference frame in which we have defined all equations above, and we introduce a boosted frame $K'$ moving rigidly with the reference particle.
The coordinates in the two systems are related by a Lorentz transformation~\cite{jackson}:
\begin{align}
ct' &= \gamma_0 \left(ct -\beta_0 s \right)\label{lorA}\\
x' &= x\label{lorX}\\
y' &= y\label{lorY}\\
s' &= \gamma_0 \left(s -\beta_0 ct \right) = \gamma_0 \zeta\label{lorB}
\end{align}
The  corresponding inverse transformation is:
\begin{align}
ct &= \gamma_0 \left(ct' +\beta_0 s' \right)\label{lorC}\\
x &= x'\label{lorXinv}\\
y &= y'\label{lorYinv}\\
s &= \gamma_0 \left(s' +\beta_0 ct' \right)\label{lorD}
\end{align}



The quantities $\left(c \rho, J_x, J_y, J_s\right)$ form a Lorentz 4-vector and therefore they are transformed between $K$ and $K'$ by relationships similar to the Eqs.~\ref{lorA}-\ref{lorY}~\cite{jackson}:
\begin{align}
c\rho' \left(\textbf{r'}, t'\right)\ &= \gamma_0 \left[c \rho  \left(\textbf{r}\left(\textbf{r'}, t'\right), t\left(\textbf{r'}, t'\right)\right) -\beta_0 J_s \left(\textbf{r}\left(\textbf{r'}, t'\right), t\left(\textbf{r'}, t'\right)\right) \right]\label{lorrho}\\
J_s' \left(\textbf{r'}, t'\right)\ &= \gamma_0 \left[J_s  \left(\textbf{r}\left(\textbf{r'}, t'\right), t\left(\textbf{r'}, t'\right)\right) -\beta_0 c \rho \left(\textbf{r}\left(\textbf{r'}, t'\right), t\left(\textbf{r'}, t'\right)\right) \right]\label{lorjs}
\end{align}
where the transformations $\textbf{r}\left(\textbf{r'}, t'\right)$ and $t\left(\textbf{r'}, t'\right)$ are defined by Eqs.~\ref{lorC} and~\ref{lorD} respectively. The transverse components $J_x$ and $J_y$ of the current vector are invariant for our transformation, and are anyhow zero in our case.

Using Eq.\,\ref{JJ0} these become:
\begin{align}
\rho' \left(\textbf{r'}, t'\right)\ &= \frac{1}{\gamma_0}\rho\left(\textbf{r}\left(\textbf{r'}, t'\right), t\left(\textbf{r'}, t'\right)\right)
\\
J_s' \left(\textbf{r'}, t'\right)\ & = 0
\end{align}

Using Eqs.~\ref{rhorho0} and~\ref{lorC}-\ref{lorYinv}, we obtain:
\begin{equation}
\rho  \left(x', y', s(s', t'), t(s', t')\right) = \rho_0  \left(x', y', s(s', t') - \beta_0 c\,t(s', t')\right)
\end{equation}

From Eq.~\ref{lorB} we get:
\begin{equation}
s(s', t')- \beta_0 c\,t(s', t') = \frac{s'}{\gamma_0} 
\end{equation}
where the coordinate $t' $ has disappeared.

We can therefore write:
\begin{equation}
\rho' \left(x', y', s', t'\right) =   \frac{1}{\gamma_0} \rho_0  \left(x', y',  \frac{s'}{\gamma_0}\right)\label{rhoprimerho0}
\end{equation}

The electric potential in the bunch frame is solution of Poisson's equation:

\begin{equation}
\frac{\partial^2 \phi'}{\partial x'^2} +  \frac{\partial^2 \phi'}{\partial y'^2}+  \frac{\partial^2 \phi'}{\partial s'^2}= -\frac{\rho' (x', y', s')}{\varepsilon_0}
\end{equation}

From Eq.~\ref{rhoprimerho0} we can write:
\begin{equation}
\frac{\partial^2 \phi'}{\partial x'^2} +  \frac{\partial^2 \phi'}{\partial y'^2}+  \frac{\partial^2 \phi'}{\partial s'^2}= -\frac{1}{\gamma_0\varepsilon_0}  \rho_0 \left(x', y', \frac{s'}{\gamma_0}\right)\label{poissrho0}
\end{equation}

We now make the substitution:
\begin{equation}
\zeta = \frac{s'}{\gamma_0} \label{subst}
\end{equation}
obtained from Eq.~\ref{lorB}, which allows to rewrite Eq.~\ref{poissrho0} as:
\begin{equation}
\frac{\partial^2 \phi'}{\partial x^2} +  \frac{\partial^2 \phi'}{\partial y^2}+  \frac{1}{\gamma_0^2}\frac{\partial^2 \phi'}{\partial \zeta^2}=  -\frac{1}{\gamma_0\varepsilon_0}{\rho}_0 \left(x, y,\zeta\right) \label{modifpoiss}
\end{equation}
Here we have dropped the ``$'$'' sign from $x$ and $y$ as these coordinates are unaffected by the Lorentz boost.




The quantities $\left( \frac{\phi}{c}, A_x, A_y, A_s\right)$ form a Lorentz 4-vector, so we can write:
\begin{align}
\phi &= \gamma_0 \left( {\phi'} +  \beta_0 c A'_s\right)\\
A_s &= A'_s +\beta_0 \frac{\phi'}{c}
\end{align}
In the bunch frame the charges are at rest therefore $A'_x=A'_y=A'_s=0$ therefore:
\begin{align}
\phi &= \gamma_0 \phi'\label{phiphip}\\
A_s &= \beta_0 \frac{\phi'}{c} =  \frac{\beta_0}{\gamma_0c}\phi
\end{align}

Combining Eq.\,\ref{phiphip} with Eq.\,\ref{modifpoiss} we obtain the equation in $\phi$:
\begin{equation}
\boxed{
\frac{\partial^2 \phi}{\partial x^2} +  \frac{\partial^2 \phi}{\partial y^2}+  \frac{1}{\gamma_0^2}\frac{\partial^2 \phi}{\partial \zeta^2}=  -\frac{1}{\varepsilon_0}{\rho}_0 \left(x, y,\zeta\right)} \label{modifpoiss_zeta}
\end{equation}

\subsection{2.5D approximation}
For large enough values of $\gamma_0$, Eq.~\ref{modifpoiss} can be approximated by:
\begin{equation}
\boxed{
\frac{\partial^2 \phi}{\partial x^2} +  \frac{\partial^2 \phi}{\partial y^2} = -\frac{1}{\varepsilon_0}{\rho}_0 \left(x, y,\zeta\right) }\label{2dpoiss}
\end{equation}
which means that we can solve a simple 2D problem for each beam slice (identified by its coordinate $\zeta$).


\subsection{Modulated 2D}
\label{sec:modulated2d}

Often the beam distribution can be factorized as:
\begin{equation}
\rho_0(x,y,\zeta) = q_0\lambda_0(\zeta)\rho_\perp(x,y) 
\end{equation}
where:
\begin{equation}
\int \rho_\perp(x,y) \,dx\,dy = 1
\end{equation}
and $\lambda_0(z)$ is therefore the bunch line density.

For a bunched beam:
\begin{equation}
\int \lambda_0(z) \,dz = N \label{eq:lamnorm}\\
\end{equation}
where $N$ is the bunch population.

In this case the potential can be factorized as:
\begin{equation}
\phi(x,y,\zeta) = q_0\lambda(\zeta)\phi_\perp(x,y) 
\label{eq:factorized2d}
\end{equation}

where $\phi_\perp(x,y)$ is the solution of the following 2D Poisson equation:
\begin{equation}
\frac{\partial^2 \phi_\perp}{\partial x^2} +  \frac{\partial^2 \phi_\perp}{\partial y^2} = -\frac{1}{\varepsilon_0}{\rho}_\perp \left(x, y\right) \label{2dpoisspeerp}
\end{equation}

%\section{Interaction time}
%In the lab frame the particle moves with speed $\beta$:
%\begin{equation}
%s(t) = \zeta_p +\beta c t
%\end{equation}
%
%In the frame $K'$, the kinematic equation of the particle can be obtained by replacing Eqs.~\ref{lorC} and~\ref{lorD} into Eq.~\ref{st_tau}:
%\begin{equation}
%\gamma_0 \left(s' +\beta_0 ct' \right) = \zeta_p +\beta \gamma_0 \left(ct' +\beta_0 s' \right)
%\end{equation}
%
%Solving for $s'$ we obtain:
%\begin{equation}
%s' = -\beta \gamma c \tau = \gamma \zeta\label{sprimezeta}
%\end{equation}
%Of course for the reference particle we obtain $s' = 0$.
%We observe that \textbf{beam particles are at rest in the reference frame $K'$ and that the distance between them is increased by a factor $\gamma$ with respect to the lab frame $K$}.

%\section{Transverse kick on the beam particle}
%
%We now evaluate the change on the transverse momentum for a beam particle defined in the lab frame by its transverse coordinates $x$ and $y$ and by its delay $\tau$ with respect to the reference particle (or equivalently by its $\zeta$ coordinate, defined by Eq.~\ref{zetadef}).
%
%We have seen that in the frame $K'$ the particle is at rest and has longitudinal coordinate $s' = \gamma \zeta$ (see Eq.~\ref{sprimezeta}). 
%The x' component of the electric field $\textbf{E}'$ acting on P is given by (see Eqs.~\ref{potential} and~\ref{phiphiprime}):
%\begin{equation}
%E'_x = -\frac{\partial \phi'}{\partial x} = -\frac{1}{\gamma_0}\frac{\partial \phi}{\partial x} \label{Exprime}
%\end{equation}
%Again, we have dropped the ``$'$'' sign from $x$ and $y$ as these coordinates are unaffected by the Lorentz boost.
%
%
%The change in the x component of the momentum, which is an invariant for our Lorentz transformation, is given by :
%\begin{equation}
%\Delta P_x = \Delta P'_x = qE'_x T'
%\end{equation}
%
%Using Eqs.~\ref{Exprime} and~\ref{Tprime} we can write:
%\begin{equation}
%\Delta P_x = -\frac{qL}{\beta c} \frac{\partial \phi}{\partial x}\left(x, y,\zeta\right)
%\end{equation}
%
%Normalizing to the momentum of the reference particle:
%
%\begin{equation}
%\Delta p_x = \frac{\Delta P_x} {P}= -\frac{qL}{ m\gamma\beta^2 c^2} \frac{\partial \phi}{\partial x}\left(x, y,\zeta\right)\label{dpx}
%\end{equation}
%
%Similarly, for the $y$-direction we can write: 
%\begin{equation}
%\Delta p_y = \frac{\Delta P_y} {P}= -\frac{qL}{ m\gamma\beta^2 c^2} \frac{\partial \phi}{\partial y}\left(x, y,\zeta\right)\label{dpy}
%\end{equation}

\section{Lorentz force}
We now compute the Lorentz force on the particles moving in the longitudinal directions, including particles of the bunch itself (space charge forces) and particles of a colliding bunch moving in the opposite directions (beam-beam forces).
The angles of such test particles are neglected as done in the usual thin-lens approximation. Therefore the velocity of a test particle can be written as:
\begin{equation}
\textbf{v} = \beta c\, \hat{\textbf{i}}_s
\end{equation}

The Lorenz force can be written as:
\begin{equation}
\begin{split}
\textbf{F} &=q \left( -\nabla \phi -\frac{\partial \textbf{A}}{\partial t}
 + \beta c \ \hat{\textbf{i}}_s \times {\left(\nabla \times \textbf{A} \right)} \right)\\
 &=q \left( -\nabla \phi -\frac{\beta_0}{\gamma_0 c}\frac{\partial \phi}{\partial t}\hat{\textbf{i}}_s
 + \beta c \ \hat{\textbf{i}}_s \times {\left(\nabla \times \textbf{A} \right)} \right)
 \end{split}
\end{equation}

We compute the vector product:
\begin{align}
\begin{split}
\hat{\textbf{i}}_s \times \left(\nabla \times \textbf{A}\right) &= \left(\frac{\partial A_s}{\partial x} - \frac{\partial A_x}{\partial s} \right) \hat{\textbf{i}}_x + \left(\frac{\partial A_s}{\partial y} - \frac{\partial A_y}{\partial s} \right) \hat{\textbf{i}}_y\\
 &= \left(\frac{\partial A_s}{\partial x} - \frac{\partial A_x}{\partial s} \right) \hat{\textbf{i}}_x + \left(\frac{\partial A_s}{\partial y} - \frac{\partial A_y}{\partial s} \right) \hat{\textbf{i}}_y + \underbrace{\left(\frac{\partial A_s}{\partial s} - \frac{\partial A_s}{\partial s} \right)}_{=0} \hat{\textbf{i}}_s\\
 &= \nabla A_s - \frac{\partial \textbf{A}}{\partial s} 
\end{split} 
\end{align}

We replace:
\begin{equation}
\textbf{F} 
=q \left( -\nabla \phi -\frac{\beta_0}{\gamma_0 c}\frac{\partial \phi}{\partial t}\hat{\textbf{i}}_s
 + \beta  \beta_0\nabla \phi - \frac{\beta \beta_0}{\gamma_0} \frac{\partial \phi}{\partial s} \hat{\textbf{i}}_s
  \right)
\end{equation}

The potentials will have the same form as the sources (this can be shown explicitly using the Lorentz transformations):
\begin{equation}
\phi(x, y, s, t) = \phi\left(x, y, t - \frac{s}{\beta_0 c}\right)
\end{equation}
For a function in this form we can write:
\begin{equation}
 \frac{\partial \phi}{\partial s} = 
\frac{\partial}{\partial\zeta} 
 = -\frac{1}{\beta_0 c}\frac{\partial \phi}{\partial t} \label{derder}
\end{equation}


obtaining:
\begin{equation}
\textbf{F} 
=q \left( -\nabla \phi +\frac{\beta_0^2}{\gamma_0}\frac{\partial \phi}{\partial \zeta}\hat{\textbf{i}}_s
 + \beta  \beta_0\nabla \phi - \frac{\beta \beta_0}{\gamma_0} \frac{\partial \phi}{\partial \zeta} \hat{\textbf{i}}_s
  \right)
\end{equation}


Reorganizing:
\begin{equation}
\textbf{F} 
=  -q(1-\beta  \beta_0)\nabla \phi -\frac{\beta_0(\beta-\beta_0)}{\gamma_0}\frac{\partial \phi}{\partial \zeta}\hat{\textbf{i}}_s
\end{equation}

Writing the dependencies explicitly:
\begin{align}
F_x(x, y, \zeta(t)) &=  -q(1-\beta  \beta_0) \frac{\partial \phi}{\partial x}(x, y, \zeta(t))\label{eq:forcex}\\
F_y(x, y, \zeta(t)) &=  -q(1-\beta  \beta_0) \frac{\partial \phi}{\partial y}(x, y, \zeta(t))\label{eq:forcey}\\
F_z(x, y, \zeta(t)) &=  -q\left(1-\beta  \beta_0 -\frac{\beta_0(\beta-\beta_0)}{\gamma_0}\right) \frac{\partial \phi}{\partial \zeta}(x, y, \zeta(t))\label{eq:forcez}
\end{align}
where $\zeta(t)$ is the position of the particle within the bunch.

\section{Space charge}

Over the single interaction we neglect the particle slippage\footnote{In any case one would need to take into account also the dispersion in order to have the right slippage.}:
\begin{align}
&\beta = \beta_0\\
&\zeta(t) = \zeta
\end{align}

This gives the following simplification of Eqs.\,\eqref{eq:forcex}\,-\,\eqref{eq:forcez}:
\begin{align}
F_x(x, y, \zeta) &=  -q(1-\beta_0^2) \frac{\partial \phi}{\partial x}(x, y, \zeta)\\
F_y(x, y, \zeta) &=  -q(1-\beta_0^2) \frac{\partial \phi}{\partial y}(x, y, \zeta)\\
F_z(x, y, \zeta) &=  -q (1-\beta_0^2) \frac{\partial \phi}{\partial \zeta}(x, y, \zeta)
\end{align}

In this way the force over the single interaction becomes independent on time and therefore we can compute the kicks simply as:
\begin{equation}
\Delta \textbf{P} = \frac{L}{\beta_0 c}\textbf{F} 
\end{equation}
where $L$ is the portion of the machine on which we want to compute the e-cloud interaction.

The kicks on the normalized momenta can be expressed as (recalling that $P_0=m_0\beta_0\gamma_0c$):

\begin{align}
&\boxed{
\Delta p_x = \frac{m_0}{m}\frac{\Delta P_x} {P_0}= -\frac{qL (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \frac{\partial \phi}{\partial x}\left(x, y,\zeta\right)}\label{dpx}\\
&\boxed{
\Delta p_y = \frac{m_0}{m}\frac{\Delta P_y} {P_0}= -\frac{qL (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \frac{\partial \phi}{\partial y}\left(x, y,\zeta\right)}\label{dpy}\\
&\boxed{
\Delta \delta \simeq \Delta p_z = \frac{m_0}{m}\frac{\Delta P_z} {P_0}= -\frac{qL (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \frac{\partial \phi}{\partial \zeta}\left(x, y,\zeta\right)}
\label{dpz}
\end{align}

If the beam includes particles of different species (tracking of fragments), note that here $q$ and $m$ refer to the individual particle while $m_0$ is the mass of the reference particle.



In the modulated 2D case (see Sec.\,\ref{sec:modulated2d} and in particular Eq.\,\ref{eq:factorized2d}), the kick can be expressed as:
\begin{align}
&\boxed{
\Delta p_x = \frac{m_0}{m}\frac{\Delta P_x} {P_0}= -\frac{qq_0L (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \,\lambda_0(\zeta)\,\frac{\partial {\phi_\perp}}{\partial x}\left(x, y\right)}\label{dpx_mod}\\
&\boxed{
\Delta p_y = \frac{m_0}{m}\frac{\Delta P_y} {P_0}= -\frac{qq_0L (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \,\lambda_0(\zeta)\, \frac{\partial{\phi_\perp}}{\partial y}\left(x, y\right)}\label{dpy_mod}\\
&\boxed{
\Delta \delta \simeq \Delta p_z = \frac{ m_0} {m}\frac{\Delta P_z} {P_0}= -\frac{qq_0L (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \,\frac{d\lambda_0}{d\zeta}(\zeta)\,{\phi_\perp}\left(x, y\right)}\label{dpz_mod}
\end{align}

\section{Intra-Beam Scattering}

Intra-beam scattering (IBS) is the process of small angle, multiple Coulomb scattering of charged particles within the beam.
It leads to a redistribution of the particle momenta in six-dimentional phase space.

\subsection{Analytical Growth Rates}
\label{subsection:ibs_growth_rates}

Theoretical models commonly characterize the effect of IBS with growth rates, which govern differential equations describing the evolution of rms emittances of the beam.
The horizontal (\(\tau_x\)), vertical (\(\tau_y\)) and longitudinal (\(\tau_z\)) growth rates are defined as:

\begin{equation}
    \begin{aligned}
        \frac{1}{\tau_x} &= \frac{1}{\varepsilon_x^{1/2}} \frac{d \varepsilon_x^{1/2}}{dt} \text{,  } \\
        \frac{1}{\tau_y} &= \frac{1}{\varepsilon_y^{1/2}} \frac{d \varepsilon_y^{1/2}}{dt} \text{,  } \\
        \frac{1}{\tau_z} &= \frac{1}{\varepsilon_z} \frac{d \varepsilon_z}{dt} \text{ .}
    \end{aligned}
    \label{equation:ibs_rms_emittances_evolutions}
\end{equation}

The growth rates themselves are expressed from the lattice optics and the beam properties.
In xfields two different formalism are available to compute these growth rates, which both assume transverse and longitudinal Gaussian bunch profiles.
Both rely on the computation of the Coulomb logarithm \(L_C\), which in \textit{xfields} is computed as in MAD-X, according to the expression in the Physics Vade Mecum~\cite{AIP:Anderson:Physics_Vade_Mecum}:

\begin{equation}
    L_C = \ln \left( \frac{r_{max}}{r_{min}} \right) \text{ ,}
    \label{equation:coulomb_logarithm}
\end{equation}
where \(r_{max}\) is taken as the smaller of \(\sigma_x\) and the Debye length, while \(r_{min}\) is taken as the larger of the classical distance of closest approach and the quantum diffraction limit from the nuclear radius.

In \textit{xfields} the computed and returned values are \(T_u = 1 / \tau_u\) for plane \(u\), and are given in \(\left[s^{-1}\right]\). 

\subsubsection{Nagaitsev Formalism}  

One available formalism follows the approach introduced by S.~Nagaitsev in~\cite{PRAB:Nagaitsev:IBS_formulas_fast_numerical_evaluation}.
It provides a fast computation method through symmetric elliptic integrals of the second kind, \(R_D(x,y,z)\):

\begin{equation}
    R_D(x, y, z) = \frac{3}{2} \int_{0}^{\infty} \frac{dt}{\sqrt{(t + x)(t + y)(t + z)^3}} \text{ .}
    \label{equation:elliptic_integrals}
\end{equation}

Interestingly, this integral has the following special properties:

\begin{equation}
    R_D(x, x, x) = x^{-3/2} \text{,  }
    \label{equation:RD_property1}
\end{equation}

\begin{equation}
    R_D(x, y, z) + R_D(y, z, x) + R_D(z, x, y) = \frac{3}{\sqrt{xyz}} \text{ .}
    \label{equation:RD_property2}
\end{equation}

This method is particularly efficient, as thanks to Eq~\eqref{equation:RD_property2} only two evaluations of this integral (which does not scale with the size of the lattice) are needed to obtain various simple terms from which one can compute the growth rates.
\newline

In \textit{xfields}, the following steps are taken.
First the \(a_x, a_y, a_s, a_1\) and \(a_2\) terms are computed:

\begin{equation}
    \begin{aligned}
        a_x &= \frac{\beta_x}{\varepsilon_x} \text{,  }
        a_y = \frac{\beta_y}{\varepsilon_y} \text{,  }
        a_s = a_x \left( \frac{D_x^{2}}{\beta_x^{2}} + \Phi_x^2 \right) + \frac{1}{\sigma_p^{2}} \text{,  } \\
        a_1 &= \frac{1}{2} (a_x + \gamma^2 a_s) \text{,  }
        a_2 = \frac{1}{2} (a_x - \gamma^2 a_s) \text{ .}
    \end{aligned}
    \label{equation:nagaitsev_step1}
\end{equation}
where the \(\Phi_{x,y}\) term is defined as:

\begin{equation}
    \Phi_{x,y} = D_{x,y}^{\prime} - \frac{\beta_{x,y}^{\prime} D_{x,y}}{2 \beta_{x,y}} \text{ .}
\end{equation}

Then the \(\lambda_1, \lambda_2\) and \(\lambda_3\) terms are computed:

\begin{equation}
    \lambda_1 = a_y \text{ , }
    \lambda_2 = a_1 + \sqrt{a_2^{2} + \gamma^2 a_x^{2} \Phi_x^2} \text{ , }
    \lambda_3 = a_1 - \sqrt{a_2^{2} + \gamma^2 a_x^{2} \Phi_x^2} \text{ .}
    \label{equation:nagaitsev_lambdas}
\end{equation}
and used to compute three integrals \(R_1, R_2\) and \(R_3\) (through with Eq~\eqref{equation:RD_property2} only two need to be computed):

\begin{equation}
    \begin{aligned}
        R1 = \frac{1}{\lambda_1} R_D(\frac{1}{\lambda_2}, \frac{1}{\lambda_3}, \frac{1}{\lambda_1}) \text{ ,} \\
        R2 = \frac{1}{\lambda_2} R_D(\frac{1}{\lambda_3}, \frac{1}{\lambda_1}, \frac{1}{\lambda_2}) \text{ ,} \\
        R3 = \frac{1}{\lambda_3} R_D(\frac{1}{\lambda_1}, \frac{1}{\lambda_2}, \frac{1}{\lambda_3}) \text{ .}
    \end{aligned}
    \label{equation:nagaitsev_r1r2r3}
\end{equation}

Using all the above the \(S_p, S_x\) and \(S_{xp}\) terms are computed according to Eq~\eqref{equation:nagaitsev_spsxsxp}:

\begin{equation}
    \begin{aligned}
        S_p &= \frac{\gamma^2}{2} \left[ 2 R_1 - R_2 \left(1 - \frac{3 a_2}{\sqrt{a_2^{2} + \gamma^2 a_x^{2} \Phi_x^2}}\right) - R_3 \left(1 + \frac{3 a_2}{\sqrt{a_2^{2} + \gamma^2 a_x^{2} \Phi_x^2}}\right) \right] \text{ ,} \\
        S_x &= \frac{1}{2} \left[ 2 R_1 - R_2 \left(1 + \frac{3 a_2}{\sqrt{a_2^{2} + \gamma^2 a_x^{2} \Phi_x^2}}\right) - R_3 \left(1 - \frac{3 a_2}{\sqrt{a_2^{2} + \gamma^2 a_x^{2} \Phi_x^2}}\right) \right] \text{ ,} \\
        S_{xp} &= \frac{3 \gamma^2 \Phi_x^2 a_x}{\sqrt{a_2^{2} + \gamma^2 a_x^{2} \Phi_x^2}} \left( R_3 - R_2 \right) \text{ .}
    \end{aligned}
    \label{equation:nagaitsev_spsxsxp}
\end{equation}

From these, one computes the integrals - called the \textit{Nagaitsev integrals} in the \textit{xfields} code base - \(I_x, I_y\) and \(I_z\):

\begin{equation}
    \begin{aligned}
        I_x &= \int_0^C \frac{\beta_x ds}{L \sigma_x \sigma_y} \left[S_x + \left( \frac{D_x^{2}}{\beta_x^{2}} + \Phi_x^{2} \right) S_p + S_{xp} \right] \text{ ,} \\
        I_y &= \int_0^C \frac{\beta_y ds}{L \sigma_x \sigma_y} \left(R_2 + R_3 - 2 R_1\right) \text{ ,} \\
        I_z &= \int_0^C \frac{ds}{L \sigma_x \sigma_y} S_p \text{ .}
    \end{aligned}
    \label{equation:nagaitsev_integrals}
\end{equation}
with \(C\) the circumference (or length) of the machine.
Finally, the growth rates are computed as:

\begin{equation}
    \boxed{T_x = \frac{1}{\tau_x} = \frac{1}{\varepsilon_x} \frac{N r_0^{2} c L_C}{12 \pi \beta^3 \gamma^5 \sigma_z} I_x}
    \label{equation:nagaitsev_tx}
\end{equation}

\begin{equation}
    \boxed{T_y = \frac{1}{\tau_y} = \frac{1}{\varepsilon_y} \frac{N r_0^{2} c L_C}{12 \pi \beta^3 \gamma^5 \sigma_z} I_y}
    \label{equation:nagaitsev_ty}
\end{equation}

\begin{equation}
    \boxed{T_z = \frac{1}{\tau_z} = \frac{1}{\sigma_p^{2}} \frac{N r_0^{2} c L_C}{12 \pi \beta^3 \gamma^5 \sigma_z} I_z}
    \label{equation:nagaitsev_tz}
\end{equation}

In the above \(N\) is the total beam intensity, \(r_0\) the classical particle radius, \(c\) the speed of light in vacuum, \(L_C\) the Coulomb logarithm from Eq~\eqref{equation:coulomb_logarithm}, \(\beta\) and \(\gamma\) the relativistic parameters of the beam and \(\sigma_z\) the bunch length.
\newline

One should note, however, that this formalism does not take into account vertical dispersion, and in the presence of \(D_y\) will yield an erroneous vertical growth rate.
For machines with vertical dispersion, the Bjorken-Mtingwa formalism presented below is recommended.

\subsubsection{Bjorken-Mtingwa Formalism}

The IBS growth rates can also be computed according to the theory by Bjorken and Mtingwa~\cite{CERN:Bjorken_Mtingwa:Intrabeam_Scattering}.
The specific implementation follows that of the MAD-X code, for which modifications to the terms of B\&M's theory have been made to account for vertical dispersion non-ultrarelativistic beams~\cite{CERN:Antoniou:Revision_IBS_MADX}.
\newline

In the Bjorken-Mtingwa formalism, the growth rates are computed at every element in the lattice and averaged over the machine to yield final values.
For a given plane \(d\) (horizontal, vertical or longitudinal), the growth rate is computed as:

\begin{equation}
    \frac{1}{\tau_d} = \frac{N r_0^{2} c m^3 L_C \pi^{2}}{\gamma \Gamma} \left\langle \int_0^{\infty} \frac{d \lambda \lambda^{1 / 2}}{\left[\operatorname{det}(L + \lambda I)\right]^{1/2}} \left\{\operatorname{Tr} L^d \operatorname{Tr}\left(\frac{1}{L + \lambda I}\right) - 3 \operatorname{Tr} L^d \left(\frac{1}{L + \lambda I}\right)\right\}\right\rangle
    \label{equation:bjorken_mtingwa_original}
\end{equation}
in which \(N\) is the total beam intensity, \(r_0\) the classical particle radius, \(c\) the speed of light in vacuum, \(m\) the mass of the considered particle, \(L_C\) the Coulomb logarithm from Eq~\eqref{equation:coulomb_logarithm}, \(\gamma\) the relativistic parameter of the beam, and \(\Gamma\) the six-dimensional phase space volume of the beam, defined as:

\begin{equation}
    \Gamma = \left( 2 \pi \right)^3 \left( \beta \gamma \right)^3 m^3 \varepsilon_x \varepsilon_y \sigma_{\delta} \sigma_z
\end{equation}
with \(\sigma_{\delta}\) the relative momentum spread and \(\sigma_z\) the bunch length.
One should not this expression is corrected by a factor \(\sqrt{2}\) for coasting beams.

In Eq~\eqref{equation:bjorken_mtingwa_original} \(\lambda\) is simply the integration variable, \(I\) is the 3x3 identity matrix, and \(L\) is the 3x3 matrix and the matrix \(L\) is defined as:

\begin{equation}
    L = L^{(x)} + L^{(y)} + L^{(z)} \text{ ,}
\end{equation}
where the plane-dependent matrices \(L^{(x)}, L^{(y)}\) and \(L^{(z)}\) are defined as:

\begin{equation}
    L^{(x)} = \frac{\beta_x}{\epsilon_x} \left(
        \begin{array}{ccc}
            1              & -\gamma \phi_x         & 0 \\
            -\gamma \phi_x & \gamma^2 H_x / \beta_x & 0 \\
            0              & 0                      & 0
        \end{array} \right) \text{ ,}
\end{equation}

\begin{equation}
    L^{(y)} = \frac{\beta_y}{\epsilon_y} \left(
        \begin{array}{ccc}
            0 & 0                      & 0 \\
            0 & \gamma^2 H_y / \beta_y & -\gamma \phi_y \\
            0 & -\gamma \phi_y         & 1
        \end{array} \right) \text{ ,}
\end{equation}

\begin{equation}
    L^{(z)} = \frac{\gamma^2}{\sigma_\delta^2} \left(
        \begin{array}{lll}
            0 & 0 & 0 \\
            0 & 1 & 0 \\
            0 & 0 & 0
        \end{array} \right) \text{ .}
\end{equation}

The \(\Phi_{x,y}\) and \(H_{x,y}\) terms are defined as:

\begin{equation}
    \phi_{x,y} = D_{x,y}^{\prime} - \frac{\beta_{x,y}^{\prime} D_{x,y}}{2 \beta_{x,y}} \text{ ,}
    \label{equation:bm_phi}
\end{equation}
and

\begin{equation}
    H_{x,y} = \frac{D_{x,y}^2 + \beta_{x,y}^2 \phi_{x,y}^2}{\beta_{x,y}} \text{ .}
    \label{equation:bm_h}
\end{equation}

In~\cite{CERN:Antoniou:Revision_IBS_MADX} a new expression was derived for each growth rates, which is the implemented approach.
In \textit{xfields}, the computation of the growth rates takes the following steps.
First the \(a, b, c, a_x, b_x, a_y, b_y, a_z\) and \(b_z\) terms are computed as defined below:

\begin{equation}
    a = \gamma^2 \left(\frac{H_x}{\varepsilon_x} + \frac{H_y}{\varepsilon_y}\right) + \frac{\gamma^2}{\sigma_{\delta}^{2}} + \left(\frac{\beta_x}{\varepsilon_x} + \frac{\beta_y}{\varepsilon_y} \right) \text{ ,}
    \label{equation:bm_a}
\end{equation}

\begin{equation}
    b = \left(\frac{\beta_x}{\varepsilon_x} + \frac{\beta_y}{\varepsilon_y}\right) \left(\frac{\gamma^2 D_x^{2}}{\varepsilon_x \beta_x} + \frac{\gamma^2 D_y^{2}}{\varepsilon_y \beta_y} + \frac{\gamma^2}{\sigma_{\delta}^{2}}\right) + \frac{\beta_x \beta_y}{\varepsilon_x \varepsilon_y} \gamma^2 \left( \Phi_x^{2} + \Phi_y^{2}\right) + \frac{\beta_x \beta_y}{\varepsilon_x \varepsilon_y} \text{ ,}
    \label{equation:bm_b}
\end{equation}

\begin{equation}
    c = \frac{\beta_x \beta_y}{\varepsilon_x \varepsilon_y} \left( \frac{\gamma^2 D_x^{2}}{\varepsilon_x \beta_x} + \frac{\gamma^2 D_y^{2}}{\varepsilon_y \beta_y} + \frac{\gamma^2}{\sigma_{\delta}^{2}} \right) \text{ ,}
    \label{equation:bm_c}
\end{equation}

\begin{equation}
    \begin{aligned}
    a_x = & 2 \gamma^2 \left(\frac{H_x}{\varepsilon_x} + \frac{H_y}{\varepsilon_y} + \frac{1}{\sigma_{\delta}^{2}}\right) - \frac{\beta_x H_y}{H_x \varepsilon_y} + \frac{\beta_x}{H_x \gamma^2} \left( \frac{2 \beta_x}{\varepsilon_y} - \frac{\beta_y}{\varepsilon_y} - \frac{\gamma^2}{\sigma_{\delta}^{2}} \right) \\
          & - 2 \frac{\beta_x}{\varepsilon_x} \frac{\beta_y}{\varepsilon_y} + \frac{\beta_x}{\gamma^2 H_x} \left( \frac{6 \beta_x}{\varepsilon_x} \gamma^2 \Phi_x^{2} \right) \text{ ,}
    \end{aligned}
    \label{equation:bm_ax}
\end{equation}

\begin{equation}
    \begin{aligned}
        b_x = & \left(\frac{\beta_x}{\varepsilon_x} + \frac{\beta_y}{\varepsilon_y}\right) \left(\frac{\gamma^2 H_x}{\varepsilon_x} + \frac{\gamma^2 H_y}{\varepsilon_y} + \frac{\gamma^2}{\sigma_{\delta}^{2}}\right) - \gamma^2 \left(\frac{\beta_x^{2}}{\varepsilon_x^{2}} \Phi_x^{2} + \frac{\beta_y^{2}}{\varepsilon_y^{2}} \Phi_y^{2}\right) + \left(\frac{\beta_x}{\varepsilon_x} - \frac{4 \beta_y}{\varepsilon_y}\right) \frac{\beta_x}{\varepsilon_x} \\
              & + \frac{\beta_x}{\gamma^2 H_x} \left(\frac{\gamma^2}{\sigma_{\delta}^{2}} \left(\frac{\beta_x}{\varepsilon_x} - \frac{2 \beta_y}{\varepsilon_y} \right) + \frac{\beta_x \beta_y}{\varepsilon_x \varepsilon_y} + \frac{6 \beta_x \beta_y}{\varepsilon_x \varepsilon_y} \gamma^2 \Phi_x^{2} + \gamma^2 \left(\frac{2 \beta_y^{2} \Phi_y^{2}}{\varepsilon_y^{2}} - \frac{\beta_x^{2} \Phi_x^{2}}{\varepsilon_x^{2}}\right)\right) \\
              & + \frac{\beta_x H_y}{\varepsilon_y H_x} \left(\frac{\beta_x}{\varepsilon_x} - \frac{2 \beta_y}{\varepsilon_y}\right)
    \end{aligned}
    \label{equation:bm_bx}
\end{equation}

\begin{equation}
    \begin{aligned}
    a_y = & - \gamma^2 \left(\frac{H_x}{\varepsilon_x} + \frac{2 H_y}{\varepsilon_y} + \frac{\beta_x}{\beta_y} \frac{H_y}{\varepsilon_x} + \frac{1}{\sigma_{\delta}^{2}}\right) + 2 \gamma^4 \frac{H_y}{\beta_y} \left(\frac{H_y}{\varepsilon_y} + \frac{H_x}{\varepsilon_x}\right) \\
          & + \frac{2 \gamma^4 H_y}{\beta_y \sigma_{\delta}^{2}} - \left(\frac{\beta_x}{\varepsilon_x} - \frac{2 \beta_y}{\varepsilon_y}\right) + \left(\frac{6 \beta_y}{\varepsilon_y} \gamma^2 \Phi_y^{2}\right)
    \end{aligned}
    \label{equation:bm_ay}
\end{equation}

\begin{equation}
    \begin{aligned}
    b_y = & \gamma^2 \left(\frac{\beta_y}{\varepsilon_y} - \frac{2 \beta_x}{\varepsilon_x}\right) \left(\frac{H_x}{\varepsilon_x} + \frac{1}{\sigma_{\delta}^{2}}\right) + \left(\frac{\beta_y}{\varepsilon_y} - \frac{4 \beta_x}{\varepsilon_x}\right) \frac{\gamma^2 H_y}{\varepsilon_y} + \frac{\beta_x \beta_y}{\varepsilon_x \varepsilon_y} \\
          & + \gamma^2 \left(\frac{2 \beta_x^{2} \Phi_x^{2}}{\varepsilon_x^{2}} - \frac{\beta_y^{2} \Phi_y^{2}}{\varepsilon_y^{2}}\right) + \frac{\gamma^4 H_y}{\beta_y} \left(\frac{\beta_x}{\varepsilon_x} + \frac{\beta_y}{\varepsilon_y}\right) \left(\frac{H_y}{\varepsilon_y} + \frac{1}{\sigma_{\delta}^{2}}\right)\\
          & + \left(\frac{\beta_x}{\varepsilon_x} + \frac{\beta_y}{\varepsilon_y}\right) \gamma^4 \frac{H_x H_y}{\beta_y \varepsilon_x} - \gamma^4 \frac{H_y}{\beta_y} \left(\frac{\beta_x^{2}}{\varepsilon_x^{2}} \Phi_x^{2} + \frac{\beta_y^{2}}{\varepsilon_y^{2}} \Phi_y^{2}\right) + \frac{6 \beta_x \beta_y}{\varepsilon_x \varepsilon_y} \gamma^2 \Phi_y^{2}
    \end{aligned}
    \label{equation:bm_by}
\end{equation}

\begin{equation}
    a_z = 2 \gamma^2 \left(\frac{H_x}{\varepsilon_x} + \frac{H_y}{\varepsilon_y} + \frac{1}{\sigma_{\delta}^{2}}\right) - \frac{\beta_x}{\varepsilon_x} - \frac{\beta_y}{\varepsilon_y}
    \label{equation:bm_az}
\end{equation}

\begin{equation}
    b_z = \left(\frac{\beta_x}{\varepsilon_x} + \frac{\beta_y}{\varepsilon_y}\right) \gamma^2 \left(\frac{H_x}{\varepsilon_x} + \frac{H_y}{\varepsilon_y} + \frac{1}{\sigma_{\delta}^{2}}\right) - 2 \frac{\beta_x \beta_y}{\varepsilon_x \varepsilon_y} - \gamma^2 \left(\frac{\beta_x^{2} \Phi_x^{2}}{\varepsilon_x^{2}} + \frac{\beta_y^{2} \Phi_y^{2}}{\varepsilon_y^{2}}\right)
    \label{equation:bm_bz}
\end{equation}

From these, one can compute the growth rates as:

\begin{equation}
    \boxed{T_x = \frac{1}{\tau_x} = \frac{N r_0^{2} c m^3 L_C \pi^2}{\gamma \Gamma} \left< \left[\frac{\gamma^2 H_x}{\varepsilon_x}\right] \int_0^{\infty} \frac{\lambda^{1/2} \left[a_x \lambda + b_x\right]}{\left(\lambda^3 + a \lambda^2 + b \lambda + c\right)} d \lambda \right>}
    \label{equation:bm_tx}
\end{equation}

\begin{equation}
    \boxed{T_y = \frac{1}{\tau_y} = \frac{N r_0^{2} c m^3 L_C \pi^2}{\gamma \Gamma} \left< \left[\frac{\beta_y}{\varepsilon_y}\right] \int_0^{\infty} \frac{\lambda^{1/2} \left[a_y \lambda + b_y\right]}{\left(\lambda^3 + a \lambda^2 + b \lambda + c\right)} d \lambda \right>}
    \label{equation:bm_ty}
\end{equation}

\begin{equation}
    \boxed{T_z = \frac{1}{\tau_z} = \frac{N r_0^{2} c m^3 L_C \pi^2}{\gamma \Gamma} \left< \left[\frac{\gamma^2}{\sigma_{\delta}^{2}}\right] \int_0^{\infty} \frac{\lambda^{1/2} \left[a_z \lambda + b_z\right]}{\left(\lambda^3 + a \lambda^2 + b \lambda + c\right)} d \lambda \right>}
    \label{equation:bm_tz}
\end{equation}
where the constants in the common fraction term are the same as for Eq~\eqref{equation:bjorken_mtingwa_original}, \(\lambda\) is an integration variable and the angled bracket signify the averaging over the lattice, given the terms contained inside are arrays with one values per element.

\subsection{IBS Kicks}
\label{subsection:ibs_kicks}

The approach of using analytical growth rates does not provide a way to study the interplay of IBS with arbitrary effects, such as space charge, electrong clouds, beam-beam etc.
To do so, it is necessary to include IBS effects in tracking simulations together with other desired effects.
In \textit{xfields} two elements are available to model IBS effects in tracking simulations, both providing momenta kicks to tracked particles according to a specific formalism.

\subsubsection{Analytical Kicks}

A first element is available to provide momenta kicks based on analytical growth rates, according to the approach introduced by R. Bruce~\cite{PRAB:Bruce:IBSAnalyticalKick}.
In \textit{xfields} the computation of the kick is done as follows.
First, the beam intensity \(N\), bunch length \(\sigma_z\), momentum deviation \(\sigma_{\delta}\), and geometric emittances \(\varepsilon_{x,y}\) are inferred from the tracked particles object.
These are used to compute the growth rates \(T_x, T_y\) and \(T_z\) according to the desired formalism, as presented in~\ref{subsection:ibs_growth_rates}.

From these growth rates, each particle is given a momentum kick in each dimension (transverse, longitudinal) according to:

\begin{equation}
    \boxed{\Delta p_u = R \sigma_{p_u} \sqrt{ 2 T_{IBS,u} T_{rev} \sigma_z \sqrt{\pi} \rho(z)} \text{ ;   } u=x,y,z}
    \label{equation:momentum_kick_analytical}
\end{equation}

Here \(R\) is a random number from the standard normal distribution; \(\sigma_{p_u}\) is the standard deviation of the momentum in plane \(u\); \(T_{IBS,u}\) is the growth rate for plane \(u\); \(T_{rev}\) is the revolution frequency and \(\rho(z)\) is the longitudinal line density.

It is worth noting that due to the form of Eq~\eqref{equation:momentum_kick_analytical} only zero or strictly positive growth rates are valid, and as such this formalism is traditionally available above transition energy.

The longitudinal line density \(\rho(z)\) is used as a weighting factor to provide a stronger kick to particles in the denser regions of the bunch.
It is obtained by binning the longitudinal plane of the particle distribution and normalizing the values.

\subsubsection{Kinetic Kicks}

A second element is available to provide momenta kicks based on diffusion and friction terms from the kinetic theory of gases, as introduced by P. Zenkevich~\cite{NuclInstr:Zenkevich:IBSKineticKick}.
The momentum kick has a form similar to the Langevin equation:

\begin{equation}
    \Delta p_u = - K_u p_u \sigma_z \sqrt{\pi} \rho(z) \Delta t + R \sigma_{p_u} \sqrt{2 C_u \sigma_z \sqrt{\pi} \rho(z) \Delta t} \text{ ;   } u=x,y,z
    \label{equation:original_kinetic_kick}
\end{equation}
where \(K_u\) and \(C_u\) are functions of the friction and diffusion terms, respectively.
\newline

In \textit{xfields} the exact implementation makes use of terms from the Nagaitsev formalism (see previous section) as derived by M. Zampetakis~\cite{arXiv:Zampetakis:Interplay_SC_IBS_LHC_Chain}.
The following steps are taken.
First the \(a_x, a_y, a_s, a_1\) and \(a_2\) terms are computed according to Eq~\eqref{equation:nagaitsev_step1}.
Then the \(\lambda_1, \lambda_2\) and \(\lambda_3\) terms are computed according to Eq~\eqref{equation:nagaitsev_lambdas}, to obtain the \(R_1, R_2\) and \(R_3\) elliptic integrals according to Eq~\eqref{equation:nagaitsev_r1r2r3}.

New forms equivalent to the original diffusion and friction terms of the Approximate Model can be expressed from the terms above.
By first defining

\begin{equation}
    q = \sqrt{a_2^{2} + \gamma^2 a_x^{2} \Phi_x^2} \text{ ,}
\end{equation}
they are expressed and computed as:

\begin{equation}
    \begin{aligned}
        D_{x,x} &= \frac{1}{2} \left[ 2 R_1 + R2 \left(1 - \frac{a_2}{q}\right) + R_3 \left(1 + \frac{a_2}{q}\right) \right] \text{,  } \\
        D_{x,z} &= \frac{3 \gamma^2 \Phi_x^2 a_x}{q} \left(R_3 - R_2\right) \text{,  }  \\
        D_{y,y} &= R_2 + R_3 \text{,  }  \\
        D_{z,z} &= \frac{\gamma^2}{2} \left[ 2 R_1 +  R_2 \left(1 + \frac{a_2}{q}\right) + R_3 \left(1 - \frac{a_2}{q}\right) \right] \text{ .}
    \end{aligned}
    \label{equation:kinetic_AM_diffusion_terms}
\end{equation}

\begin{equation}
    \begin{aligned}
        K_x &= R_2 \left(1 + \frac{a_2}{q}\right) + R_3 \left(1 - \frac{a_2}{q}\right) \text{,  } \\
        K_y &= 2 R_1 \text{,  }  \\
        K_z &= \gamma^2 \left[ R_2 \left(1 - \frac{a_2}{q}\right) + R_3 \left(1 + \frac{a_2}{q}\right) \right] \text{ .}
    \end{aligned}
    \label{equation:kinetic_AM_friction_terms}
\end{equation}

The following integrals are computed from the above:

\begin{equation}
    \begin{aligned}
        D_{xi} &= \int_0^C \frac{\beta_x ds}{C \sigma_x \sigma_y} \left[D_{x,x} + \left(\frac{D_x^2}{\beta_x^2} + \Phi_x^2\right) D_{z,z} + D_{x,z} \right] \text{,  } \\
        D_{yi} &= \int_0^C \frac{\beta_y ds}{C \sigma_x \sigma_y} D_{y,y} \text{,  }  \\
        D_{zi} &= \int_0^C \frac{ds}{C \sigma_x \sigma_y} D_{z,z} \text{ .}
    \end{aligned}
    \label{equation:kinetic_diffusion_integrals}
\end{equation}

\begin{equation}
    \begin{aligned}
        F_{xi} &= \int_0^C \frac{\beta_x ds}{C \sigma_x \sigma_y} \left[K_x + \left(\frac{D_x^2}{\beta_x^2} + \Phi_x^2\right) K_z \right] \text{,  } \\
        F_{yi} &= \int_0^C \frac{\beta_y ds}{C \sigma_x \sigma_y} K_x \text{,  }  \\
        F_{zi} &= \int_0^C \frac{ds}{C \sigma_x \sigma_y} K_z \text{ .}
    \end{aligned}
    \label{equation:kinetic_friction_integrals}
\end{equation}
with \(C\) the circumference of the machine.

Finally, the new diffusion coefficients are computed according to:

\begin{equation}
    \boxed{G_x = \frac{1}{\varepsilon_x} \frac{N r_0^2 c L_C}{12 \pi \beta^3 \gamma^5 \sigma_z} D_{xi}}
    \label{equation:kinetic_horizontal_diffusion_coefficient}
\end{equation}

\begin{equation}
    \boxed{G_y = \frac{1}{\varepsilon_y} \frac{N r_0^2 c L_C}{12 \pi \beta^3 \gamma^5 \sigma_z} D_{yi}}
    \label{equation:kinetic_vertical_diffusion_coefficient}
\end{equation}

\begin{equation}
    \boxed{G_z = \frac{1}{\sigma_{\delta}^2} \frac{N r_0^2 c L_C}{12 \pi \beta^3 \gamma^5 \sigma_z} D_{zi}}
    \label{equation:kinetic_longitudinal_diffusion_coefficient}
\end{equation}
and the friction coefficients according to:

\begin{equation}
    \boxed{F_x = \frac{1}{\varepsilon_x} \frac{N r_0^2 c L_C}{12 \pi \beta^3 \gamma^5 \sigma_z} F_{xi}}
    \label{equation:kinetic_horizontal_friction_coefficient}
\end{equation}

\begin{equation}
    \boxed{F_y = \frac{1}{\varepsilon_y} \frac{N r_0^2 c L_C}{12 \pi \beta^3 \gamma^5 \sigma_z} F_{yi}}
    \label{equation:kinetic_vertical_friction_coefficient}
\end{equation}

\begin{equation}
    \boxed{F_z = \frac{1}{\sigma_{\delta}^2} \frac{N r_0^2 c L_C}{12 \pi \beta^3 \gamma^5 \sigma_z} F_{zi}}
    \label{equation:kinetic_longitudinal_friction_coefficient}
\end{equation}

In the above \(N\) is the total beam intensity, \(r_0\) the classical particle radius, \(c\) the speed of light in vacuum, \(L_C\) the Coulomb logarithm from Eq~\eqref{equation:coulomb_logarithm}, \(\beta\) and \(\gamma\) the relativistic parameters of the beam and \(\sigma_z\) the bunch length.
\newline

From these coefficients, each particle is given a momentum kick in each dimension (transverse, longitudinal) according to:

\begin{equation}
    \boxed{\Delta p_u = - F_u p_u T_{rev} 2 \sqrt{\pi} \sigma_z \rho(z) + R \sigma_{p_u} \sqrt{T_{rev} G_u 2 \sqrt{\pi} \sigma_z \rho(z)} \text{ ;   } u=x,y,z}
    \label{equation:momentum_kick_kinetic}
\end{equation}

Here \(R\) is a random number from the standard normal distribution; \(p_u\) and \(\sigma_{p_u}\) are the momentum and its standard deviation in plane \(u\); \(T_{rev}\) is the revolution frequency and \(\rho(z)\) is the longitudinal line density, as defined and used in the analytical kicks (see previous subsection).

\section{Beam-beam interaction (4D model)}

We consider a test particle moving in the opposite direction with velocity:
\begin{align}
\textbf{v}_W = -\beta_{0W} c\, \hat{\textbf{i}}_s\\
s_W(t) = -\beta_{0W} ct
\end{align}
Equations\,\eqref{eq:forcex}\,-\,\eqref{eq:forcez} become:
\begin{align}
F_x(x, y, \zeta_W(t)) &=  -q(1+\beta_{0W}  \beta_{0s}) \frac{\partial \phi}{\partial x}(x, y, \zeta_W(t)) \label{eq:bbfgenx}\\
F_y(x, y, \zeta_W(t)) &=  -q(1+\beta_{0W}  \beta_{0S}) \frac{\partial \phi}{\partial y}(x, y, \zeta_W(t))\label{eq:bbfgeny}\\
F_z(x, y, \zeta_W(t)) &=  -q\left(1+\beta_{0W}  \beta_{0S} -\frac{\beta_{0S}(\beta_{0W}+\beta_{0S})}{\gamma_0}\right) \frac{\partial \phi}{\partial \zeta}(x, y, \zeta_W(t))\label{eq:bbfgenz}
\end{align}
where we have used the the subscript $S$ (strong) for the bunch generating the fields, and the subscript $W$ (weak) for the test particle. 

$\zeta_W(t)$ is the position of the test particle within the bunch generating the fields: 
\begin{equation}
\zeta_W(t)= s_W(t) -\beta_{0S} c t  = -(\beta_{0W}+\beta_{0S})ct
\label{eq:zetaw}
\end{equation}

In modulated-2D case (Eq.\,\ref{eq:factorized2d}), Eqs.\,\eqref{eq:bbfgenx}\,-\,\eqref{eq:bbfgeny} become:
\begin{align}
F_x(x, y, \zeta_W(t)) &=  -q q_{0S} (1+\beta_{0W}  \beta_{0s})
\lambda_{0S}(\zeta_W(t))
 \frac{\partial \phi_\perp}{\partial x}(x, y ) \\
F_y(x, y, \zeta_W(t)) &=  -qq_{0S}  (1+\beta_{0W}  \beta_{0s})
\lambda_{0S}(\zeta_W(t))
 \frac{\partial \phi_\perp}{\partial y}(x, y ) \\
F_z(x, y, \zeta_W(t)) &=  -qq_{0S}\left(1+\beta_{0W}  \beta_{0S} -\frac{\beta_{0S}(\beta_{0W}+\beta_{0S})}{\gamma_0}\right) \frac{d \lambda_{0S}}{d \zeta}(\zeta_W(t)) \phi_\perp(x, y)
\end{align}

The change in momentum for the test particle is given by:
\begin{equation}
\Delta \textbf{P} = \int_{-\infty}^{+\infty} \textbf{F}(t) \,dt
\end{equation}
Therefore:
\begin{align}
\Delta P_x(x, y, \zeta_W(t)) &=  -qq_{0S} N_S (1+\beta_{0W}  \beta_{0s})
\frac{\partial \phi_\perp}{\partial x}(x, y ) \int_{-\infty}^{+\infty}\lambda_{0S}(\zeta_W(t)) \,dt\\
\Delta P_y(x, y, \zeta_W(t)) &=  -qq_{0S} N_S (1+\beta_{0W}  \beta_{0s})
 \frac{\partial \phi_\perp}{\partial y}(x, y ) \int_{-\infty}^{+\infty}\lambda_{0S}(\zeta_W(t)) \,dt\\
\Delta P_z(x, y, \zeta_W(t)) &=  -qq_{0S}\left(1+\beta_{0W}  \beta_{0S} -\frac{\beta_{0S}(\beta_{0W}+\beta_{0S})}{\gamma_0}\right) \phi_\perp(x, y) \int_{-\infty}^{+\infty}\frac{d \lambda_{0S}}{d \zeta}(\zeta_W(t)) \, dt
\end{align}

Using Eq.\,\eqref{eq:zetaw} and Eq.\,\eqref{eq:lamnorm} we can write:
\begin{equation}
\int_{-\infty}^{+\infty}\lambda_{0S}(\zeta_W(t)) \,dt 
=\frac{1}{(\beta_{0W}+\beta_{0S})c}\int_{-\infty}^{+\infty}\lambda_{0S}(\zeta) \,d\zeta = \frac{N_S}{(\beta_{0W}+\beta_{0S})c}
\end{equation}

Similarly, for a bunched beam:
\begin{equation}
\int_{-\infty}^{+\infty}
\frac{d \lambda_{0S}}{d \zeta}(\zeta_W(t)) \,dt 
=\frac{1}{(\beta_{0W}+\beta_{0S})c}\int_{-\infty}^{+\infty}\frac{d \lambda_{0S}}{d \zeta} \,d\zeta = \frac{ \lambda_{0S}(+\infty)-\lambda_{0S}(-\infty)}{(\beta_{0W}+\beta_{0S})c} = 0
\end{equation}

From which we can write:
\begin{align}
&\boxed{
\Delta p_x = \frac{m_0}{m}\frac{\Delta P_x} {P_0}= -\frac{qq_{0S} N_S 
}{m\beta_{0W}\gamma_{0W}c^2}
\frac{(1+\beta_{0W}  \beta_{0s})}{(\beta_{0W}+\beta_{0S})}
\frac{\partial \phi_\perp}{\partial x}(x, y )}\\
&\boxed{
\Delta p_y = \frac{m_0}{m}\frac{\Delta P_y} {P_0}= -\frac{qq_{0S} N_S 
}{m\beta_{0W}\gamma_{0W}c^2}
\frac{(1+\beta_{0W}  \beta_{0s})}{(\beta_{0W}+\beta_{0S})}
\frac{\partial \phi_\perp}{\partial y}(x, y )}\\
&\boxed{
\Delta p_z = \frac{m_0}{m}\frac{\Delta P_z} {P_0}=0}
\end{align}

\section{Longitudinal profiles}

\subsection{Gaussian profile}

The profile is in the form:
\begin{equation}
\lambda_{0}(z)=\frac{N}{\sqrt{2 \pi} \sigma} e^{-\frac{(z-z_0)^{2}}{2 \sigma^{2}}}
\end{equation}


\subsection{q-Gaussian}

The profile is in the form:
\begin{equation}
\lambda_0(z)=\frac{N\sqrt{\beta}}{C_{q}} e_{q}\left(-\beta (z-z_0)^{2}\right)
\end{equation}
where $e_q$ is the q-exponential function:
\begin{equation}
e_{q}(x)=[1+(1-q) x]_{+}^{\frac{1}{1-q}}
\end{equation}
$C_q$ is a normalization factor dependent on $q$ alone:
\begin{equation}
C_{q}=\frac{\sqrt{\pi} \Gamma\left(\frac{3-q}{2(q-1)}\right)}{\sqrt{q-1} \Gamma\left(\frac{1}{q-1}\right)}
\end{equation}

The parameter beta defines the standard deviation of the distribution:

\begin{equation}
\sigma = \sqrt{\frac{1}{\beta(5-3 q)}} \iff \beta ={\frac{1}{\sigma^2(5-3 q)}}
\end{equation}



These expressions are valid for values of the parameter $q$ is   the range of interest:
\begin{equation}
1<q<\frac{5}{3}
\end{equation}

In general the q-Gaussian is defined outside this range, but for smaller values it has a limited support (not of interest) and for larger values has a not defined standard deviation.

\section{FFT solvers and covolutions}

\subsection{Notation for Discrete Fourier Transform}
We will use the following notation for the Discrete Fourier Transform of a sequence of length $M$:
\begin{equation}
\hat{a}_k = \text{DFT}_M(a_m) =  \sum_{m=0}^{M-1} a_m\, e^{-j2\pi  \frac{km}{M}}  \quad \text{for } k \in 0, ..., M
\end{equation}
The corresponding inverse transform is defined as:
\begin{equation}
{a}_n = \text{DFT}^{-1}_M(\hat{a}_k) =  \frac{1}{M}\sum_{k=0}^{M-1} \hat{a}_k\, e^{j2\pi  \frac{km}{M}}  \quad \text{for } m \in 0, ..., M
\end{equation}

Multidimensional Discrete Fourier Transforms are obtained by applying sequentially 1D DFTs.. For example, in two dimensions:

\begin{equation}
\begin{split}
\hat{a}_{k_xk_y} &= \text{DFT}_{M_xM_y}\left\{a_{m_xm_y}\right\}  
= \text{DFT}_{M_y} \left\{\text{DFT}_{M_x}\left\{a_{m_xm_y}\right\}\right\}\\  
&=\sum_{m_x=0}^{M_x-1} e^{-j 2\pi  \frac{k_x m_x}{M_x}} 
\sum_{m_y=0}^{M_y-1} e^{-j 2\pi  \frac{k_y m_y}{M_y}} a_{m_xm_y}
\end{split}
\end{equation}
\begin{equation}
\begin{split}
{a}_{n_xn_y} &= \text{DFT}^{-1}_{M_xM_y}\left\{a_{k_x k_y}\right\}  
= \text{DFT}^{-1}_{M_y} \left\{\text{DFT}^{-1}_{M_x}\left\{\hat{a}_{k_x k_y}\right\}\right\}\\  
&=\frac{1}{M_x M_y}\sum_{k_x=0}^{M_x-1} e^{j 2\pi  \frac{k_x m_x}{M_x}} 
\sum_{k_y=0}^{M_y-1} e^{j 2\pi  \frac{k_y m_y}{M_y}} \hat{a}_{k_xk_y}
\end{split}
\end{equation}



\subsection{FFT convolution - 1D case}
\label{sec:fftconv1d}
The potential can be written as the convolution of a Green function with the charge distribution:
\begin{equation}
\phi(x) = \int_{-\infty}^{+\infty} \rho(x')\,G(x-x') dx'
\label{eq:conv}
\end{equation}

We assume that the source is limited to the region  $[0, L]$:
\begin{equation}
\rho(x) = \rho(x)\,\Pi_{[0,L]}\left(x\right)
\label{eq:rholim}
\end{equation}
where $\Pi_{[a,b]}(x)$ is a rectangular window function defined as:
\begin{equation}
\Pi_{[a,b]}(x) = 
\begin{cases}
1\quad\text{for } x \in [a, b]\\
0\quad\text{elsewhere}
\end{cases}
\end{equation}

We are interested in the electric potential only the region occupied by the sources, so we can compute:
\begin{equation}
\phi_L(x) = \phi(x) \Pi_{[0, L]}\left(x\right)
\label{eq:philim}
\end{equation}

We replace Eq.\,\eqref{eq:rholim} and Eq.\,\eqref{eq:philim} into Eq.\eqref{eq:conv}, obtaining:
\begin{equation}
\phi_L(x) = \Pi_{[0,L]}\left( x\right)
\int_{-\infty}^{+\infty} 
\Pi_{[0,L]}\left(x'\right)
\rho(x')\,G(x-x') dx'
\end{equation}
We apply the change of variable $x'' = x - x'$:
\begin{equation}
\phi_L(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[0,L]}\left({x}\right)
\Pi_{[0,L]}\left({x-x''}\right)
\rho(x-x'')\,G(x'') \,dx''
\label{eq:conv1}
\end{equation}
The integrand vanishes outside the set of the $(x, x'')$ defined by:
\begin{equation}
\begin{cases}
0 < x <{L}\\
0 < (x-x'') <{L}
\end{cases}
\end{equation}

We flip the signs in the second equation, obtaining:
\begin{equation}
\begin{cases}
0 < x <{L}\\
-L < (x''-x) <0
\end{cases}
\end{equation}

Combining the two equations we obtain:
\begin{equation}
-L<-L + x < x'' <x<L
\end{equation}
i.e. the integrand is zero for $-L<x''<L$.
Therefore in Eq.\,\eqref{eq:conv1} we can replace $G(x'')$ with its truncated version:
\begin{equation}
G_{2L}(x'') = G(x'')\,\Pi_{[-L,L]}
\left(
{x''}
\right)
\end{equation}

obtaining:
\begin{equation}
\phi_L(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[0,L]}\left({x}\right)
\Pi_{[0,L]}\left({x-x''}\right)
\rho(x-x'')\,G_{2L}(x'') dx''
\label{eq:conv2}
\end{equation}

Since the two window functions force the integrand to zero outside the region $|x''|<L$ we can replace $G_{2L}(x'')$ with its replicated version:
\begin{equation}
G_{2LR}(x'') = \sum_{n=-\infty}^{+\infty}G_{2L}(x''-2nL) = \sum_{n=-\infty}^{+\infty}G(x'' -2nL)\,\Pi_{[-L,L]}
\left(
{x''-2nL}
\right)
\label{eq:GLR}
\end{equation}
obtaining:
\begin{equation}
\phi_L(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[0,L]}\left({x}\right)
\Pi_{[0,L]}\left({x-x''}\right)
\rho(x-x'')\,G_{2LR}(x'') dx''
\end{equation}

We can go back to the initial coordinate by substituting $x'' = x-x'$:
\begin{equation}
\phi_L(x) = 
\Pi_{[0,L]}\left(x\right)
\int_{-\infty}^{+\infty} 
\rho(x')\,G_{2LR}(x-x') dx'
\end{equation}

This is a cyclic convolution, so we can proceed as follows. We split the integral:
\begin{equation}
\phi_L(x) = 
\Pi_{[0,L]}\left({x}\right)
\sum_{n=-\infty}^{+\infty}
\int_{2nL}^{2(n+1)L} 
\rho(x')\,G_{2LR}(x-x') \,dx'
\label{eq:conv3}
\end{equation}
In each term we replace $x''' = x'+2nL$:
\begin{equation}
\phi_L(x) = 
\Pi_{[0,L]}\left({x}\right)
\sum_{n=-\infty}^{+\infty}
\int_{0 }^{2L} 
\rho(x'''-2nL)\,G_{2LR}(x-x'''-2nL) \,dx'''
\label{eq:conv4}
\end{equation}
We use the fact that $G_{2LR}(x)$ is periodic:
\begin{equation}
\begin{split}
\phi_L(x) &= 
\Pi_{[0,L]}\left({x}\right)
\sum_{n=-\infty}^{+\infty}
\int_{0 }^{2L} 
\rho(x'''-2nL)\,G_{2LR}(x-x''') dx'''\\
\\&=
\Pi_{[0,L]}\left({x}\right)
\int_{0 }^{2L}  
\sum_{n=-\infty}^{+\infty}
\rho(x'''-2nL)\,G_{2LR}(x-x''') dx'''
\end{split}
\label{eq:conv5}
\end{equation}

We can define a replicated version of $\rho(x)$:
\begin{equation}
\rho_{2LR}(x)= \sum_{n=-\infty}^{+\infty}
\rho(x-2nL)
\end{equation}
noting that this implies:
\begin{equation}
\rho_{2LR}(x)= 0 \quad \text{for } x \in [L, 2L]
\label{eq:zeros}
\end{equation}

We obtain:
\begin{equation}
\phi_L(x) = 
\Pi_{[0,L]}\left({x}\right)
\int_{0 }^{2L} 
\rho_{2LR}(x')\,G_{2LR}(x-x') dx'
\label{eq:conv6}
\end{equation}

The function:

\begin{equation}
\phi_{2LR}(x) = 
\int_{0 }^{2L} 
\rho_{2LR}(x')\,G_{2LR}(x-x') dx'
\label{eq:confin}
\end{equation}
is periodic of period $2L$. From it the potential of interest can be simply calculated by selecting the first half period $[0, L]$:
\begin{equation}
\phi_L(x) = 
\Pi_{[0,L]}\left({x}\right)
\phi_{2LR}(x)
\label{eq:sel}
\end{equation}

To compute the convolution in Eq.\,\ref{eq:confin} we expand $\phi_{2LR}(x)$ in Fourier series:
\begin{equation}
\phi_{2LR}(x) = \sum_{k=-\infty}^{+\infty} \tilde{\phi}_k\, e^{j2\pi k \frac{x}{2L}}
\label{eq:phifour}
\end{equation}
where the Fourier coefficients are given by:
\begin{equation}
\tilde{\phi}_k = \frac{1}{2L}\int_0^{2L} \phi_{2LR}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx
\label{eq:phik}
\end{equation}

We replace Eq.\,\eqref{eq:confin} into Eq.\,\eqref{eq:phik} obtaining:
\begin{equation}
\hat{\phi}_k = \frac{1}{2L}\int_0^{2L} \int_{0 }^{2L} 
\rho_{2LR}(x')\,G_{2LR}(x-x') \, e^{-j2\pi k \frac{x}{2L}} \,  dx'\, dx
\end{equation}

With the change of variable $x'' = x-x'$ we obtain:
\begin{equation}
\tilde{\phi}_k = 
\frac{1}{2L}
\int_0^{2L} 
\rho_{2LR}(x') e^{-j2\pi k \frac{x'}{2L}}dx'\,
\int_{0 }^{2L} 
\,G_{2LR}(x'') e^{-j2\pi k \frac{x''}{2L}}\,  \,  dx''
\end{equation}

where we recognize the Fourier coefficients of $\rho_{2LR}(x)$ and $\,G_{2LR}(x)$:
\begin{align}
\tilde{\rho}_k = \frac{1}{2L}\int_0^{2L} \rho_{2LR}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx \label{eq:rhok}\\
\tilde{G}_k = \frac{1}{2L}\int_0^{2L} G_{2LR}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx \label{eq:Gk}
\end{align}
obtaining simply:
\begin{equation}
\hat{\phi}_k = 2L \, \hat{G}_k \, \hat{\rho}_k
\label{eq:freqconv}
\end{equation}

I assume to have the functions $\rho_{2LR}(x)$ and  $G_{2LR}(x)$ sampled (or averaged) with step:
\begin{equation}
h_x = \frac{2L}{M} = \frac{L}{N}
\end{equation}

I can approximate the integrals in Eqs.\,\eqref{eq:rhok} and\,\eqref{eq:Gk} as:
\begin{align}
\tilde{\rho}_k = \frac{1}{M}\sum_{n=0}^{M-1} \rho_{2LR}(x_n)\, e^{-j2\pi  \frac{kn}{M}}  
= \frac{1}{M} \hat{\rho}_k
\label{eq:rhokfft}\\
\tilde{G}_k = \frac{1}{M}\sum_{n=0}^{M-1} G_{2LR}(x_n)\, e^{-j2\pi  \frac{kn}{M}} 
= \frac{1}{M} \hat{G}_k\label{eq:Gkfft}
\end{align}

where we recognize the Discrete Fourier Transforms:
\begin{align}
\hat{\rho}_k = \text{DFT}_M\left\{ \rho_{2LR}(x_n)\right\}\\
\hat{G}_k = \text{DFT}_M\left\{ G_{2LR}(x_n)\right\}
\end{align}



Using Eq.\,\eqref{eq:phifour} we can obtain a sampled version of $\phi(x)$:
\begin{equation}
\phi_{2LR}(x_n) = 
\sum_{n=0}^{M-1}  
\tilde{\phi}_k\, e^{j2\pi \frac{kn}{M}}
\label{eq:phifft}
\end{equation}
where we have assumed that $\phi(x)$ is sufficiently smooth to allow truncating the sum.


Using Eqs.\,\eqref{eq:freqconv}, \eqref{eq:rhokfft} and\,\eqref{eq:Gkfft}  we obtain:
\begin{equation}
\phi_{2LR}(x_n) = 
2L \sum_{n=0}^{M-1}  
\tilde{G}_k \, \tilde{\rho}_k\, e^{j2\pi \frac{kn}{M}} 
= 
\frac{2L}{M^2}
\sum_{n=0}^{M-1}  
\hat{G}_k \, \hat{\rho}_k\, e^{j2\pi \frac{kn}{M}} 
\label{eq:phifftsimpl}
\end{equation}

This can be rewritten as:
\begin{equation}
\phi_{2LR}(x_n) = 
\frac{1}{M}
\sum_{n=0}^{M-1}  
(h_x\hat{G}_k) \, \hat{\rho}_k\, e^{j2\pi \frac{kn}{M}} 
=\text{DFT}_M^{-1}\left\{\phi_k
\right\}
\label{eq:invfft}
\end{equation}
where 
\begin{equation}
\hat{\phi}_k =h_x\hat{G}_k \, \hat{\rho}_k
\label{eq:phiknint}
\end{equation}
We call ``Integrated Green Function'' the quantity:
\begin{equation}
G_{2LR}(x_n) = h_x G_{2LR}(x_n)
\end{equation}
we introduce the corresponding Fourier transform:
\begin{equation}
\hat{G}_k^\text{int} = \text{DFT}_M\left\{ G_{2LR}^\text{int}(x_n)\right\}
\end{equation}
Eq.\,\eqref{eq:phiknint} can be rewritten as:
\begin{equation}
\boxed{
\hat{\phi}_k =\hat{G}_k^\text{int} \, \hat{\rho}_k}
\end{equation}

In summary the potential at the grid nodes can be computed as follows:
\begin{enumerate}
\item We compute the Integrated Green function at the grid points in the range $[0, L]$:
\begin{equation}
G_{2LR}^\text{int}(x_n) = \int_{x_n-\frac{h_x}{2}}^{x_n+\frac{h_x}{2}} G(x) dx
\end{equation}
\item We extend to the interval $[L, 2L]$ using the fact that in this interval:
\begin{equation}
G^\text{int}_{2LR}(x_n) = G^\text{int}_{2LR}(x_n-2L) =  G^\text{int}_{2LR}(2L-x_n)
\end{equation}
where the first equality comes from the periodicity of $G^\text{int}_{2LR}(x)$ and the second from the fact that $G(x)$ is an even function (i.e. $G(x) = G(-x)$).
Note that for $x_n \in [L, 2L]$ we have that $2L-x_n \in [0, L]$ so we can reuse the values computed at the previous step.
\item We transform it:
\begin{equation}
\hat{G}^\text{int}_k = \text{DFT}_{2N}\left\{ G_{2LR}(x_n)\right\}
\end{equation}
\item We assume that we are given $\rho(x_n)$ in the interval $[0, L]$. From this we can obtain $\rho_{2LR}(x_n)$ over the interval $[0, 2L]$ simply extending the sequence with zeros (see Eq.\,\eqref{eq:zeros}).
\item We transform it:
\begin{equation}
\hat{\rho}_k = \text{DFT}_{2N}\left\{ \rho_{2LR}(x_n)\right\}
\end{equation}
\item We compute the potential in the transformed domain:
\begin{equation}
\hat{\phi}_k = \hat{G}^\text{int}_k \hat{\rho}_k \quad \text{for } k\in [0, 2N]
\end{equation}
\item We inverse-transform:
\begin{equation}
\phi_{2LR}(x_n)  = \text{DFT}_{2N}^{-1}\left\{\hat{\phi}_k\right\}
\end{equation}
which provides the physical potential in the range $[0, L]$:
\begin{equation}
\phi(x_n)  = \phi_{2LR}(x_n)  \quad \text{for } x_n\in [0, L]
\end{equation}
\end{enumerate}





\subsection{Extension to multiple dimensions}

The procedure described above can be extended to multiple dimensions by applying the same reasoning for all coordinates. 
This gives the following procedure:
\begin{enumerate}
\item We compute the Integrated Green function at the grid points in the volume $[0, L_x]\times[0, L_y]\times[0, L_z]$:
\begin{equation}
G_{2LR}^\text{int}(x_{n_x}, y_{n_y}, z_{n_z}) = 
\int_{x_{n_x}-\frac{h_x}{2}}^{x_{n_x}+\frac{h_x}{2}} dx
\int_{y_{n_y}-\frac{h_y}{2}}^{y_{n_y}+\frac{h_y}{2}} dy
\int_{z_{n_z}-\frac{h_z}{2}}^{z_{n_z}+\frac{h_z}{2}} dz\,
G(x,y,z)
\end{equation}
\item We extend to the region $[0, 2L_x]\times[0, 2L_y]\times[0, 2L_z]$ using the fact that:
\begin{multline}
G^\text{int}_{2LR}(x_n, y_n, z_n) = G^\text{int}_{2LR}(x_n-2L_x, y_n, z_n) =  G^\text{int}_{2LR}(2L_x-x_n, y_n, z_n)\\
\text{for } x_n \in [L_x, 2L_x], y_n \in [0, 2L_y], z_n \in [0, 2L_z]
\end{multline}
\begin{multline}
G^\text{int}_{2LR}(x_n, y_n, z_n) = G^\text{int}_{2LR}(x_n, y_n-2L_y, z_n) =  G^\text{int}_{2LR}(x_n, 2L_y-y_n,  z_n)\\
\text{for } y_n \in [L_y, 2L_y], x_n \in [0, 2L_x], z_n \in [0, 2L_z]
\end{multline}
\begin{multline}
G^\text{int}_{2LR}(x_n, y_n, z_n) = G^\text{int}_{2LR}(x_n, y_n, z_n-2L_z) =  G^\text{int}_{2LR}(x_n, y_n,  2L_z-z_n)\\
\text{for } z_n \in [L_z, 2L_z], x_n \in [0, 2L_x], y_n \in [0, 2L_y]
\end{multline}
This allows reusing the values computed at the previous step.
\item We transform it:
\begin{equation}
\hat{G}^\text{int}_{k_x k_y k_z} = 
\text{DFT}_{2N_x 2N_y 2N_z}\left\{ G_{2LR}(x_n, y_n, z_n)\right\}
\end{equation}
\item We assume that we are given $\rho(x_n, y_n, z_n)$ in the region $[0, L_x]\times[0, L_y]\times[0, L_z]$. From this we can obtain $\rho_{2LR}(x_n)$ over the region $[0, 2L_x]\times[0, 2L_y]\times[0, 2L_z]$ simply extending the matrix with zeros (see Eq.\,\eqref{eq:zeros}).
\item We transform it:
\begin{equation}
\hat{\rho}^\text{int}_{k_x k_y k_z} = 
\text{DFT}_{2N_x 2N_y 2N_z}\left\{ \rho_{2LR}(x_n, y_n, z_n)\right\}
\end{equation}
\item We compute the potential in the transformed domain:
\begin{equation}
\hat{\phi}_{k_x k_y k_z} = \hat{G}^\text{int}_{k_x k_y k_z} \, \hat{\rho}_{k_x k_y k_z} \quad \text{for } k_{x/y/z}\in [0, 2N_{x/y/z}]
\end{equation}
\item We inverse-transform:
\begin{equation}
\phi_{2LR}(x_n, y_n, z_n)  = \text{DFT}_{2N_x 2N_y 2N_z}^{-1}
\left\{\hat{\phi}_{k_x k_y k_z}\right\}
\end{equation}
which provides the physical potential in the region $[0, L_x]\times[0, L_y]\times[0, L_z]$:
\begin{multline}
\phi(x_n, y_n, z_n) = \phi_{2LR}(x_n, y_n, z_n)  
\text{ for } (x_n, y_n, z_n) \in [0, L_x]\times[0, L_y]\times[0, L_z]
\end{multline}
\end{enumerate}

 
\subsection{Green functions for 2D and 3D Poisson problems}

\subsubsection*{3D Poisson problem, free space boundary conditions}

For the equation:
\begin{equation}
\nabla^2 \phi(x,y,z) = -\frac{1}{\varepsilon_0} \rho(x,y,z)
\end{equation}
where:
\begin{equation}
\nabla = \left(\frac{\partial}{\partial x}, 
                      \frac{\partial}{\partial y},
                      \frac{\partial}{\partial z} \right)
\end{equation}
the solution can be written as 
\begin{equation}
\phi(x, y, z) = \iiint_{-\infty}^{+\infty} \rho(x', y', z')
   \,G(x-x', y-y', z-z')\,dx'\,dy'\,dz'
\end{equation}
where:
\begin{equation}
G(x, y, z) = \frac{1}{4\pi\varepsilon_0}\frac{1}{
\sqrt{x^2 +y^2 +z^2}
}
\end{equation}

The corresponding integrated Green function~\cite{QIANG2004278}. can be written as:
\begin{align}
G_{2LR}^\text{int}(x_{n_x}, y_{n_y}, z_{n_z}) =& 
\int_{x_{n_x}-\frac{h_x}{2}}^{x_{n_x}+\frac{h_x}{2}} dx
\int_{y_{n_y}-\frac{h_y}{2}}^{y_{n_y}+\frac{h_y}{2}} dy
\int_{z_{n_z}-\frac{h_z}{2}}^{x_{n_z}+\frac{h_z}{2}} dz\,
G(x,y,z)\\
= &+F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}, z_{n_x}+\frac{h_z}{2}\right) \\
    &- F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}, z_{n_x}-\frac{h_z}{2}\right)\\
    &- F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}, z_{n_x}+\frac{h_z}{2}\right)\\ 
    &+ F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}, z_{n_x}-\frac{h_z}{2}\right)\\
    &-F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}, z_{n_x}+\frac{h_z}{2}\right) \\
    &+ F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}, z_{n_x}-\frac{h_z}{2}\right)\\
    &+ F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}, z_{n_x}+\frac{h_z}{2}\right)\\ 
    & - F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}, z_{n_x}-\frac{h_z}{2}\right)
\end{align}
where $F(x,y,z)$ is a primitive of $G(x,y,z)$, which can be obtained as:
\begin{equation}
F(x,y,z) = 
\int_{x_0}^{x} dx
\int_{y_0}^{y} dy
\int_{z_0}^{x} dz\,
G(x,y,z)
\end{equation}
with $(x_0, y_0, z_0)$ being an arbitrary starting point.

An expression for $F(x,y,z)$ is the following
\begin{align}
F(x,y,z) =&\frac{1}{4\pi\varepsilon_0}\iiint \frac{1}{\sqrt{x^{2}+y^{2}+z^{2}}} d x d y d z\\ 
= \frac{1}{4\pi \varepsilon_0}&\left[-\frac{z^{2}}{2} \arctan \left(\frac{x y}{z \sqrt{x^{2}+y^{2}+z^{2}}}\right)\right.
-\frac{y^{2}}{2} \arctan \left(\frac{x z}{y \sqrt{x^{2}+y^{2}+z^{2}}}\right)\\
&-\frac{x^{2}}{2} \arctan \left(\frac{y z}{x \sqrt{x^{2}+y^{2}+z^{2}}}\right) 
+y z \ln \left(x+\sqrt{x^{2}+y^{2}+z^{2}}\right)\\
&\left. +x z \ln \left(y+\sqrt{x^{2}+y^{2}+z^{2}}\right)
+x y \ln \left(z+\sqrt{x^{2}+y^{2}+z^{2}}\right)\right]
\end{align}

Note that we need to choose the first cell center to be in (0,0,0) for evaluation of the integrated Green function. Therefore the cell edges have non zero coordinates and the denominators in the formula will always be non-vanishing.

\subsubsection*{2D Poisson problem, free space boundary conditions}

For the equation:
\begin{equation}
\nabla_\perp^2 \phi(x,y) = -\frac{1}{\varepsilon_0} \rho(x,y)
\end{equation}
where:
\begin{equation}
\nabla = \left(\frac{\partial}{\partial x}, 
                      \frac{\partial}{\partial y} \right)
\end{equation}
the solution can be written as 
\begin{equation}
\phi(x, y) = \iiint_{-\infty}^{+\infty} \rho(x', y')
   \,G(x-x', y-y')\,dx'\,dy'
\end{equation}
where:
\begin{equation}
G(x, y) = -\frac{1}{4\pi\varepsilon_0} \log\left( \frac{x^2 + y^2}{r_0^2}\right)
\end{equation}
where $r_0$ is arbitrary constant which has no effect on the evaluated fields (changes the potential by an additive constant). 

The corresponding integrated Green function can be written as:
\begin{align}
G_{2LR}^\text{int}(x_{n_x}, y_{n_y}) =& 
\int_{x_{n_x}-\frac{h_x}{2}}^{x_{n_x}+\frac{h_x}{2}} dx
\int_{y_{n_y}-\frac{h_y}{2}}^{y_{n_y}+\frac{h_y}{2}} dy\,
G(x,y,z)\\
= &+F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}\right)\\
    &-F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}\right)\\
    &-F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}\right)\\ 
    &+F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}\right)
\end{align}
where $F(x,y)$ is a primitive of $G(x,y)$, which can be obtained as:
\begin{equation}
F(x,y) = 
\int_{x_0}^{x} dx
\int_{y_0}^{y} dy\,
G(x,y)
\end{equation}
where $(x_0, y_0)$ is an arbitrary starting point.

An expression for $F(x,y)$ is the following (where we have chosen $r_0=1$):
\begin{align}
F(x,y) &=-\frac{1}{4\pi\varepsilon_0}\iint \ln \left(x^{2}+y^{2}\right) dx/,dy\\
&=\frac{1}{4\pi\varepsilon_0}\left[3 x y-x^{2} \arctan (y / x)-y^{2} \arctan (x / y)-x y \ln \left(x^{2}+y^{2}\right)\right]
\end{align}

Note that we need to choose the first cell center to be in (0,0) for evaluation of the integrated Green function. Therefore the cell edges have non zero coordinates and the denominators in the formula will always be non-vanishing.


\subsection{Generalization to observation interval different from source interval}
The potential generated by a source $\rho(x)$ can be written as the convolution of a Green function with the charge distribution:
\begin{equation}
\phi(x) = \int_{-\infty}^{+\infty} \rho(x')\,G(x-x') dx'
\label{eq:conv_gen}
\end{equation}

We assume that the source is limited to the region  $[a, b]$:
\begin{equation}
\rho(x) = \rho(x)\,\Pi_{[a,b]}\left(x\right)
\label{eq:rholim_gen}
\end{equation}
where $\Pi_{[a,b]}(x)$ is a rectangular window function defined as:
\begin{equation}
\Pi_{[a,b]}(x) = 
\begin{cases}
1\quad\text{for } x \in [a, b]\\
0\quad\text{elsewhere}
\end{cases}
\end{equation}

We are interested in the electric potential in a given region $[c, d]$, so we can compute:
\begin{equation}
\phi_{cd}(x) = \phi(x) \Pi_{[c, d]}\left(x\right)
\label{eq:philim_gen}
\end{equation}

We combine Eqs.\,\eqref{eq:rholim_gen}, \eqref{eq:philim_gen} and \eqref{eq:conv_gen}, obtaining:
\begin{equation}
\phi_{cd}(x) = \Pi_{[c,d]}\left( x\right)
\int_{-\infty}^{+\infty} 
\Pi_{[a,b]}\left(x'\right)
\rho(x')\,G(x-x') dx'
\end{equation}
We apply the change of variable $x'' = x - x'$:
\begin{equation}
\phi_{cd}(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[c,d]}\left({x}\right)
\Pi_{[a,b]}\left({x-x''}\right)
\rho(x-x'')\,G(x'') \,dx''
\label{eq:conv1_gen}
\end{equation}
The integrand vanishes outside the set of the $(x, x'')$ defined by the two window functions:
\begin{equation}
\begin{cases}
c < x <d\\
a < (x-x'') <b
\end{cases}
\end{equation}

We flip the signs in the second equation, obtaining:
\begin{equation}
\begin{cases}
c < x < d\\
-b < (x''-x) <-a
\end{cases}
\end{equation}

Combining the two equations we obtain:
\begin{equation}
c-b<-b + x < x'' <-a+x<d-a
\end{equation}
i.e. the integrand is not zero for $c-b< x'' <d-a$.
Therefore in Eq.\,\eqref{eq:conv1_gen} we can replace $G(x'')$ with its truncated version:
\begin{equation}
G_\text{tr}(x'') = G(x'')\,\Pi_{[c-b,~d-a]}
\left(
{x''}
\right)
\end{equation}

obtaining:
\begin{equation}
\phi_{cd}(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[c,d]}\left({x}\right)
\Pi_{[a,b]}\left({x-x''}\right)
\rho(x-x'')\,G_\text{tr}(x'') dx''
\label{eq:conv2_gen}
\end{equation}


We can go back to the initial coordinate by substituting $x'' = x-x'$:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\int_{-\infty}^{+\infty} 
\rho(x')\,G_\text{tr}(x-x') dx'
\end{equation}


We call:
\begin{align}
L_1 = b - a\\
L_2 = d - c 
\end{align}

The measure of the set on which $G_\text{tr}(x'')$ is non zero is 
%
\begin{equation}
(d-a) - (c - b) = L_1+ L_2
\end{equation}

We define $L$ such that:
\begin{equation}
L_1+ L_2 = 2L
\end{equation}

Since the two window functions in Eq.\,\ref{eq:conv2_gen} force the integrand to zero outside the region $c-b< x'' <d-a$ of measure $2L$, we can replace $G_\text{tr}(x'')$ with its replicated version:
\begin{equation}
G_{R}(x'') = \sum_{n=-\infty}^{+\infty}G_\text{tr}(x''-2nL) = \sum_{n=-\infty}^{+\infty}G(x'' -2nL)\,\Pi_{[c-b,~d-a]}
\left(
{x''-2nL}
\right)
\label{eq:GLR_gen}
\end{equation}
obtaining:
\begin{equation}
\phi_{cd}(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[c,d]}\left({x}\right)
\Pi_{[a,b]}\left({x-x''}\right)
\rho(x-x'')\,G_{R}(x'') dx''
\end{equation}

We can go back to the initial coordinate by substituting $x'' = x-x'$:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\int_{-\infty}^{+\infty} 
\rho(x')\,G_{R}(x-x') dx'
\end{equation}

This is a cyclic convolution, so we can proceed as follows. We split the integral:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\sum_{n=-\infty}^{+\infty}
\int_{2nL}^{2(n+1)L} 
\rho(x')\,G_{R}(x-x') \,dx'
\label{eq:conv3_gen}
\end{equation}
In each term we replace $x''' = x'+2nL$:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\sum_{n=-\infty}^{+\infty}
\int_{0 }^{2L} 
\rho(x'''-2nL)\,G_{R}(x-x'''-2nL) \,dx'''
\label{eq:conv4_gen}
\end{equation}
We use the fact that $G_{R}(x)$ is periodic:
\begin{equation}
\begin{split}
\phi_{cd}(x) &= 
\Pi_{[c,d]}\left({x}\right)
\sum_{n=-\infty}^{+\infty}
\int_{0 }^{2L} 
\rho(x'''-2nL)\,G_{R}(x-x''') dx'''\\
\\&=
\Pi_{[c,d]}\left({x}\right)
\int_{0 }^{2L}  
G_{R}(x-x''')
\sum_{n=-\infty}^{+\infty}
\rho(x'''-2nL) 
\, dx'''
\end{split}
\label{eq:conv5_gen}
\end{equation}

We can define a replicated version of $\rho(x)$:
\begin{equation}
\rho_{R}(x)= \sum_{n=-\infty}^{+\infty}
\rho(x-2nL)
\end{equation}

%noting that this implies:
%\begin{equation}
%\rho_{2LR}(x)= 0 \quad \text{for } x \in [L, 2L]
%\label{eq:zeros}
%\end{equation}

We obtain:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\int_{0 }^{2L} 
\rho_{R}(x')\,G_{R}(x-x') dx'
\label{eq:conv6_gen}
\end{equation}

The function:
\begin{equation}
\phi_{R}(x) = 
\int_{0 }^{2L} 
\rho_{R}(x')\,G_{R}(x-x') dx'
\label{eq:confin_gen}
\end{equation}
is periodic of period $2L$. Replacing in Eq.~\ref{eq:conv6_gen} we see that the potential of interest can be simply calculated by selecting the right interval $[c, d]$:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\phi_{R}(x)
\label{eq:sel_gen}
\end{equation}

To compute the convolution in Eq.\,\ref{eq:confin_gen} we expand $\phi_{R}(x)$ in a Fourier series starting from $x=c$:
\begin{equation}
\phi_{R}(x) = \sum_{k=-\infty}^{+\infty} \tilde{\phi}_k\, e^{j2\pi k \frac{x}{2L}}
\label{eq:phifour_gen}
\end{equation}
where the Fourier coefficients are given by:
\begin{equation}
\tilde{\phi}_k = \frac{1}{2L}\int_0^{2L} \phi_{R}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx
\label{eq:phik_gen}
\end{equation}

We replace Eq.\,\eqref{eq:confin_gen} into Eq.\,\eqref{eq:phik_gen} obtaining:
\begin{equation}
\tilde{\phi}_k = \frac{1}{2L}\int_0^{2L} \int_{0 }^{2L} 
\rho_{R}(x')\,G_{R}(x-x') \, e^{-j2\pi k \frac{x}{2L}} \,  dx'\, dx
\end{equation}

With the change of variable $x'' = x-x'$ we obtain:
\begin{equation}
\tilde{\phi}_k = 
\frac{1}{2L}
\int_0^{2L} 
\rho_{R}(x') e^{-j2\pi k \frac{x'}{2L}}dx'\,
\int_{0 }^{2L} 
\,G_{R}(x'') e^{-j2\pi k \frac{x''}{2L}}\,  \,  dx''
\end{equation}

where we recognize the Fourier coefficients of $\rho_{R}(x)$ and $\,G_{R}(x)$:
\begin{align}
\tilde{\rho}_k = \frac{1}{2L}\int_0^{2L} \rho_{R}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx \label{eq:rhok_gen}\\
\tilde{G}_k = \frac{1}{2L}\int_0^{2L} G_{R}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx \label{eq:Gk_gen}
\end{align}
obtaining simply:
\begin{equation}
\tilde{\phi}_k = 2L \, \tilde{G}_k \, \tilde{\rho}_k
\label{eq:freqconv_gen}
\end{equation}

We assume to have the functions $\rho_{R}(x)$ and  $G_{R}(x)$ sampled (or averaged) with step:
\begin{equation}
h_x = \frac{2L}{M}
\end{equation}

We assume that all intervals have size multiple of $h_x$. So we can define:
\begin{align}
N_1 &= L_1 / h_x\\
N_2 &= L_2 / h_x
\end{align}

We call:
\begin{align}
 \rho_{Rn} &= \rho_{R}\left(a + nh_x\right)\\
 \phi_{Rn} &= \phi_{R}\left(c + nh_x\right)\\
 G_{Rn} &= G_{R}\left(c - b + nh_x\right)
\end{align}

By construction in the range $0 \leq n <M$:
\begin{equation}
 \rho_{Rn} \equiv \rho_n = 
 \begin{cases}
\rho\left(a + nh_x\right)&\text{for}~0 \leq n <N_1 \\
 0 & \text{for}~N_1 \leq n < M
 \end{cases}
\end{equation}

\begin{equation}
G_{Rn} \equiv  G_n = G\left(c - b + nh_x\right)
\text{ for}~0 \leq n <M
\end{equation}

We can approximate the integral as follows:
\begin{align}
\tilde{\rho}_k &= \frac{1}{2L}\int_0^{2L} \rho_{R}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx = \frac{1}{2L}\int_a^{a+2L} \rho_{R}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx\\
&\simeq 
\frac{h_x}{2L}\sum_{n=0}^{M-1} \rho_{R}(a+nh_x)\, e^{-j2\pi k \frac{a+nh_x}{2L}} 
=
e^{-j2\pi k \frac{a}{2L}} \frac{1}{M}
\sum_{n=0}^{M-1}
 \rho_{Rn} e^{-j2\pi \frac{kn}{M}} 
\end{align}

We recognize the Discrete Fourier Transform:
\begin{equation}
\tilde{\rho}_k 
=
e^{-j2\pi k \frac{a}{2L}} \frac{1}{M}
\text{DFT}_M\left\{ \rho_{Rn}\right\}
=
e^{-j2\pi k \frac{a}{2L}} \frac{1}{M}
\hat{\rho}_k 
\end{equation}
and similarly we can obtain
\begin{equation}
\tilde{\phi}_k 
=
e^{-j2\pi k \frac{c}{2L}} \frac{1}{M}
\text{DFT}_M\left\{ \phi_{Rn}\right\}
=
e^{-j2\pi k \frac{c}{2L}} \frac{1}{M}
\hat{\phi}_k 
\end{equation}

\begin{equation}
\tilde{G}_k 
=
e^{-j2\pi k \frac{c-b}{2L}} \frac{1}{M}
\text{DFT}_M\left\{ G_{Rn}\right\}
=
e^{-j2\pi k \frac{c-b}{2L}} \frac{1}{M}
\hat{G}_k 
\end{equation}


Replacing in Eq. \ref{eq:freqconv_gen} we obtain

\begin{equation}
\hat{\phi}_k  = 
h_x e^{j2\pi k \frac{b-a}{2L}} 
\hat{\rho}_k \hat{G}_k
=
h_x e^{j2\pi k \frac{N_1}{M}} 
\hat{\rho}_k \hat{G}_k
\end{equation}


\subsection{Compressed FFT convolution}

We assume that the source has the form
\begin{equation}
\rho(x) =  \sum_{j=A}^{B-1} \rho^\text{loc}_j(x - jP)
\label{eq:rholim_period}
\end{equation}
where $\rho^\text{loc}_j(x)$ is limited to the interval $[a, b]$.

We are interested in the potential in a set of intervals given by:
\begin{equation}
[c+iP,~d+iP]~~\text{ for } i=C, ... , D-1
\end{equation}
%so we define:
%\begin{equation}
%\phi_i(x) =  \phi(x+iP)\Pi_{[c,d]}(x)
%\label{eq:rholim_period}
%\end{equation}

The contribution of the j-th term of $\rho$ to  $\phi$ int the i-th interval:

\begin{equation}
\phi_{ij}(x) = 
\int_{-\infty}^{+\infty} 
\rho^\text{loc}_j(x' - jP)\,G^\text{tr}_{i-j}(x-x') dx'
\end{equation}

where:
\begin{equation}
G^\text{tr}_l(x'') = G(x'')\,
\Pi_{[c-b+lP,~d-a+lP]}
\left(
{x''}
\right)
\end{equation}

We define a local version of $G^\text{tr}$ as

\begin{equation}
G^\text{tr, loc}_l(x) = G^\text{tr}_l(x + lP) 
=
G(x +lP)\,
\Pi_{[c-b,~d-a]}
\left(x\right)
\end{equation}

obtaining:
\begin{equation}
\phi_{ij}(x) = 
\int_{-\infty}^{+\infty} 
\rho^\text{loc}_j(x' - jP)\,G^\text{tr, loc}_{i-j}(x-x'-(i-j)P) dx'
\end{equation}

We replace $x' = x' - jP$:
\begin{equation}
\phi_{ij}(x) = 
\int_{-\infty}^{+\infty} 
\rho^\text{loc}_j(x')\,G^\text{tr, loc}_{i-j}(x-x' - iP) dx'
\end{equation}

We define a local version of $\phi$:
\begin{equation}
\phi_{ij}^\text{loc}(x) = \phi_{ij}(x+iP)
\end{equation}

obtaining:
\begin{equation}
\phi_{ij}^\text{loc}(x) = \int_{-\infty}^{+\infty} 
\rho^\text{loc}_j(x')\,G^\text{tr, loc}_{i-j}(x-x') dx'
\end{equation}

I explicit all the pies:
\begin{equation}
\phi_{ij}^\text{loc}(x) = \int_{-\infty}^{+\infty}
\Pi_{[a,b]}(x')
\Pi_{[c-b,~d-a]}(x-x')
\rho^\text{loc}_j(x')\,G^\text{tr, loc}_{i-j}(x-x') dx'
\end{equation}

Again, we want to find the region in $x$ where this is non-zero:

\begin{align}
&a<x'<b\\
&c-b< x-x'<d-a
\end{align}

from which:
\begin{align}
&c-b+x'< x<d-a+x'\\
&c-b+a< x<d-a+b
\end{align}

So we find that $\phi_{ij}^\text{loc}(x)$ is non-zero in the region:
\begin{align}
&c-L_1< x<d+L_1
\label{eq:support}
\end{align}


The total potential in the i-th interval of interest:
\begin{equation}
\phi_{i}^\text{loc}(x)
=\sum_{j=A}^{B-1} \phi_{ij}^\text{loc}(x) = \sum_{j=A}^{B-1}\int_{-\infty}^{+\infty}
\rho^\text{loc}_j(x')\,G^\text{tr, loc}_{i-j}(x-x') dx'
\label{eq:phi_i_loc}
\end{equation}

Since all terms in the sum are zero outside the region defined by Eq.\,\ref{eq:support} also $\phi_{i}^\text{loc}(x)$ is zero outside the same interval, which is larger by $2L_1$ compared to the set of interest $[c, d]$.

We build:

\begin{equation}
G^\text{aux} (x)= \sum_{l=C-B+1}^{D-A-1}
G^\text{tr, loc}_{l}(x-l L_\text{aux})
\label{eq:def_gaux}
\end{equation}
where:
\begin{equation}
L_\text{aux} = L_1 + L_2
\end{equation}

and 
\begin{equation}
\rho^\text{aux}(x)= 
\sum_{j=A}^{B-1} \rho_{j}^\text{loc}(x - jL_\text{aux})
\label{eq:def_rhoaux}
\end{equation}

and we define 
\begin{equation}
\phi^\text{aux}(x)= 
\int_{-\infty}^{+\infty}
\rho^\text{aux}(x')\,G^\text{aux}(x-x') dx'
\label{eq:def_phiaux}
\end{equation}

We extract a segment of it:


\begin{equation}
\phi^\text{aux, loc}_i(x)= 
\phi^\text{aux}(x + iL_\text{aux}) 
\Pi_{[c, d]}(x)
\label{eq:def_phiauxloc}
\end{equation}

We replace Eq.~\ref{eq:def_gaux}:

\begin{equation}
\phi^\text{aux, loc}_i(x)= 
\Pi_{[c, d]}(x)
\int_{-\infty}^{+\infty}
\rho^\text{aux}(x')\,G^\text{aux}(x-x'+iL_\text{aux}) dx'
\end{equation}

We replace Eq.~\ref{eq:def_rhoaux} and Eq.~\ref{eq:def_gaux}:
\begin{align}
\phi^\text{aux, loc}_i(x)&= 
\Pi_{[c, d]}(x)
\int_{-\infty}^{+\infty}
\sum_{j=A}^{B-1} \rho_{j}^\text{loc}(x' - jL_\text{aux})\,
\sum_{l=C-B+1}^{D-A-1}
G^\text{tr, loc}_{l}(x-x'+(i-l)L_\text{aux})
dx'\\
&=
\Pi_{[c, d]}(x)
\sum_{l=C-B+1}^{D-A-1} \sum_{j=A}^{B-1} \int_{-\infty}^{+\infty}\rho_{j}^\text{loc}(x' - jL_\text{aux})\,
G^\text{tr, loc}_{l}(x-x'+(i-l)L_\text{aux})
dx'
\end{align}

We change variable $x''= x' - (i-l)L_\text{aux}$
\begin{align}
\phi^\text{aux, loc}_i(x)
&=
\sum_{l=C-B+1}^{D-A-1} \sum_{j=A}^{B-1} \int_{-\infty}^{+\infty}
\Pi_{[c, d]}(x)
\rho_{j}^\text{loc}(x'' + (i-l -j)L_\text{aux})\,
G^\text{tr, loc}_{l}(x-x'')
dx''
\end{align}

The integrand is nonzero for:
\begin{align}
& c < x <d\\
& a < x'' +(i-l-j)L_\text{aux}) < b\\
& c-b < x-x''< d-a
\end{align}

I subtract the first and the last:
\begin{align}
& a < x'' +(i-l-j)L_\text{aux}) < b\\
& -b < -x''< -a
\end{align}

I flip the last
\begin{align}
& a < x'' +(i-l-j)L_\text{aux}) < b\\
& a < x''< b
\end{align}

The two are compatible only if
\begin{align}
l=i-j
\label{eq:nonzeroterms}
\end{align}

This means that in the double sum only the terms satisfying Eq.\,\ref{eq:nonzeroterms} are nonzero, hence:
\begin{align}
\phi^\text{aux, loc}_i(x)
&=
\Pi_{[c, d]}(x)
\sum_{j=A}^{B-1} \int_{-\infty}^{+\infty}
\rho_{j}^\text{loc}(x'' + )\,
G^\text{tr, loc}_{i-j}(x-x'')
dx''
\end{align}

Comparing against Eq.\,\ref{eq:phi_i_loc}
we find:
\begin{align}
\Pi_{[c, d]}(x)\phi^\text{aux, loc}_i(x)
&=
\Pi_{[c, d]}(x)
\phi^\text{loc}_i(x)
\end{align}

Using Eq.\,\ref{eq:def_phiauxloc} we obtain:
\begin{align}
\Pi_{[c, d]}(x)
\phi^\text{loc}_i(x)
=
\Pi_{[c, d]}(x)\phi^\text{aux}(x + iL_\text{aux}) 
\end{align}

To compute the convolution in Eq.\,\ref{eq:def_phiaux} we can use the results from the previous section.

We call:
\begin{align}
&N_S = B-A\\
&N_T = D-C\\
\end{align}

The support of $\rho^\text{aux}(x)$ is:
\begin{equation}
[a +AL_\text{aux}, a + B L_\text{aux}]
\text{  having size  } N_S  L_\text{aux}
\end{equation}
The support of $G^\text{aux}(x)$ is:
\begin{equation}
[c-b +(C-B+1)L_\text{aux}, c-b + (D-A) L_\text{aux}]
\text{  having size  } \left(N_S + N_T -1\right) L_\text{aux}
\end{equation}

Using a sampling step $h_x$, we can define:
\begin{align}
N_1 &= L_1 / h_x\\
N_2 &= L_2 / h_x\\
N_\text{aux} &= L_\text{aux} / h_x = N_1+N_2
\end{align}
The number of samples in the support of $G^\text{aux}(x)$ is
\begin{align}
M_\text{aux} &= (N_S+N_T-1)N_\text{aux} 
\end{align}



We define
\begin{equation}
G^\text{aux}_m = G^\text{aux}\left(c-b +(C-B+1)L_\text{aux} + mh_x\right) 
\text{ for}~0 \leq m <M_\text{aux}
\end{equation}

Replacing Eq.\,\ref{eq:def_gaux}: 
\begin{eqnarray}
G^\text{aux}_m 
&=&
\sum_{l=C-B+1}^{D-A-1}
G^\text{tr, loc}_{l}(c-b +(C-B+1)L_\text{aux} + mh_x -l L_\text{aux})\\
&=&
\sum_{l=C-B+1}^{D-A-1}
G(c-b  +(C-B+1)L_\text{aux} +lP + h_x (m  -l N_\text{aux}) ) \times\\
&&
\Pi_{[c-b,~d-a]}(c-b +(C-B+1)L_\text{aux} + h_x(m -l N_\text{aux}))
\end{eqnarray}

We define:
\begin{multline}
G^\text{segm}_{l,n} =  G(c-b  +(C-B+1)L_\text{aux} +lP + n h_x ) 
\Pi_{[c-b,~d-a]}(c-b +(C-B+1)L_\text{aux} + n h_x)\\
\text{ for}~0 \leq n <N_\text{aux}
~\text{ and}~(C-B+1) \leq l < (D-A)
\end{multline}

So we can write:
\begin{equation}
G^\text{aux}_m = \sum_{l=C-B+1}^{D-A-1}
G^\text{segm}_{l,m-lN_\text{aux}}
\end{equation}
We define:
\begin{equation}
\rho^\text{aux}_m = 
 \begin{cases}
\rho^\text{aux}\left(a +AL_\text{aux} + mh_x\right) 
&\text{ for}~0 \leq m <N_S N_\text{aux}\\
 0 & \text{for}~N_S N_\text{aux} \leq m < M_\text{aux}
\end{cases}
\end{equation}

We can use the result from before linking the DFTs of these sequences:
\begin{equation}
\hat{\phi}^\text{aux}_k  = 
h_x 
e^{j2\pi k \frac{(B-A-1)L_\text{aux} + (b-a)}{(N_S + N_T-1)L_\text{aux}}}
=
h_x 
e^{j2\pi k \frac{(N_S-1)N_\text{aux} + N_1}{(N_S + N_T -1)N_\text{aux}}}
\hat{\rho}^\text{aux}_k \hat{G}^\text{aux}_k
\end{equation}

The inverse DFT of $\hat{\phi}^\text{aux}_k$ provides:
\begin{equation}
\phi^\text{aux}_m = 
\phi^\text{aux}\left(c +CL_\text{aux} + mh_x\right) 
\text{~~ for}~0 \leq m <N_T N_\text{aux}\\
\end{equation}

\section{Wakefields}
We treat separately transverse and longitudinal wakefields.
\subsection{Transverse Wakefields}
The wakefield function is typically expanded in a Taylor series with respect
to the position of the test and source particles:

\begin{align*}
    W_x(z, x_s, y_s, x_t, y_t) =& W^{const}_x(z) + W_x^{dip}(z) x_s + W_x^{quad}(z) x_t +\\
    &W_{xy}^{dip}(z) y_s + W_{xy}^{quad}(z) y_t + h.o.t. \\
    W_y(z, x_s, y_s, x_t, y_t) =& W^{const}_y(z) + W_y^{dip}(z) y_s + W_y^{quad}(z) y_t +\\
    &W_{yx}^{dip}(z) x_s + W_{yx}^{quad}(z) x_t + h.o.t.
\end{align*}

The kick of each of these terms induced on a particle at position $z$ is computed differently:

\begin{itemize}
    \item For the constant wakes:
        \begin{align*}
            \Delta p_x(z) &= -\frac{q^2 e^2}{p_0c}\int_{-\infty}^\infty  \lambda(z')W^{const}_x(z - z') dz',\\
            \Delta p_y(z) &= -\frac{q^2 e^2}{p_0c}\int_{-\infty}^\infty  \lambda(z')W^{const}_y(z - z') dz',\\
        \end{align*}
    \item For the dipolar components:
        \begin{align*}
            \Delta p_x(z) =& -\frac{q^2 e^2}{p_0c}\int_{-\infty}^\infty
                \bar{x}(z')\lambda(z')W^{dip}_{x}(z-z') \, dz' +\\
             & -\frac{q^2 e^2}{p_0c}\int_{-\infty}^\infty 
                \bar{y}(z')\lambda(z')W^{dip}_{xy}(z-z') \, dz',\\
            \Delta p_y(z) =& -\frac{q^2 e^2}{p_0c}\int_{-\infty}^\infty 
                \bar{y}(z')\lambda(z')W^{dip}_{y}(z-z') \, dz' +\\
            & -\frac{q^2 e^2}{p_0c}\int_{-\infty}^\infty 
                \bar{x}(z')\lambda(z')W^{dip}_{yx}(z-z') \, dz',
        \end{align*}
    \item For the quadrupolar components:
        \begin{align*}
            \Delta p_x(z) =& -\frac{q^2 e^2}{p_0c}x(z)\int_{-\infty}^\infty 
                \lambda(z')W^{quad}_{x}(z-z') \, dz'+\\
            & -\frac{q^2 e^2}{p_0c}y(z)\int_{-\infty}^\infty 
                \lambda(z')W^{quad}_{xy}(z-z') \, dz',\\
            \Delta p_y(z) =& -\frac{q^2 e^2}{p_0c}y(z)\int_{-\infty}^\infty 
                \lambda(z')W^{quad}_{y}(z-z') \, dz'+\\
            & -\frac{q^2 e^2}{p_0c}x(z)\int_{-\infty}^\infty 
                \lambda(z')W^{quad}_{yx}(z-z') \, dz',
        \end{align*}
\end{itemize}
where $q$ is the particle charge in number of elementary charges, $e$ is the elementary charge in Coulomb, $\bar{x}(z)$ and $\bar{y}(z)$ 
the average beam offsets, $\lambda(z)$ is the longitudinal beam density $dN/dz$ in number of particles per meter.
\newline
The previous integrals can be approximated using the method of Section \ref*{sec:fftconv1d}, where the 
Green function is replaced by the wakefield function and the source density is replaced by the beam density possibly multiplied by the average beam position.
\newline
\newline
In general, including an arbitrary number of terms in the wakefield expansion, the wakefield functions can be written as:
\begin{align*}
    W_x(z, x_s, y_s, x_t, y_t) &= \sum_{i} \sum_{j} W^{i,j}_{x}(z) x_s^i x_t^j + \sum_{i} \sum_{j} W^{i,j}_{xy}(z) y_s^i y_t^j,\\
    W_y(z, x_s, y_s, x_t, y_t) &= \sum_{i} \sum_{j} W^{i,j}_{y}(z) y_s^i y_t^j + \sum_{i} \sum_{j} W^{i,j}_{yx}(z) x_s^i x_t^j,
\end{align*}

and the corresponding kicks are computed as

\begin{align*}
    \Delta p_x(z) =& -\frac{q^2 e^2}{p_0c} \sum_{i} \sum_{j}  x(z)^j \int_{-\infty}^\infty 
        \bar{x}(z')^i\lambda(z')W^{i,j}_{x}(z - z') \, dz'+\\
     & -\frac{q^2 e^2}{p_0c}\sum_{i} \sum_{j} y(z)^j \int_{-\infty}^\infty 
        \bar{y}(z')^i \lambda(z')W^{i,j}_{xy}(z- z') \, dz',\\
    \Delta p_y(z) =& -\frac{q^2 e^2}{p_0c}\sum_{i} \sum_{j} y(z)^j \int_{-\infty}^\infty 
        \bar{y}(z')^i \lambda(z')W^{i,j}_{y}(z- z') \, dz'+\\
     & -\frac{q^2 e^2}{p_0c}\sum_{i} \sum_{j} x(z)^j \int_{-\infty}^\infty 
        \bar{x}(z')^i \lambda(z') W^{i,j}_{yx}(z- z') \, dz',
\end{align*}

%\subsection{Longitudinal Wakefields}

%Discretization:
%\begin{equation}
%\Delta p_x(z_i) = -\frac{q^2 e^2}{p_0c}
%    \sum_j
%    \bar{x}(z_j)\lambda(z_j)W^D_{x}(z_i-z_j) \, \Delta z
%\end{equation}
%where:
%\begin{equation}
%z_i = z_a + i\Delta z
%\end{equation}
%\begin{equation}
%z_j = z_b + j\Delta z
%\end{equation}
%
%We replace in the wake term:
%
%
%\begin{equation}
% W^D_{x}(z_i-z_j)  = 
%  W^D_{x}(z_a + i\Delta z-z_b - j\Delta z)
% = W^D_{x}(z_a -z_b + (i - j) \Delta z)
%\end{equation}
%
%We define
%\begin{equation}
%W_{l} = W^D_{x}(z_a -z_b + l \Delta z) 
%\end{equation}
